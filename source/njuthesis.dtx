% \iffalse meta-comment
% !TeX program  = XeLaTeX
% !TeX encoding = UTF-8
%
% Copyright (C) 2021 - 2024
% by Nanjing University Linux User Group
% <git+nju-lug-email-3104-issue-@yaoge123.cn>
%
% It may be distributed and/or modified under the conditions of the
% LaTeX Project Public License (LPPL), either version 1.3c of this
% license or (at your option) any later version. The latest version
% of this license is in the file
%
%    https://www.latex-project.org/lppl.txt
%
% This work has the LPPL maintenance status `maintained'.
%
% The Current Maintainer of this work is Yu Xiong.
%
% This work consists of the files njuthesis.dtx,
%           and the derived files njuthesis.ins,
%                                 njuthesis.cls,
%                                 njuthesis-doc.cls,
%                                 njuthesis-graduate.def,
%                                 njuthesis-postdoctoral.def,
%                                 njuthesis-undergraduate.def,
%                                 njuthesis.pdf,
%                             and README.md.
%
% -----------------------------------------------------------------------
%
% The development version of the template can be found at
%
%    https://github.com/nju-lug/NJUThesis
%
% for those people who are interested.
%
%<*internal>
\begingroup
  \def\NameOfLaTeXe{LaTeX2e}
\expandafter\endgroup\ifx\NameOfLaTeXe\fmtname\else
\csname fi\endcsname
%</internal>
%
%<*install>
\input docstrip.tex
\keepsilent
\askforoverwritefalse

\preamble

Copyright (C) 2021 - 2024
by Nanjing University Linux User Group
<git+nju-lug-email-3104-issue-@yaoge123.cn>

This file may be distributed and/or modified under the conditions of
the LaTeX Project Public License, either version 1.3c of this license
or (at your option) any later version.  The latest version of this
license is in:

  http://www.latex-project.org/lppl.txt

and version 1.3 or later is part of all distributions of LaTeX version
2005/12/01 or later.

To produce the documentation run the original source files ending with
`.dtx' through XeTeX.

\endpreamble

\generate{
  \usedir{tex/latex/njuthesis}
    \file{\jobname.cls}               {\from{\jobname.dtx}{class}}
    \file{\jobname-undergraduate.def} {\from{\jobname.dtx}{def-u}}
    \file{\jobname-graduate.def}      {\from{\jobname.dtx}{def-g}}
    \file{\jobname-postdoctoral.def}  {\from{\jobname.dtx}{def-p}}
    \file{\jobname-doc.cls}           {\from{\jobname.dtx}{doc-cls}}
%<*internal>
  \usedir{source/latex/njuthesis}
    \file{\jobname.ins}               {\from{\jobname.dtx}{install}}
%</internal>
}

\obeyspaces
\Msg{*************************************************************}
\Msg{*                                                           *}
\Msg{* To finish the installation you have to move the following *}
\Msg{* files into a directory searched by TeX:                   *}
\Msg{*                                                           *}
\Msg{* The recommended directory is TDS:tex/latex/njuthesis      *}
\Msg{*                                                           *}
\Msg{*     njuthesis.cls                                         *}
\Msg{*     njuthesis-doc.cls                                     *}
\Msg{*     njuthesis-graduate.def                                *}
\Msg{*     njuthesis-postdoctoral.def                            *}
\Msg{*     njuthesis-undergraduate.def                           *}
\Msg{*     njuthesis.ins                                         *}
\Msg{*                                                           *}
\Msg{* To produce the documentation, run the file njuthesis.dtx  *}
\Msg{* through XeLaTeX.                                          *}
\Msg{*                                                           *}
\Msg{* Happy TeXing!                                             *}
\Msg{*                                                           *}
\Msg{*************************************************************}

\endbatchfile
%</install>
%
%<*internal>
\fi
%</internal>
%
%<class>\NeedsTeXFormat{LaTeX2e}
%<*!(driver|install)>
%<+!driver>\GetIdInfo $Id: njuthesis.dtx 1.3.3 2024-03-06 21:00:00
%<+!driver>  +0800 NJU LUG <git+nju-lug-email-3104-issue-@yaoge123.cn>$
%<class>  {Thesis template for Nanjing University}
%<class>\ProvidesExplClass{njuthesis}
%<def-u>  {Undergraduate definition file for njuthesis}
%<def-u>\ProvidesExplFile{njuthesis-undergraduate.def}
%<def-g>  {Graduate definition file for njuthesis}
%<def-g>\ProvidesExplFile{njuthesis-graduate.def}
% ^^A 诚耀百廿，雄创一流
% ^^A 南京大学一百二十周年华诞邀您共襄盛举！
%<def-p>  {Postdoctoral definition file for njuthesis}
%<def-p>\ProvidesExplFile{njuthesis-postdoctoral.def}
%<doc-cls>  {Documentation style for njuthesis}
%<doc-cls>\ProvidesExplFile{njuthesis-doc.cls}
%<!driver>  {\ExplFileDate}{\ExplFileVersion}{\ExplFileDescription}
%</!(driver|install)>
%
%<*driver>
\ProvidesFile{njuthesis.dtx}
\PassOptionsToClass{codehigh}{njuthesis-doc}
\documentclass{njuthesis-doc}
\begin{document}
  \DocInput{njuthesis.dtx}
  \PrintChanges
  \PrintIndex
\end{document}
%</driver>
% \fi
%
% \title{\color{njuviolet}{The \cls{njuthesis} class\\
%   \textbf{南京大学学位论文模板}}}
%
% \author{南京大学 Linux 用户组
%   \thanks{E-mail: \href{mailto:git+nju-lug-email-3104-issue-@yaoge123.cn}
%     {git+nju-lug-email-3104-issue-@yaoge123.cn}}}
%
% \date{v1.3.3 \quad 2024-03-06}
%
% \changes{v0.1}{2021/09/04}{开始开发。}
% \changes{v0.2}{2021/09/07}{初步搭建了可用的模板。}
% \changes{v0.3}{2021/09/09}{使用自动构建工具进行测试。}
% \changes{v0.4}{2021/09/09}{将个人信息使用内置命令输入。}
% \changes{v0.5}{2021/09/10}{新增了对第二导师的支持。}
% \changes{v0.6}{2021/09/10}{封装个人信息}
% \changes{v0.6}{2021/09/10}{实现自动打包发布。}
% \changes{v0.7}{2021/09/11}{增加对研究生模板的支持}
% \changes{v0.7}{2021/09/12}{将 \cls{njuthesis} 发布在 CTAN。}
% \changes{v0.8}{2021/09/12}{修复已知问题，进行公开宣传。}
% \changes{v0.9}{2021/09/15}{使用 DocStrip 合并模板文件。}
% \changes{v0.9}{2021/09/15}{大幅度修改宏名称以符合 \LaTeX3 规范。}
% \changes{v0.9}{2021/09/15}{进一步完善文档。}
% \changes{v0.10}{2021/09/24}{删除了生成自述文件的代码。}
% \changes{v0.12}{2021/11/28}{删除内置的 \pkg{njuvisual} 代码。}
% \changes{v0.12}{2021/11/29}{更新了说明文档封面设计。}
% \changes{v0.12}{2021/11/30}{区分测试文件和空白模板。}
% \changes{v0.12}{2021/12/06}{修改了说明文档的代码呈现样式。}
% \changes{v0.13}{2021/12/12}{优化了编译速度。}
% \changes{v0.13}{2021/12/15}{适配2022届本科生毕业毕业论文（设计）规范。}
% \changes{v0.13}{2021/12/16}{默认不加载 \pkg{listings} 宏包。}
% \changes{v0.14}{2022/01/13}{将本模板内嵌入南大 \TeX{} 网站。}
% \changes{v0.16}{2022/03/01}{分离本科生和研究生模板配置。}
% \changes{v0.19}{2022/05/23}{对研究生普通封面进行若干细节修改。}
% \changes{v0.19}{2022/05/23}{对国家图书馆封面进行若干细节修改。}
% \changes{v0.20}{2022/06/08}{更正本科生模板部分字样。}
% \changes{v1.0}{2022/06/29}{移除毕业设计封面。}
% \changes{v1.0}{2022/07/05}{按类型重命名变量。}
% \changes{v1.0}{2022/07/23}{新增博士后出站报告模板。}
% \changes{v1.0}{2022/07/28}{在手册中以不同颜色指示不同模块。}
% \changes{v1.0}{2022/08/02}{删除 \LaTeX 基础用法的说明。}
% \changes{v1.1}{2023/01/05}{适配2023届本科生毕业毕业论文（设计）规范。}
% \changes{v1.1}{2023/01/05}{适配新版南大 \LaTeX 在线编辑器。}
%
% \maketitle
%
% \let\abstractname\relax
% \begin{abstract}
% \cls{njuthesis} 是制作南京大学本科生毕业论文、研究生学位论文、博士后出站报告的
% \LaTeX 文档类。本模板基于本科生院的论文撰写规范制作，同时参考研究生院提供的硕士、
% 博士学位材料包，用于生成符合南京大学排版要求和相应的国家标准的学位论
% 文，力求通过 \LaTeX3 语法实现清晰的实现逻辑、较高的可定制性以及友好的用户接口。
% \end{abstract}
%
% \begin{abstract}
% The \cls{njuthesis} class is intended for typesetting Nanjing University
% dissertations with \LaTeX, providing support for bachelor, master,
% doctoral theses as well as postdoctoral reports.
% \end{abstract}
%
% \vspace{2cm}
% \def\abstractname{特别声明}
% \begin{abstract}
% 在使用本模板时，我们默认您同意以下内容：
% \begin{enumerate}
%   \item 本模板通过 LPPL 1.3c 协议开放源代码，您可以随意使用编译出的 PDF 文件。
%   \item 本模板与学校官方部门并不存在合作关系，
%         作者不对使用本模板产生的格式审查问题负责。
%   \item 遇到本文档没有覆盖的问题属于正常情况，欢迎提交反馈意见。
% \end{enumerate}
%
% 我们的 \href{https://git.nju.edu.cn/nju-lug/lug-introduction}
%   {Linux 用户组}始终欢迎您的加入！
% \end{abstract}
%
% \clearpage
%
%
% \setcounter{tocdepth}{4}
% \tableofcontents
%
% \clearpage
%
%
% \begin{documentation}
%
% \section{模板介绍}
%
% \cls{njuthesis}，即南京大学学位论文模板，是一个由南京大学 Linux
% 用户组维护的，用于处理本校学生毕业论文排版需求的 \LaTeX 模板。
%
% 本模板使用的本科生毕业论文模板格式依据
% 《关于启动南京大学2024届本科毕业论文（设计）工作的通知》\cite{nju-bachelor-2024}，
% 研究生学位论文格式依据研究生院提供的材料包\cite{nju-graduate-2023}。
% 博士后出站报告格式要求与博士学位论文一致\cite{nju-postdoc-2022}，
% 封面、摘要的设计参考了部分既有报告。
%
%
% \subsection{开始之前}
% \label{subsec:first-things-first}
%
% 在本文正式介绍 \cls{njuthesis} 论文模板前，您也许并不熟悉 \LaTeX 模板的使用方法。
% 话不多说，请先按部就班体验一遍下述的工作流程：
%
% \bigskip
% \fcolorbox{tpblue}{gray!5}{\parbox{\textwidth-5em}{%
% \hspace{2em}\begin{minipage}[c]{10cm}
% \begin{enumerate}
%   \item 访问 \url{https://tex.nju.edu.cn}
%   \item 点击\tpbutton{使用南大统一身份认证登录}
%   \item 点击右上角\tpbutton{LaTeX 模板}，选择\tpbutton{南京大学学位论文}
%   \item 点击进入刚刚新建的项目
% \end{enumerate}
% \end{minipage}}}
%
% \bigskip
% 稍等片刻，您会在浏览器右侧发现一份新生成的空白论文。
% 如果它的效果令您满意，不妨以 \file{njuthesis-sample.tex} 为基础开始写作。
%
% \subparagraph{我一定要体验上述流程吗？}
% 是，但也不一定。有人坚持认为应该做一些\emph{直观、清晰、有手就行、一
% 条路走到底}的教程，而不是\emph{长篇累牍的精细介绍}，其核心论据在于：
% 现代人类总体上需要快速取得成就感，而且大部分可能用到本模板的同学不
% 会具备必要的基础知识。反驳的观点在于过分简单的实验总是浪费时间的，
% 尤其是在您可能早已掌握基本用法的情况下。但，不论如何，这番操作总会
% 使您预览到 \cls{njuthesis} 论文模板的实际样式。
%
% \subparagraph{我并没有见到理想的结果。}
% 具体是哪里不满意？如果是\emph{样式存在偏差}，请联系模板的作者；如果
% \emph{不能访问前文提到的在线编译网站}，请考虑检查网络连接，依次咨询
% 本校\href{https://itsc.nju.edu.cn}{信息化管理建设服务中心}和该网站
% 的维护者\href{mailto:my@yaoge123.cn}{姚舸老师}；如果\emph{报错}，请
% 点击左上角的菜单按钮，查看编译器是否显示为 |XeLaTeX|；
% 再如果\emph{还有其他原因}，通过这几分钟的实验我们也可以得到一个极其
% 有益的结论：\emph{也许 Word 模板更加适合您}。这可以节省下熟悉
% \TeX{} 排版软件使用方法所需的可观时间。
%
% \subparagraph{但我依然对 \LaTeX 一无所知！}
% 这意味着您真的得花些时间在\emph{长篇累牍的精细介绍}上。
% 如果您已经下定决心，请接着向后阅读，有需要时善用搜索引擎。
%
%
% \subsection{历史沿革}
%
% 十几年来，多位热心校友发布过自己编写的模板，在 GitHub 网站上可考的包括：
% \begin{enumerate}
%   \item 杨文博（\href{http://yangwenbo.com/}{@solrex}）的
%        njuthesis（2010 - 2018） \cite{wenboyang2013}
%   \item \href{https://github.com/fireblue}{@fireblue} 基于杨文博模板的
%        NJUThesis（2013）\cite{fireblue2013}
%   \item \href{https://github.com/wenhai-zheng}{@wenhai-zheng} 的
%        NJUThesis（2013）\cite{wenhai-zheng2013}
%   \item 曹增乐（\href{https://github.com/ZLCao}{@ZLCao}）的
%        NJUBachelor（2013 - 2016）\cite{zenglecao2013}
%   \item 胡海星（\href{http://haixing-hu.github.io/}{@Haixing-Hu}）的
%        NJU-Thesis（2013 - 2018）\cite{haixinghu2013}
%   \item 张楚珩（\href{https://github.com/zhangchuheng123}{@zhangchuheng123}）
%        基于胡海星模板的 NJUThesis（2016）\cite{chuhengzhang2016}
%   \item 蒋炎岩（\href{http://ics.nju.edu.cn/~jyy/}{@jiangyy}）的
%        njuthesis（2017 - 2019）\cite{yanyanjiang2017}
%   \item \href{https://github.com/njuHan}{@njuHan} 基于胡海星模板的
%        NJU-Thesis（2018 - 2021）
%   \item 饶安逸（\href{https://anyirao.com/}{@AnyiRao}）基于张楚珩模板的
%        NJU Thesis 2018（2018）\cite{anyirao2018}
%   \item 赵懿晨（\href{https://fengchendian.github.io/about.html}
%        {@FengChendian}）基于饶安逸模板的
%        NJU Thesis 2021（2021）\cite{yichenzhao2021}
% \end{enumerate}
% 至于不幸而未进行代码版本管理的，甚至于说以压缩包形式流传于各人硬盘中的，就更不可计数了。
%
% 与其让一千个学生做一千种不同的模板，不如有人牵起头来，集中力量办大事。因此，南
% 京大学 Linux User Group 的有志之士在2021年暑期联合起来，参考以上的现成模板，兼
% 顾友校 \cls{fduthesis}\cite{fduthesis}、\textsc{THuThesis}\cite{thuthesis} 等
% 优秀项目，构建了这一全新模板，力求通过 \LaTeX3 语法和清晰的接口实现良
% 好的易用性和可维护性。
%
% 目前，本模板的主要维护者包括：
% \begin{itemize}
%   ^^A \item 赵懿晨
%   \item 熊煜
%   ^^A \item 马畅
% \end{itemize}
%
%
% \subsection{快速上手}
%
% \LaTeX 并不是一种零门槛的语言，亦不是南京大学学生的必备技能。有同学听
% 到“\emph{给毕业论文交差也得写代码}”这种事情就头疼，实在是我们不愿意见到而必须
% 要面对的情况。目前，中文互联网上的 \LaTeX 写作教程可谓汗牛充栋，然而
% 如何快速准确找到所需要的用法，尤其是 \LaTeX3 的新接口，需要一定的时间
% 或者良好的英文阅读能力。在本文档的写作中，我们无力从盘古开天辟地开始从头构建您
% 的相关知识体系，只能\emph{尽力做到有求必应}，在需要的地方顺带提一嘴，以期使您
% 少走点弯路。
%
% 如果您希望在使用本模板前了解一些关于这个排版软件的基础知识，在此尝试列举一些有
% 所帮助的资料：
% \begin{description}
%   \item[\textit{lshort}] 著名的介绍文档，已被译为多种语言，
%                          推荐通读其中文版\cite{lshort-zh-cn}。
%   \item[《\LaTeX 入门》] 刘海洋著\cite{刘海洋2013latex入门}。
% \end{description}
%
%
% \subsection{关于本说明手册}
%
% 本模板通过 \textsc{DocStrip} 进行维护，实际上是一种\emph{文学编程}。文学编程的
% 本体是那些用来说明的文字，按写书写文章的方式组织。\file{njuthesis.dtx} 包含
% \cls{njuthesis} 文档类的所有信息。前半部分为模板说明，即各种常用命令与必要的使
% 用方法；后半部分为代码实现，为带有详细注释的 \TeX{} 源代码。后者配合附
% 录，为有意了解本模板实现细节的同学提供必要指引。
%
% 下文中将出现若干特殊格式，用来指示代码组件。譬如，无衬线字体的
% \pkg{pkg-example} 为宏包名，等宽字体的 \file{file-example.xxx} 为文件名，等宽
% 字体的 \opt{opt-example} 为选项名，等宽字体的 \env{env-example} 为需要
%  |\begin{}|和|\end{}|的环境名，等。本手册提供的代码示例中，左侧边线呈现南大标
% 准洋红色 {\color{njumagenta}$\blacksquare$} 的属于终端命令，呈南大标准蓝色
% {\color{njublue}$\blacksquare$} 的属于 \LaTeX 源代码。
%
%
% \subsection{许可说明}
%
% \file{njuthesis.dtx} 文件以及由其直接产生的所有文件被称为
% \cls{njuthesis} 文档类，或者在本文中简称为本模板。
%
% \subparagraph{版权信息}
%   本模板之版权隶属于 © 2021 - 2023 南京大学 Linux 用户组。
%
% \subparagraph{发布和修改}
%   本模板的发布和（或）修改遵守 LaTeX Project Public License（版本 1.3c 或更高）
% 的条款。该许可证的最新版本位于 \url{http://www.latex-project.org/lppl.txt}，
% 1.3c 及更新的版本随附于 2003/12/01 版本以后的所有 \LaTeX 发行版。
%
% \subparagraph{联系作者}
%   如果您在使用最新版模板时发现了任何问题，抑或有意向参与本模板的维护，
% 请通过 \href{https://github.com/nju-lug/NJUThesis/issues}{GitHub Issue}
% 或者 QQ 群聊\footnote{群号是 991559926。}联系 NJU LUG。
%
%
% \section{安装}
% \label{sec:setup}
% 本节主要介绍本宏包的获取、安装以及编译方式。
%
% \subsection{获取模板}
%
% \cls{njuthesis} 目前处于积极的维护中，主要可通过以下三种途径获取模板文件：
%
% \subparagraph{CTAN}
% \href{https://ctan.org/}{CTAN}\footnote{The Comprehensive \TeX{}
% Archive Network} 是所有 \TeX{} 相关材料的中枢。
% 本模板的 CTAN 页面
% \footnote{\href{https://ctan.org/pkg/njuthesis}{\cls{njuthesis}} 已经于2021年9
% 月12日发布在 CTAN，用于绘制南大图标的
% \href{https://ctan.org/pkg/njuvisual}{\pkg{njuvisual}} 也已于同年11月28日发
% 布，两者已被 \TeX{} Live 和 \MiKTeX 收录。}上提供基本的介绍信息，可以下载
% 说明文档（本文档）和宏包源代码。当然，使用这一来源时并不需要接触后者，请参考
% \ref{subsubsec:standard-installation} 的标准安装方法。
%
% \subparagraph{GitHub 仓库}
% 最新开发进度会提交在本项目的
% \href{https://github.com/nju-lug/NJUThesis}{Github仓库}。仓库内仅包含源代码、
% 空白模板及测试文件，不可直接用于写作。这些文件对应的使用方法请参考
% \ref{subsubsec:on-the-fly-installation}。如果由于网络原因不便访问主仓库，也可
% 以从 \href{https://git.nju.edu.cn/nju-lug/nju-latex-templates/njuthesis}
% {NJU Git 同步镜像}获取项目工程文件。
%
% \subparagraph{GitHub Releases}
% 本模板不定期将已有的新功能和问题修复打包为新的正式发行版，赋以更改后的版本号，
% 发布在 \href{https://github.com/nju-lug/NJUThesis/releases/latest}{Github
% Releases 页面}。如果由于网络原因不便访问主仓库，也可以从\ignorespaces
% \href{https://mirror.nju.edu.cn/github-release/nju-lug/NJUThesis/LatestRelease/}
% {南京大学镜像站下载页面}获取。可供下载的文件包括下列三种：
%   \begin{description}
%     \item[\file{njuthesis-v*.pdf}] 模板说明文档（本文档）。
%     \item[\file{njuthesis-user-v*.zip}] 交付给用户的完整模板包，
%          包括格式文件和范本文档，可在解压后用于本地编译，
%          也可直接上传至在线编译网站。
%     \item[\file{njuthesis-ctan-v*.zip}] 交付给 CTAN 的源代码包，
%          普通用户请忽略。
%   \end{description}
%
%
% \subsubsection{文件构成}
%
% 本模板由数量众多的文件组成，\emph{所有可能遇到的}文件如表
% \ref{tab:njuthesis-files} 所示。
%
% \begin{table}[ht]
%   \centering
%   \begin{talltblr}[
%       caption = {\cls{njuthesis}文件构成},
%       label = {tab:njuthesis-files},
%       note{a} = {仅供开发使用，并不会在发布版本中出现。}
%     ] { row{1} = {font=\bfseries}, colspec = {ll} }
%     \toprule
%     名称                               & 说明                             \\
%     \midrule
%     \file{.vscode}                     & Visual Studio Code 配置文件      \\
%     \file{CHANGELOG.md}                & 修订记录                         \\
%     \file{latexmkrc}                   & \pkg{latexmk} 配置文件           \\
%     \file{LICENSE}                     & 许可证                           \\
%     \file{njuthesis.cls}               & 模板文档类                       \\
%     \file{njuthesis.dtx}\TblrNote{a}   & 文档类源代码                     \\
%     \file{njuthesis.ins}\TblrNote{a}   & 文档类安装脚本                   \\
%     \file{njuthesis.pdf}               & 用户手册（本文档）               \\
%     \file{njuthesis-doc.cls}           & 用户手册样式                     \\
%     \file{njuthesis-sample.bib}        & 示例参考文献列表                 \\
%     \file{njuthesis-sample.tex}        & 示例文档，不妨以此为基础撰写论文 \\
%     \file{njuthesis-graduate.def}      & 研究生参数配置文件               \\
%     \file{njuthesis-postdoctoral.def}  & 博士后参数配置文件               \\
%     \file{njuthesis-undergraduate.def} & 本科生参数配置文件               \\
%     \file{README.md}                   & 自述文件                         \\
%     \bottomrule
%   \end{talltblr}
% \end{table}
%
%
% \subsection{本地安装}
%
% \subsubsection{标准安装}
% \label{subsubsec:standard-installation}
%
% 我们\emph{始终建议}使用宏包管理器将 \cls{njuthesis} 安装到您的 \TeX 系
% 统。您可以通过 \TL~Manager 或者 \MiKTeX~Console 等图形化包管理器直接搜
% 索并安装 \cls{njuthesis} （及其依赖的 \pkg{njuvisual}）最新的
% 稳定版。同时，您也可以使用终端命令。例如，假设您使用的是 \TL，
% 键入下述 \pkg{tlmgr} 的命令（很可能需要管理员权限）：
% \begin{shellexample}[morekeywords={tlmgr},emph={install}]
%   tlmgr install njuthesis njuvisual
% \end{shellexample}
% 即可完成安装，无需额外准备 \file{.cls} 文件。
%
% 另一方面，CTAN 依赖开发者手动上传更新，版本更新具有滞后性。如果使用时遇到了问
% 题，不妨使用下一小节的\emph{即时安装方法}优先载入较新的格式文件。
%
% {\color{red}|[!]|} 如果您具备相关经验\footnote{譬如熟悉命令行操作、使用的是 \TL
% 发行版等}，可以在下载仓库内全部文件后，于该目录下运行
% \begin{shellexample}[morekeywords={l3build},emph={install}]
%   l3build install
% \end{shellexample}
% 来安装本模板的最新版。
%
%
% \subsubsection{即时安装}
% \label{subsubsec:on-the-fly-installation}
%
% 在某些情况下（例如需要上传至在线编译平台、新版本提供了急需的错误修复），您可能
% 需要独立的 \file{.cls} 格式文件。此时请前往前述的 Releases 页面下载
% \emph{完整模板包}。
%
% 对于希望使用主仓库中版本的用户，本模板也提供了扁平化安装脚本，用于释放供编译的
% 空白模板和格式文件。Windows 用户请直接双击打开 \file{install-win.bat}；其他平
% 台（包括 macOS 和 Linux）用户请在此目录下运行
% \begin{shellexample}[morekeywords={bash}]
%   bash install-unix.sh
% \end{shellexample}
% 该脚本会生成一个 \file{mythesis/} 目录以便从头写作，仓库内除此文件夹以外的内容
% 都可以尽情删除。
%
% {\color{red}|[!]|} 请注意，如果仅仅是希望使用这个模板撰写论文，请无论如何都不
% 要从手动编译 \file{source} 文件夹下的源代码开始，这样做只会浪费生命中宝贵的数
% 分钟时间。如果遇到了问题，请前往 GitHub 仓库提出 issue。我们只推荐希望参与开发
% 的同学接触 \file{.dtx} 文件。
%
%
% \subsection{本地编译}
% \label{subsec:localcompile}
%
% 本地编译的安装过程分为两个阶段：安装 \TeX 发行版以及配置
% 编辑器。前者提供了可以被命令行终端调用的编译程序，
% 后者则提供了语法高亮、自动编译等人性化功能。
%
% \subsubsection{安装 \TeX{} 发行版}
%
% 首先需要下载并安装 \TeX{} 软件发行版，其中包括引擎、宏包、字体、文档等。
% 各操作系统适用情况请参考表~\ref {tab:texdistribution}。第一次
% 编译前请务必通过 \MiKTeX~Console、\TL~Manager 等图形化程序或
% \pkg{tlmgr} \emph{手动更新全部宏包}以避免潜在的兼容性问题。
% \begin{table}[ht]
%   \centering
%   \caption{\TeX 软件发行版一览}
%   \label{tab:texdistribution}
%   \begin{tabular}{cccc}
%     \toprule
%     \TeX    & Windows   & macOS     & Linux     \\
%     \midrule
%     \TL     & $\bullet$ &           & $\bullet$ \\
%     \MacTeX &           & $\bullet$ &           \\
%     \MiKTeX & $\bullet$ & $\bullet$ & $\bullet$ \\
%     \bottomrule
%   \end{tabular}
% \end{table}
%
% 以下是一些值得注意的要点：
% \begin{itemize}
%   \item 可以参照这份\emph{手把手的教程}\cite{install-latex-guide-zh-cn}。
%   \item 校园网环境中访问\ignorespaces
%         \href{https://mirror.nju.edu.cn/download/TeX%20排版系统}
%         {南京大学开源软件镜像站}可以获得最佳的下载体验。
%   \item 使用最新的发行版，即版本号为2022或者22。
%   \item 对于 Windows 和 macOS 用户，更推荐轻量化的 \MiKTeX 套件。
% ^^A   \item Linux 用户请尽可能下载 full 版本，如 |texlive-full|。
% ^^A         换言之，下载最大的软件包。
%   \item 对于一部分用到新版本特性的宏包，\cls{njuthesis} 内置了版本检查
%         \footnote{譬如遇到 l3 过时问题请运行 |tlmgr update l3packages|。}
%         ，请确认各宏包已升级至最新版。
% \end{itemize}
%
%
% \subsubsection{配置编辑器}
% \changes{v0.11}{2021/11/23}{提供 TeXstudio 配置文件。}
%
% 配置完编译器后，还需要一个\emph{文本编辑器}来完成 \file{.tex} 文件内容的写作。
%
% 关于具体使用哪一种，至今仍有相当一部分人认为Windows自带的\emph{记事本}是
% 最好的文本编辑器。但对于本项目而言，在此诚心诚意地推荐您使用\emph{更现代
% 更美观更多功能}的编辑器，譬如\emph{安装了 \LaTeX Workshop 插件的
% \href{https://code.visualstudio.com/}{Visual Studio Code}}。您也可以根据
% 个人的喜好随意使用 TeXworks、TeXstudio 等编辑器，顺手就行。
%
% \cls{njuthesis} 为一些常见编辑器提供了配置文件，如
% \begin{description}
%   \item[Visual Studio Code] 本模板在 \file{.vscode/} 中提供一份
%        \LaTeX Workshop 插件的简易配置，在打开文件夹后将自动导入，
%        可以省略初始配置步骤直接使用。
%   \item[TeXstudio] 本模板提供 \file{conf.txsprofile}，可以使用快捷键
%        |alt+O+P| 导入配置文件。为了简化流程\footnote{当然，也可以设置
%        为使用 \XeLaTeX 编译，然后按照 \ref{subsubsec:compileseq}
%        内容使用快捷键 |F8| 手动编译参考文献。}，该配置文件使用
%        \pkg{latexmk}，第一次编译前请参考下一节内容安装 Perl。
% \end{description}
%
%
% \subsubsection{编译顺序}
% \label{subsubsec:compileseq}
% \TeX 本身是命令行程序，通过不同的命令调用所需的编译引擎，
% 编辑器提供的快捷按钮实际只是做了包装。为了便于排查运行错误，
% 以下通过具体终端命令简要描述编译过程。
%
% 编译本模板的过程可以概括为下述步骤：
% \begin{enumerate}
%   \item 生成初始文档
%   \item 生成参考文献信息
%   \item 生成页码、编号、目录
%   \item 将参考文献列表页插入目录
% \end{enumerate}
% 总计需要编译四次。\emph{假设即将使用的主文件名为
% \file{njuthesis-sample.tex}}，应采用以下命令顺序进行编译，
% 以生成内容正确的 \file{njuthesis-sample.pdf}。输出的 PDF
% 文档位于同一目录下。该目录下同时会生成若干中间文件。
%
% 编译命令具体为引擎名称加主文件名，在编译 \file{.tex} 文件时，
% 文件扩展名可以省略不写。现阶段 \cls{njuthesis} 仅支持 \XeTeX
% 与 \LuaTeX 引擎，以及 \biber 文献工具。请注意，几种命令的输出文件
% 基本相同，可以任取一种；但如果您不清楚这两种编译引擎的区别，
% 或者对多步编译感到困惑，我们建议优先使用 |latexmk -xelatex|。
%
%
% \subparagraph{使用 \XeLaTeX}
% 标准的 \XeTeX 引擎四步编译方法。
%
% \begin{shellexample}[morekeywords={xelatex,biber}]
%   xelatex njuthesis-sample
%   biber njuthesis-sample
%   xelatex njuthesis-sample
%   xelatex njuthesis-sample
% \end{shellexample}
%
%
% \subparagraph{使用 \LuaLaTeX}
% 标准的 \LuaTeX 引擎四步编译方法。
%
% \begin{shellexample}[morekeywords={lualatex,biber}]
%   lualatex njuthesis-sample
%   biber njuthesis-sample
%   lualatex njuthesis-sample
%   lualatex njuthesis-sample
% \end{shellexample}
%
%
% \subparagraph{使用 \pkg{latexmk}}
% \pkg{latexmk}\cite{latexmk} 是一个基于 Perl 脚本的自动编译工具，
% 宗旨是通过单一命令简化上述的多次编译流程。
% 在使用该命令前，请确保安装了以下软件：
% \begin{description}
%   \item[Perl] 一般预装于 macOS 和 Linux，而 Windows 用户需要单独安装
%        \href{https://strawberryperl.com/}{Strawberry Perl}。
%   \item[\normalfont\pkg{latexmk}] 如果终端找不到 |latexmk| 命令，需使用包管理器单独安装。
% \end{description}
%
% 该命令的使用方法为
% \begin{shellexample}[morekeywords={latexmk}]
%   latexmk njuthesis-sample
% \end{shellexample}
% 直接运行会调用 \pdfLaTeX 引擎导致报错。
% 如需指定编译引擎，可以加入 |-xelatex| 或 |-lualatex| 参数。
% 例如，指定 \XeLaTeX 的命令为
% \begin{shellexample}[morekeywords={latexmk},emph={-xelatex}]
%   latexmk -xelatex njuthesis-sample
% \end{shellexample}
%
% 此外，可以选择使用以下命令清理编译生成的临时文件。
% \begin{shellexample}[morekeywords={latexmk},emph={-c}]
%   latexmk -c
% \end{shellexample}
%
%
% \subsection{在线编译}
% \label{subsec:onlinecompile}
%
% 相信您在接触了本地编译以后，很快就会意识到一些十分显然的事实，譬如 \TeX 编译器
% 安装过程较为漫长\footnote{因此对于 Windows 推荐 \MiKTeX。}，占用空间过大
% \footnote{事实上，可以通过 |scheme-infraonly| 模式安装 \TL，随后利用 \pkg{tlmgr}
% 安装依赖宏包，这份宏包列表可以在 Git 仓库的 \file{.github/workflows/build.yml}
% 找到。}，而且在一部分处理器性能不佳的电脑上需要较长编译时间\footnote{出于文件 IO
% 速度的差异，同一个模板在 Linux 编译可以相对 Windows 节省约一半耗时。}。
% 拒绝接受这些麻烦的同学可以尝试本节介绍的在线编译方法。
%
% {\color{red}|[!]|} 使用在线编辑器时请谨慎备份您的心血结晶。
%
% \subsubsection{南大 \TeX 平台简介}
% \changes{v0.2}{2021/09/07}{添加对南大 \TeX 的支持。}
%
% 当前的\href{https://tex.nju.edu.cn}{南大 \TeX} 基于
% \href{https://www.texpage.com}{TeXPage} 提供的服务，
% 是 \href{https://sci.nju.edu.cn/}{eScience 中心}为南大在校师生提供的
% 免费 \LaTeX 在线编辑器，首次使用时需凭统一身份认证激活账号。
%
%
% \subsubsection{操作步骤}
%
% 本说明手册开头的 \ref{subsec:first-things-first} 即呈现了网站内嵌的
% \cls{njuthesis} 模板的使用方法。
% 如果网站更新不及时，也可以按如下步骤手动上传包含模板的压缩包。
%
% \begin{enumerate}
%   \item 登录\href{https://tex.nju.edu.cn}{南大 \TeX 网站}
%   \item 上传~\ref{subsubsec:on-the-fly-installation}~节得到的压缩文件。
%   \item 在项目页面左上角的\tpbutton{设置}中，确认编译器为 |XeLaTeX| 或者 |LuaLaTeX|
%   \item 仿照 \file{njuthesis-sample.tex} 编写论文
%   \item 点击右上角\tpbutton{编译}按钮进行编译和预览
% \end{enumerate}
%
%
% \subsection{版本升级}
%
% 本模板仍在开发中，将不断发布新版本，您可能需要不定期进行更新以得到
% 对于已知问题的修复补丁。每个版本的更新内容记录于 Git 仓库中的
% \file{CHANGELOG.md}。除非特别提到选项变化，升级时一般无需更改 \file{.tex}
% 文件内容\footnote{在确实发生了接口变动，例如选项名称发生了更改，
% 一种稳妥做法是将论文内容迁移至新版的 \file{njuthesis-sample.tex}}。
% 基于安装和编译方式的差异，可以按照当前工作文件夹内是否有 \file{.cls}
% 文件分别进行更新操作。
%
% \subparagraph{有}
% 下载 \file{njuthesis-user-v*.zip}，使用其中新版的 \file{.cls}、\file{.def}
% 文件覆盖旧版本。
%
% \subparagraph{没有}
% 如果使用的是南大 \TeX，更新内置模板时会进行公告，一般为上传 CTAN
% 后一周内。如果是本地安装，请直接使用包管理器进行更新：
% \begin{shellexample}[morekeywords={tlmgr},emph={update}]
%   tlmgr update --all
% \end{shellexample}
%
%
% \section{使用方法}
%
% \subsection{标准结构}
%
% 典型的 \cls{njuthesis} 主文件结构应该如下所示：
%
% \begin{latexexample}[moretexcs={\njusetup,\tableofcontents,
%   \maketitle,\mainmatter,\chapter,\printbibliography},emph={[1]document}]
%   \documentclass{njuthesis}
%   \njusetup{}
%   \begin{document}
%   \maketitle
%   \tableofcontents
%   \mainmatter
%   \chapter{欢迎}
%   使用 \LaTeX{}！
%   \printbibliography
%   \end{document}
% \end{latexexample}
%
% 如果您尝试编译上面的代码，会发现自己得到了一个5页的 PDF 文档，
% 是一份空白的本科生论文。当然，这个文档实际上没有任何内容，
% 接下来的部分会介绍具体填写内容的方法。
%
%
% \subsection{模板选项}
%
% 模板选项位于 \tn{documentclass} 后的方括号内，用于指定模板的行为。
% 下文中尖括号内列出了若干个允许的选项，其中加粗的为默认选项（缺省值）。
%
% \subsubsection{学位信息}
% \begin{function}[added=2021-09-07,updated=2022-07-23]{type}
%   \begin{syntax}
%     \OPT{type} = <(bachelor)|master|doctor|postdoc>
%   \end{syntax}
% 选择毕业论文模板类型，这将决定模板整体的外观。可选值分别为
% 学士（本科生）、硕士研究生、博士研究生和博士后，默认为学士。
% \end{function}
%
% \begin{function}[added=2021-09-07,updated=2022-07-01]{degree}
%   \begin{syntax}
%     \OPT{degree} = <(academic)|professional>
%   \end{syntax}
% 选择研究生的学位类型。可选值分别学术型和专业型，默认为学术型。
% \end{function}
%
%
% \subsubsection{特殊页面}
%
% \begin{function}[added=2021-09-07,updated=2022-07-05]{nl-cover}
%   \begin{syntax}
%     \OPT{nl-cover} = <\TFF>
%   \end{syntax}
% 是否使用国家图书馆封面，默认关闭。
% \end{function}
%
% 通过此项可用国家图书馆封面\emph{替换}普通封面。
% 由于本科生院文件中并未提及相关规定，故本选项仅对于研究生有效。
%
% \begin{function}[updated=2022-01-06]{decl-page}
%   \begin{syntax}
%     \OPT{decl-page} = <\TFF>
%   \end{syntax}
% 是否需要自动生成声明页面，默认关闭。
% \end{function}
%
% 通过此项，对于本科生模板可在封面后添加的诚信承诺书，对于研究生模板可在
% 封面后添加原创性声明\footnote{其中的打勾符号依赖 \pkg{unicode-math}。}，
% 并且在最后一页添加学位论文出版授权书。
%
% 对于需要手动插入承诺书扫描页的情况，可以在导言区载入 \pkg{pdfpages} 宏包
% \cite{pdfpages}，并在所需位置使用该宏包提供的 \tn{includepdf} 命令。
% 例如，可以用如下所示的命令插入扫描件的第一页，并插入紧随的一个空白页。
% \begin{latexexample}[moretexcs={\includepdf},emph={[2]pages}]
%   \includepdf[pages={1,{}}]{scanned.pdf}
%   % \setcounter{page}{1} % 使扫描页不占用页码
% \end{latexexample}
%
%
% \subsubsection{页面模式}
%
% \begin{function}[added=2022-01-14]{oneside,twoside}
%   \begin{syntax}
%     <\OPT{oneside}|(\OPT{twoside})>
%   \end{syntax}
% 开启单面或双面模式，默认为双面模式。
% \end{function}
%
% 本选项继承自 \LaTeXe \cls{book} 标准文档类。
% 单双面选项为全局选项，开启后会改变页码编号，以及部分宏包的行为。
% 在单面模式下，页面是连续的，不会产生空白页；在双面模式下，
% 新的一章以及封面、摘要、参考文献表等特殊页面都会从奇数页开始，
% 在奇数页结束的内容后会补上一页空页，更适合印刷输出。
%
% \begin{function}[added=2021-12-15]{draft}
%   \begin{syntax}
%     \OPT{draft} = <\TFF>
%   \end{syntax}
% 是否开启草稿模式，默认关闭。
% \end{function}
%
% 本选项继承自 \LaTeXe \cls{book} 标准文档类。
% 草稿模式为全局选项，启用这一选项将产生以下整体影响：
% \begin{itemize}
%   \item 禁用封面的绘制（包括承诺和声明）
%   \item 显示页面文字范围边框以及页眉页脚线
%   \item 在超出宽度的内容右侧添加黑色方块标记
%   \item 不再渲染图片，使用含有图片路径的空白盒子占位
%   \item 不再渲染超链接及生成 PDF 书签
% \end{itemize}
% 草稿模式有助于提升编译速度以及检查格式问题，建议在定稿前始终开启。
%
% 启用这一选项也会改变特定宏包的行为，譬如在草稿模式下 \pkg{listings}
% 宏包的代码环境不会显示内容，具体效果需要参照各个宏包的说明文档。
% 如需抵消草稿模式的影响，请使用 \opt{final} 选项载入相关宏包。
%
% \begin{function}[added=2022-04-19,updated=2022-09-26]{anonymous}
%   \begin{syntax}
%     \OPT{anonymous} = <\TFF>
%   \end{syntax}
% 是否开启盲审模式。
% \end{function}
%
% 盲审模式会抹除论文中的学校和个人信息，效果包括：
% \begin{itemize}
%   \item 不显示校名校徽图片
%   \item 不显示“南京大学”字样
%   \item 不显示作者、导师等基本信息
%   \item 不显示声明页、致谢页
% \end{itemize}
%
%
% \subsubsection{可选宏包}
% \label{subsubsec:optional-pkg}
%
% \begin{function}[added=2022-08-03]{
%   biblatex,
%   cleveref,
%   ntheorem,
%   enumitem,
%   footmisc,
%   unicode-math}
%   \begin{syntax}
%     \OPT{biblatex}     = <\TTF>
%     \OPT{cleveref}     = <\TTF>
%     \OPT{ntheorem}     = <\TTF>
%     \OPT{enumitem}     = <\TTF>
%     \OPT{footmisc}     = <\TTF>
%     \OPT{unicode-math} = <\TTF>
%   \end{syntax}
% 是否默认载入某些宏包，默认均是。选项名和宏包名是一致的。
% \end{function}
%
% \begin{function}[added=2022-08-03]{minimal}
%   \begin{syntax}
%     <\OPT{minimal}>
%   \end{syntax}
% 最小化模式，禁用所有上述宏包。
% \end{function}
%
% 本模板内置了一系列宏包以进行功能扩展。这些宏包为：
% \begin{description}
%   \item[\normalfont\pkg{biblatex}] 复杂参考文献数据的处理。
%   \item[\normalfont\pkg{cleveref}] 按来源类型自动处理引用标签。
%   \item[\normalfont\pkg{ntheorem}] 定理类环境定制。
%   \item[\normalfont\pkg{enumitem}] 列表环境样式定制。
%   \item[\normalfont\pkg{footmisc}] 脚注样式定制。
%   \item[\normalfont\pkg{unicode-math}] 支持 Unicode 数学字体。
% \end{description}
%
% 在某些情况下，这些宏包会与旧有的经验方法冲突，可以使用上述选项在模板
% 中禁用这些宏包，从而手动配置相关功能。
%
% \subsubsection{配置文件}
%
% \begin{function}[added=2022-02-23]{config}
%   \begin{syntax}
%     \OPT{config} = \Arg{文件}
%   \end{syntax}
% 配置文件路径。
% \end{function}
%
% 本选项可用于载入额外的用户配置文件。该文件支持 \LaTeX3 语法。
%
%
% \subsubsection{指定字体}
%
% 学校论文格式要求使用的字体一般已经预装在各个操作系统，
% 本模板针对不同平台进行了自动检测适配，可以开箱即用。
% 如果希望更改本模板使用的字体，请填写以下选项以覆盖默认设置。
%
% \begin{function}[added=2023-12-15]{fontset}
%   \begin{syntax}
%     \OPT{fontset} = <win|macoffice|mac|fandol|none>
%   \end{syntax}
% 手动指定字体库。
% \end{function}
%
% \opt{fontset} 这个选项名继承自 \pkg{ctex}，相当于在本模板中分别填写以下两项。
%
% \begin{function}[added=2021-09-07,updated=2021-12-18]{cjk-font,latin-font}
%   \begin{syntax}
%     \OPT{cjk-font} = <win|mac|fandol|founder|noto|source|none>
%     \OPT{latin-font} = <win|mac|gyre|none>
%   \end{syntax}
% 更精细的字体库设定。
% \end{function}
%
% 根据学校论文格式的要求，本模板使用的中文字体主要有{\songti 宋体}、
% {\heiti 黑体}、{\kaishu 楷体}、{\fangsong 仿宋}四种；
% 西文字体主要有衬线体（\textup{serif}）、无衬线体（\textsf{sans-serif}）
% 和等宽字体（\texttt{monospace}）三种。
% 在生成论文时，需要将每一种字体（宋体、楷体）与一种字库（操作系统中的
% \file{.ttf} 文件）相对应。由于不同操作系统自带的字库不同，
% 在不同的操作系统上使用同一套配置会导致缺字、编译出错等后果。
% 因此，本模板对于中文字体和西文字体都提供了多种字体配置。
%
% 若要手动选择字体，则需将字体设置为 \opt{none}，再通过 \pkg{fontspec}
% 宏包或 \pkg{ctex} 宏包中给出的命令来实现。
%
% \begin{function}[added=2022-07-02]{font-path}
%   \begin{syntax}
%     font-path = \Arg{文件夹}
%   \end{syntax}
% 字体文件目录。
% \end{function}
%
% 模板用到的部分字体可能尚未安装在操作系统，可以使用此选项手动指定搜索路径。
% 例如，研究生模板封面上使用到了华文中宋，该字体默认只存在于
% \opt{win} 和 \opt{macoffice} 对应的系统配置，
% 在其他平台编译需使用此选项手动指向 \file{STZHONGS.TTF}。
%
% \paragraph{中文}
%
% 本模板提供的中文字体配置如表 \ref{tab:cjk-fontset} 所示。
% 在不指定字体配置的情况下，本模板默认使用与操作系统相对应的字体配置
% （见表中前四行，在装有 MS Office 的 macOS 上优先使用 Office 字体库。
% Windows 和 macOS 以外的系统采用
% \href{https://www.ctan.org/pkg/fandol}{Fandol} 配置）。
% 此外，我们也单独提供了\href{https://www.foundertype.com}
% {方正}和\href{https://github.com/adobe-fonts}{思源}两套中文字体配置。
%
% \begin{table}[!htbp]
%   \def\FD{http://www.foundertype.com/index.php/FontInfo/index/id/1}
%   \def\MN{https://mirrors.nju.edu.cn/adobe-fonts/source-han-}
%   \def\OT{/OTF/SimplifiedChinese/}
%   \def\FZ#1#2{\href{\FD #1}{方正 #2}}
%   \def\SC#1#2{\href{\MN #1\OT}{思源 #2 体}}
%   \centering
%   \begin{talltblr}[
%     caption = {中文字体配置},
%     label = {tab:cjk-fontset},
%     note{a} = {请下载简繁扩展（即 GBK 编码）版本},
%     note{b} = {使用\href{\FD164}{方正小标宋}作为方正书宋的粗体},
%     note{c} = {使用\href{\FD131}{方正黑体}作为方正细黑一的粗体},
%     note{d} = {在部分操作系统中可能已经预装 Google Noto 字体。
%       考虑到获取字体的难易程度，单独安装时建议采用 Adobe Source Han 字体
%       表示思源字体，请下载 Simplified Chinese（即后缀名为 SC）的版本},
%     note{e} = {思源字体并不包含楷书和仿宋，而 Adobe
%       楷体和仿宋难以直接下载，因此使用方正字体代替} ]
%     { cell{2}{2-5} = {white!70!njuyellow},
%       cell{3}{2-5} = {white!70!njuyellow},
%       cell{5-8}{4} = {white!70!njuyellow},
%       colspec = {ccccc} }
%   \toprule
%     配置名称         & 宋体             & 黑体               & 楷书          & 仿宋          \\
%   \midrule
%     \opt{win}        & 中易宋体         & 中易黑体           & 中易楷体      & 中易仿宋      \\
%     \opt{macoffice}  & 中易宋体         & 中易黑体           & 中易楷体      & 中易仿宋      \\
%     \opt{mac}        & 华文宋体         & 华文黑体           & 华文楷体      & 华文仿宋      \\
%     \opt{fandol}     & Fandol 宋体      & Fandol 黑体        & Fandol 楷体   & Fandol 仿宋   \\
%     \opt{founder}\TA & \FZ{51}{书宋}\TB & \FZ{61}{细黑一}\TC & \FZ{37}{楷体} & \FZ{28}{仿宋} \\
%     \opt{noto}   \TD & 思源宋体         & 思源黑体           & 方正楷体\TE   & 方正仿宋\TE   \\
%     \opt{source} \TD & \SC{serif}{宋}   & \SC{sans}{黑}      & 方正楷体\TE   & 方正仿宋\TE   \\
%   \bottomrule
%   \end{talltblr}
% \end{table}
%
% 由于各操作系统对自带字体的支持程度不同，本模板对不同字体加粗的方式
% 有所差别，表 \ref{tab:cjk-fontset} 中，黄色底色的字体采用算法加粗。
% 除此以外，各种字体在设计上也存在差异，因此本模板在不同操作系统下编
% 译的结果可能存在细微不同，使用时请注意。若想要获得与 Word 版本模板
% 最为贴近的体验，可以通过手动安装 Windows 自带的中易宋体、中易黑体、
% 中易楷体和中易仿宋，并设置使用 Windows 字体来实现。
%
% \paragraph{西文}
%
% 本模板提供的西文字体配置如表 \ref{tab:latin-fontset} 所示。
% 在不指定字体配置的情况下，本模板默认使用与操作系统相对应的
% 字体配置。Windows 和 macOS 以外的系统采用 \opt{gyre} 配置。
%
% \begin{table}[!htbp]
%   \def\TG#1{TG~#1~\TA}
%   \centering
%   \begin{talltblr} [
%       caption = {西文字体配置},
%       label   = {tab:latin-fontset},
%       note{a} = {TG 表示 \href{http://www.gust.org.pl/projects/e-foundry/tex-gyre}{\TeX~Gyre}。} ]
%     { colspec = {cccc} }
%     \toprule
%       配置名称         & 衬线体          & 无衬线体   & 等宽字体    \\
%     \midrule
%       \opt{win}        & Times~New~Roman & Arial      & Courier~New \\
%       \opt{macoffice}  & Times~New~Roman & Arial      & Menlo       \\
%       \opt{mac}        & Times~New~Roman & Arial      & Menlo       \\
%       \opt{gyre}       & \TG{Termes}     & \TG{Heros} & \TG{Cursor} \\
%     \bottomrule
%   \end{talltblr}
% \end{table}
%
% macOS 用户需要额外注意的是，系统内置的 Times New Roman 并没有 smcp
% 这一特性，所以 \tn{textsc} 命令无法产生正确的小型大写字母字型，导致
% 研究生模板英文封面的部分内容不能正确显示。另外，macOS 中的 Times 字体
% 也不包含 smcp 特性。
% 相应的解决办法是拷贝一份 Windows 预装的 Times New Roman
% \footnote{Times New Roman（或 TimesNewRomanPSMT）在 Windows 和 macOS
% 下的区别在于版本。根据我们的测试，Windows 10 下该字体的版本为 7.00，
% 而 macOS Monterey 下该字体的版本为 5.01.3x。这显然是苹果的问题。}，
% 或者使用 \TeX{} Live 内置的 \TeX{} Gyre Termes 字体
% \footnote{\TeX{} Gyre Termes 可以视作 Times New Roman 的重制版，两者的
% 视觉感受是一致的。}，这两个字体都具备 smcp 特性。
% 本模板在检测到 Times New Roman 不包含 smcp 特性时，会抛出警告并使用
% \TeX{} Gyre Termes 字体进行替换。
%
% \paragraph{数学}
%
% \begin{function}[added=2022-07-02]{math-font}
%   \begin{syntax}
%     \OPT{math-font} = <asana|cambria|fira|garamond|lm|...|termes|(xits)|none>
%   \end{syntax}
% 设置数学字体。完整列表见表 {tab:math-fontset}。
% \end{function}
%
% 本模板默认采用 \pkg{unicode-math} 宏包配置数学模式下使用的字体。
% 与原生 \LaTeX{} 最接近的字体对应 \opt{lm}，MS Word 预装的字体对应 \opt{cambria}。
%
% \begin{table}[!htbp]
%   \def\NCM{New Computer Modern}
%   \centering
%   \begin{talltblr} [
%       caption = {数学字体配置},
%       label   = {tab:math-fontset},
%       note{a} = {TG 表示 \href{http://www.gust.org.pl/projects/e-foundry/tex-gyre}{\TeX~Gyre}。},
%       note{b} = {粗体使用 XITS Math Bold。} ]
%     { colspec = {ccl} }
%   \toprule
%     配置名称          & 字体名称            & 描述                       \\
%   \midrule
%     \opt{asana}       & Asana Math          &                            \\
%     \opt{cambria}     & Cambria Math        & 微软 Office 预装的数学字体 \\
%     \opt{fira}        & Fira Math           & 无衬线数学字体，Fira 风格  \\
%     \opt{garamond}    & Garamond Math       & Garamond 风格              \\
%     \opt{lm}          & Latin Modern Math   & Computer Modern 风格       \\
%     \opt{libertinus}  & Libertinus Math     &                            \\
%     \opt{newcm}       & \NCM~Math           & Computer Modern 风格       \\
%     \opt{stix}        & STIX Math           & Times 风格                 \\
%     \opt{bonum}       & TG Bonum Math   \TA &                            \\
%     \opt{dejavu}      & TG DejaVu Math  \TA & DejaVu 风格                \\
%     \opt{pagella}     & TG Pagella Math \TA & Palatino 风格              \\
%     \opt{schola}      & TG Schola Math  \TA &                            \\
%     \opt{termes}      & TG Termes Math  \TA & Times 风格                 \\
%     \opt{xits}        & XITS Math       \TB & 基于 STIX，Times 风格      \\
%   \bottomrule
%   \end{talltblr}
% \end{table}
%
% \paragraph{授权}
%
% 本节提及的字库中，中文字库只有方正书宋、方正黑体、方正楷体、方正仿宋、
% 两种思源字体和四种Fandol字体能够\emph{免费商用}；
% 英文字库中只有 Times New Roman、XITS 和三种 \TeX~Gyre字体能够\emph{免费商用}。
% 因此，若需要将本模板用于商业相关的活动，请咨询专业人士。
%
%
% \subsection{设置接口}
%
% \begin{function}[added=2021-09-10,updated=2022-08-01]{\njusetup}
%   \begin{syntax}
%     \tn{njusetup}\oarg{键路径}\marg{设置项}
%   \end{syntax}
% \cls{njuthesis} 文档类的通用设置命令，提供自定义接口。
% \end{function}
%
% 根据可选参数填写方式不同，\tn{njusetup} 共有四种等效的使用方式，
% 可以根据实际情况进行灵活选择。
%
% 在键路径留空时，为最基础的用法。此时设置项的参数是一个使用
% \emph{英文半角逗号}分隔的键值列表，通常形如 \meta{key}|=|\meta{value}。
%
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]info,bib},
%   emph={[3]title,author,resource}]
%   \njusetup{
%       info/title   = {奇文},
%       info/author  = {佚名},
%       bib/resource = {ref1.bib, ref2.bib}
%     }
% \end{latexexample}
%
% 以上为最基础的填写方法，可以分组为：
%
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]info,bib},
%   emph={[3]title,author,resource}]
%   \njusetup{
%       info = {
%           title    = {奇文},
%           author   = {佚名}
%         },
%       bib = {
%           resource = {ref1.bib, ref2.bib},
%         }
%     }
% \end{latexexample}
%
% 在键路径填入模块（类）时，只能设定当前模块下的选项。此时参数是键值列表。
%
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]info,bib},
%   emph={[3]title,author,resource}]
%   \njusetup[info]{
%       title    = {奇文},
%       author   = {佚名}
%     }
%   \njusetup[bib]{
%       resource = {ref1.bib, ref2.bib}
%     }
% \end{latexexample}
%
% 在键路径填入具体选项名称时，只能设定该选项的值。
%
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]info,bib},
%   emph={[3]title,author,resource}]
%   \njusetup[info/title]{奇文}
%   \njusetup[info/author]{佚名}
%   \njusetup[bib/resource]{ref1.bib, ref2.bib}
% \end{latexexample}
%
%
% \subsection{个人信息}
%
% |info| 类用于设置个人信息。
% 以下为全部的个人信息参数，其中带有星号的为对应的英文字段。
%
% \begin{function}[updated=2022-01-14]{info/title,info/title*}
%   \begin{syntax}
%     \OPT{title}  = \Arg{标题}
%     \OPT{title*} = \Arg{英文标题}
%   \end{syntax}
% 题目。由于封面上提供给中文题目的横线长度有限\footnote{单行最长约为15
% 个汉字，建议总长度不超过45字，当然你也可以对照 \ref{subsubsec:modify-length}
% 节修改横线长度}，本模板默认会自动对标题进行换行。
% 如果需要手动指定换行位点，请使用换行控制符（ |\\| ）。
% \end{function}
%
% 绘制封面及摘要中的标题涉及断行处理，无法对空字符串产生正确结果。
% 因而在手动将标题设置为空时，本模板将抛出如下错误：
% \begin{shellexample}[deletekeywords={in}]
%   ! Package njuthesis Error: The title should not be left blank.
%   (njuthesis)                Please check whether you have fill in both
%   (njuthesis)                Chinese and English titles.
% \end{shellexample}
%
% \begin{function}[updated=2021-10-01]{info/keywords,info/keywords*}
%   \begin{syntax}
%     \OPT{keywords}  = \Arg{关键词}
%     \OPT{keywords*} = \Arg{英文关键词}
%   \end{syntax}
% 关键词列表。关键词之间需要使用英文半角逗号隔开，
% 含有空格的关键字需要使用花括号包裹以避免歧义。可以参照下方的填写示例。
% \end{function}
%
% \begin{function}[updated=2021-10-01]{info/grade}
%   \begin{syntax}
%     \OPT{grade} = \Arg{20XX}
%   \end{syntax}
% 年级，推荐格式为“20XX”。
% \end{function}
%
% \begin{function}[updated=2021-10-01]{info/student-id}
%   \begin{syntax}
%     \OPT{student-id} = \Arg{学号或工号}
%   \end{syntax}
% 学号或工号。南京大学本科生为9位数字学号，
% 研究生为两位大写字母标识加上数字组成的学号（2022级改为纯数字）。
% \end{function}
%
% \begin{function}[updated=2021-10-01]{info/author,info/author*}
%   \begin{syntax}
%     \OPT{author}  = \Arg{你的名字}
%     \OPT{author*} = \Arg{姓名拼音}
%   \end{syntax}
% 姓名。
% \end{function}
%
% \begin{function}[updated=2021-10-01]{info/department,info/department*}
%   \begin{syntax}
%     \OPT{department}  = \Arg{院系}
%     \OPT{department*} = \Arg{院系}
%   \end{syntax}
% 院系。
% \end{function}
%
% \begin{function}[updated=2023-12-05]{info/major,info/major*}
%   \begin{syntax}
%     \OPT{major}  = \Arg{专业}
%     \OPT{major}  = \Arg{封面专业, 摘要专业}
%     \OPT{major*} = \Arg{专业}
%   \end{syntax}
% 专业。研究生的专业型学位封面上，“专业学位类别(领域)”一栏的
% 填写内容可能与摘要页不一致，可以使用半角逗号分隔两个值。
% \end{function}
%
% \begin{function}[updated=2021-10-01]{info/field,info/field*}
%   \begin{syntax}
%     \OPT{field}  = \Arg{方向}
%     \OPT{field*} = \Arg{方向}
%   \end{syntax}
% 研究领域。只有研究生存在研究领域的说法，本科生无需填写。
% \end{function}
%
% \begin{function}[updated=2022-01-12]{info/supervisor,info/supervisor*}
%   \begin{syntax}
%     \OPT{supervisor}  = \Arg{导师姓名,职称}
%     \OPT{supervisor*} = \Arg{导师英文全称}
%   \end{syntax}
% 导师全称。请使用逗号（ |,| ）分隔导师的中文姓名与职称，英文名则不需添加逗号。
% \end{function}
%
% \begin{function}[updated=2021-01-12]{info/supervisor-ii,info/supervisor-ii*}
%   \begin{syntax}
%     \OPT{supervisor-ii}  = \Arg{第二导师姓名,职称}
%     \OPT{supervisor-ii*} = \Arg{第二导师英文全称}
%   \end{syntax}
% 第二导师全称。无第二导师时不填即可。
% \end{function}
%
% \begin{function}[updated=2022-01-14]{info/submit-date}
%   \begin{syntax}
%     \OPT{submit-date} = \Arg{yyyy-mm-dd}
%   \end{syntax}
% 提交日期。中英文日期现在可以由 ISO 日期格式\cite{gb-t-7408-2005}
% 的字符串统一生成。如果在等号后留空，则原本中文日期处使用空白的年月日字样；
% 如果不添加此设置项，则自动使用编译当天日期。
% \end{function}
%
% \begin{function}[updated=2022-01-14]{info/defend-date}
%   \begin{syntax}
%     \OPT{defend-date} = \Arg{yyyy-mm-dd}
%   \end{syntax}
% 答辩日期，只对研究生有效，要求同提交日期。
% \end{function}
%
% \begin{function}[updated=2022-05-23]{info/confer-date}
%   \begin{syntax}
%     \OPT{confer-date} = \Arg{yyyy-mm-dd}
%   \end{syntax}
% 学位授予日期，只用于国家图书馆封面，要求同提交日期。
% \end{function}
%
% \begin{function}[updated=2022-05-23]{info/bottom-date}
%   \begin{syntax}
%     \OPT{bottom-date} = \Arg{yyyy-mm-dd}
%   \end{syntax}
% 底部日期，只用于国家图书馆封面，要求同提交日期。
% \end{function}
%
% \begin{function}[updated=2022-05-27]{info/chairman,info/reviewer}
%   \begin{syntax}
%     \OPT{chairman} = \Arg{答辩主席姓名职称}
%     \OPT{reviewer} = \Arg{答辩评委姓名职称}
%   \end{syntax}
% 答辩委员会信息，分别为评审委员会主席及成员的姓名加职称，只对研究生有效。
% 评审成员名单以逗号分隔的列表形式存储，填写方法同关键词。
% 如果是盲审，填入“盲审”二字即可。
% \end{function}
%
% \begin{function}[updated=2021-10-01]{info/clc,info/udc}
%   \begin{syntax}
%     \OPT{clc} = \Arg{中国图书分类号}
%     \OPT{udc} = \Arg{国际图书分类号}
%   \end{syntax}
% 研究生学位论文封面上的\href{http://www.ztflh.com/}{中国图书分类号}和\ignorespaces
% \href{http://www.udcsummary.info/php/index.php?lang=chi&pr=Y}{国际图书分类号}。
% \end{function}
%
% \begin{function}[updated=2021-10-01]{info/secret-level}
%   \begin{syntax}
%     \OPT{secret-level} = \Arg{密级}
%   \end{syntax}
% 研究生学位论文封面上的密级。
% \end{function}
%
% \begin{function}[updated=2021-10-01]{info/supervisor-contact}
%   \begin{syntax}
%     \OPT{supervisor-contact} = \Arg{导师联系方式}
%   \end{syntax}
% 国家图书馆封面上的导师联系方式。
% \end{function}
%
% \begin{function}[added=2023-04-29]{info/school-code}
%   \begin{syntax}
%     \OPT{school-code} = \Arg{10284}
%   \end{syntax}
% 研究生学位论文封面上的学校代码。\CJKsout{你不会真的想改这个吧？}
% \end{function}
%
% \begin{function}[added=2023-04-24]{info/degree,info/degree*}
%   \begin{syntax}
%     \OPT{degree}  = \Arg{中文学位名}
%     \OPT{degree*} = \Arg{英文学位名}
%   \end{syntax}
% 研究生国家图书馆封面英文封面上的学位名称。默认会由模板通过 \opt{degree}
% 和 \opt{type} 文档类选项生成，也可以由本选项自定义名称。
% \end{function}
%
%
% \subsubsection{输入示范}
%
% 本科生可以参考如下范例输入个人信息。注意不能有空行。
%
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]info},emph={[3]title,title*,
%   keywords,keywords*,grade,student-id,author,author*,department,department*,
%   major,major*,supervisor,supervisor*,submit-date}]
%   \njusetup[info]{
%       title        = {第一行标题\\第二行标题},
%       title*       = {My Awesome Work},
%       keywords     = {我,就是,充数的,关键词},
%       keywords*    = {Dummy, Keywords, Here, {it is}},
%       grade        = {2018},
%       student-id   = {189114514},
%       author       = {周煜华},
%       author*      = {Zhou Yuhua},
%       department   = {化学化工学院},
%       department*  = {School of Chemistry and Chemical Engineering},
%       major        = {化学},
%       major*       = {Chemistry},
%       supervisor   = {李成殿,教授},
%       supervisor*  = {Professor Li Chengdian},
%       submit-date  = {2021-09-12}
%   }
% \end{latexexample}
%
% 研究生可以参考如下列表输入个人信息
%
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]info},emph={[3]title,title*,
%   keywords,keywords*,grade,student-id,author,author*,department,department*,
%   major,major*,field,field*,supervisor,supervisor*,submit-date,defend-date,email}]
%   \njusetup[info]{
%       title        = {第一行标题\\第二行标题\\第三行标题},
%       title*       = {My Awesome Work},
%       keywords     = {我,就是,充数的,关键词},
%       keywords*    = {Dummy,Keywords,Here,{it is}},
%       grade        = {2018},
%       student-id   = {DZ18114514},
%       author       = {周煜华},
%       author*      = {Zhou Yuhua},
%       department   = {化学化工学院},
%       department*  = {School of Chemistry and Chemical Engineering},
%       major        = {化学},
%       major*       = {Chemistry},
%       field        = {物理化学},
%       field*       = {Physical Chemistry},
%       supervisor   = {李成殿,教授},
%       supervisor*  = {Professor Li Chengdian},
%       submit-date  = {2021-09-12},
%       defend-date  = {2022-01-15},
%       clc          = {0175.2},
%       udc          = {004.72},
%       secret-level = {公开},
%       chairman     = {张~教授},
%       reviewer     = {王~教授,赵~副教授,李~助理研究员},
%       email        = {git+nju-lug-email-3104-issue-@yaoge123.cn}
%   }
% \end{latexexample}
%
% 如果需要国家图书馆封面，还需要加入如下信息
%
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]info},emph={[3]confer-date,
%   bottom-date,chairman,reviewer,clc,secret-level,udc,supervisor-contact}]
%   \njusetup[info]{
%       confer-date  = {2022-05-20},
%       bottom-date  = {2022-05-21},
%       supervisor-contact = {化学化工学院 仙林大道 163 号 210046}
%   }
% \end{latexexample}
%
% 博士后可以参考如下范例输入个人信息。
%
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]info},emph={[3]title,title*,
%   keywords,keywords*,student-id,author,department,major,supervisor,submit-date}]
%   \njusetup[info]{
%       title        = {第一行标题\\第二行标题},
%       title*       = {My Awesome Work},
%       keywords     = {我,就是,充数的,关键词},
%       keywords*    = {Dummy, Keywords, Here, {it is}},
%       student-id   = {189114514},
%       author       = {周煜华},
%       department   = {化学化工学院},
%       major        = {化学},
%       supervisor   = {李成殿,教授},
%       submit-date  = {2021-09-12}
%   }
% \end{latexexample}
%
%
% \subsection{编写正文}
%
% 与导言区相对的是正文，位于 \env{document} 环境内。
%
% \begin{function}{\mainmatter}
%   \tn{mainmatter} 标志着正文的开始，使用阿拉伯数字重新进行页码编号，
%   并设置页眉页脚格式。
% \end{function}
%
% \begin{function}{\chaptermark,\sectionmark}
%   \begin{syntax}
%     \tn{chapter}\oarg{用在页眉的章标题}\marg{完整的章标题}
%     \tn{sectionmark}\marg{用在目录中的章标题}
%     \tn{section}\oarg{用在页眉的章标题}\marg{完整的节标题}
%     \tn{sectionmark}\marg{用在目录节标题}
%   \end{syntax}
% 如果页眉内容发生了冲突，可使用这两个命令细化定制。
% \end{function}
%
%
% \subsubsection{页面}
%
% 在本模板预定义的页面样式中：本科生使用 \opt{plain} 样式，无页眉，
% 页面编号使用五号罗马体，居中位于页脚；研究生使用 \opt{headings} 样式，
% 页眉使用五号楷体，包括章名（奇数页右侧）和节名（偶数页左侧），
% 页面编号使用五号罗马体，居中位于页脚。在单面模式下，页眉会同时显示章节名。
%
% 考虑到各个院系对于页眉内容的规定并不一致，本模板提供了若干个自定义选项。
%
% \begin{function}{header/content,header/content*,footer/content,footer/content*}
%   \begin{syntax}
%     \OPT{content}  = \{\Arg{位置}\Arg{内容},\Arg{位置}\Arg{内容},...\}
%     \OPT{content*} = \{\Arg{位置}\Arg{内容},\Arg{位置}\Arg{内容},...\}
%   \end{syntax}
% 页眉页脚的格式与内容设置。带有星号的设置项供单面模式下使用。
% \end{function}
%
% 页眉页脚的内容设置是一个逗号分隔的列表，实际上是 \tn{fancyhead} 和
% \tn{fancyfoot} 命令的选项。前一个花括号内为大写字母指定的位置选项，
% 可使用左（\opt{L}）、中（\opt{C}）、右（\opt{R}）。
% 双面模式下可额外指定出现在奇数页（\opt{O}）还是偶数页（\opt{E}）。
% 详细说明请参考 \pkg{fancyhdr} 的手册。
%
% 接下来展示了一个手动设置页眉内容的例子。这里我们清空了页脚，
% 并将页眉格式设置成五号黑体，奇数页左侧为节名，右侧为页码，
% 偶数页左侧为页码，右侧为章名。
% \begin{latexexample}[moretexcs={\njusetup,\sffamily,\njusetformat},
%   emph={[2]header,footer},emph={[3]content}]
%   \njusetup[header/content]{
%       { OR } { \thepage }, { OL } { \rightmark },
%       { EL } { \thepage }, { ER } { \leftmark  }
%   },
%   \njusetup[footer/content]{}
%   \njusetformat{header}{\small\sffamily}
% \end{latexexample}
%
%
% \subsubsection{字形}
%
% 本模板继承 \pkg{ctex} 宏集提供的字形字号设置，以备不时之需。换句话说，
% 除非你有十足的把握，认为某处字体产生了偏差\footnote{在此情况下也应当
% 直接到 GitHub 仓库反馈}，否则无需动用这些命令处理样式问题。
%
% \begin{function}[added=2021-09-22]{\njuline}
%   \begin{syntax}
%     \tn{njuline}\Arg{文字}
%   \end{syntax}
% 为了避免原生 \tn{uline} 命令在中文环境下不能正常换行的问题，
% 本模板使用 \tn{njuline} 作为替代方案，分别对 \XeLaTeX 的
% \pkg{xeCJKfntef} 包和 \LuaLaTeX 的 \pkg{lua-ul}
% 包中的下划线命令进行了包装。
% \end{function}
%
% \subsubsection{列表}
%
% 模板默认载入 \pkg{enumitem} 宏包，对三个常用列表环境内的条目间距进行压缩。
% 可以通过第 \ref{subsubsec:optional-pkg} 节提供的选项禁用该宏包。
%
% \subsubsection{图片}
%
% \begin{function}[added=2022-08-06]{image/path}
%   \begin{syntax}
%     \OPT{path} = \{\marg{路径1},\marg{路径2},...\}
%   \end{syntax}
% 图片搜索路径，等效于 \tn{graphicspath}。这个选项仅能设置一次。
% \end{function}
%
% \subsubsection{脚注}
%
% \begin{function}[added=2022-05-01,updated=2022-10-16]{footnote/style}
%   \begin{syntax}
%     \OPT{style} = <(plain)|pifont|circled|circled*>
%   \end{syntax}
% 设置脚注编号样式。默认为普通数字；使用 \opt{pifont} 可修改为带圈数字，
% 由于字体包含的字符数量有限，单页不建议超过10条脚注；使用 \opt{circled} 或 \opt{circled*}
% 选项同样可修改为带圈数字，且不受单页脚注数量的限制，带星号的选项为黑底白字（阴文）。
% \footnote{此功能依赖的 \pkg{circledtext} 宏包于 2022 年 4 月发布，可能需要手动安装。}
% \end{function}
%
% \begin{function}[added=2022-10-16]{footnote/circledtext-option}
%   \begin{syntax}
%     \OPT{circledtext-option} = \meta{选项列表}
%   \end{syntax}
% \opt{circled} 或 \opt{circled*} 选项的带圈数字编号使用 \pkg{circledtext}
% 宏包绘制，可使用本选项载入更多定制设置，详见其手册。
% \end{function}
%
% \begin{function}[added=2022-10-16]{footnote/hang}
%   \begin{syntax}
%     \OPT{hang} = \TTF
%   \end{syntax}
% 是否进行悬挂缩进。默认为是，缩进宽度为 \qty{1.5}{em}。
% \end{function}
%
% 脚注样式的调整依赖 \pkg{footmisc}。如果希望使用 \LaTeX 的默认样式，
% 可以通过第 \ref{subsubsec:optional-pkg} 节提供的选项禁用该宏包。
%
% \subsubsection{数学符号}
%
% ^^A \url{https://www.caam.rice.edu/~heinken/latex/symbols.pdf}
% ^^A http://mirrors.ctan.org/macros/unicodetex/latex/unicode-math/unimath-symbols.pdf
% 模板使用 \pkg{unicode-math} 宏包配置数学字体，该方案目前不兼容
% 传统的 \pkg{amsfonts}、\pkg{amssymb}、\pkg{bm}
% \footnote{\url{https://tex.stackexchange.com/q/528831/}}
% 、\pkg{upgreek} 等宏包。需要使用新方案提供的相应命令。
% 例如，加粗数学符号的命令为 \tn{symbf}。
% 更多细节请查阅 \pkg{unicode-math} 手册。
%
% 如果您对此并不熟悉，也可以通过第 \ref{subsubsec:optional-pkg}
% 节提供的选项禁用该宏包。\footnote{禁用后本节提供的设置均不会生效。}
%
% 中文论文的数学符号默认遵循 GB/T 3102--93《物理科学和技术中
% 使用的数学符号》\cite{gb-3102-93}，该标准参照采纳 ISO 31-11:1992，
% \footnote{目前已更新为 ISO 80000-2:2019。}，
% 但是与 \TeX{} 默认的美国数学学会（AMS）的习惯有许多差异。
%
% \begin{function}[added=2022-07-31]{math/style}
%   \begin{syntax}
%     \OPT{style} = <TeX|ISO|(GB)>
%   \end{syntax}
% 数学符号风格。
% \end{function}
%
% 默认的国标风格 \opt{GB} 相当于在导言区设置了
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]math},
%   emph={[3]integral,integral-limits,less-than-or-equal,
%   math-ellipsis,partial,real-part,vector,uppercase-greek}]
%   \njusetup[math]{
%       integral           = upright,
%       integral-limits    = false,
%       less-than-or-equal = slanted,
%       math-ellipsis      = centered,
%       partial            = upright,
%       real-part          = roman,
%       vector             = boldfont,
%       uppercase-greek    = italic
%   }
% \end{latexexample}
%
% 用户也可以逐项修改数学样式。
%
% \begin{function}[added=2022-07-31]{math/integral}
%   \begin{syntax}
%     \OPT{integral} = <upright|slanted>
%   \end{syntax}
% 积分号的正/斜体。
% 该选项需要字体的支持，目前仅限 \opt{xits}、\opt{newcm}。
% \end{function}
%
% \begin{function}[added=2022-07-31]{math/integral-limits}
%   \begin{syntax}
%     \OPT{integral-limits} = <\TF>
%   \end{syntax}
% 积分号上下限的位置，可选：\opt{true}（在上下）、\opt{false}（在右侧）。
% 这个设置只影响行间公式，行内公式统一居右侧，不受影响。
% \end{function}
%
% \begin{function}[added=2022-07-31]{math/less-than-or-equal}
%   \begin{syntax}
%     \OPT{less-than-or-equal} = <slanted|horizontal>
%   \end{syntax}
% 小于等于号和大于等于号的字形。
% 这将控制 \tn{le}、\tn{ge}、\tn{leq} 和 \tn{geq} 的符号是
% “$\leqslant$、$\geqslant$”还是“$\leq$、$\geq$”。
% \end{function}
%
% \begin{function}[added=2022-07-31]{math/math-ellipsis}
%   \begin{syntax}
%     \OPT{math-ellipsis} = <centered|lower>
%   \end{syntax}
% 省略号 \tn{dots} 的样式，可选：\opt{centered}（按照中文的习惯固定居中）、
% \opt{lower}（取决于前后符号的位置）。
% 其他的省略号命令如 \tn{lots}、\tn{cdots} 则不受影响。
% \end{function}
%
% \begin{function}[added=2022-07-31]{math/partial}
%   \begin{syntax}
%     \OPT{partial} = <upright|italic>
%   \end{syntax}
% 偏微分符号的正/斜体。
% \end{function}
%
% \begin{function}[added=2022-07-31]{math/real-part}
%   \begin{syntax}
%     \OPT{real-part} = <roman|fraktur>
%   \end{syntax}
% 实部 \tn{Re} 和虚部 \tn{Im} 的字体。
% \end{function}
%
% \begin{function}[added=2022-07-31]{math/vector}
%   \begin{syntax}
%     \OPT{vector} = <boldfont|arrow>
%   \end{syntax}
% 向量的表示方法，可选粗斜体或箭头。
% \end{function}
%
% \begin{function}[added=2022-07-31]{math/uppercase-greek}
%   \begin{syntax}
%     \OPT{uppercase-greek} = <upright|italic>
%   \end{syntax}
% 大写希腊字母的正/斜体。
% 有限增量符号 $\increment x$ 固定使用正体，推荐使用 \tn{increment} 表示。
% \end{function}
%
% 本模板的设置并不能覆盖所有符号，一些需要写作时手动处理的要点包括：
% \begin{itemize}
%   \item 数学常数和特殊函数名用正体，如
%   \begin{itemize}
%     \item $\uppi$ 使用 |$\uppi$|
%     \item $\symup{i}$ 使用 |$\symup{i}$|
%     \item $\symup{e}$ 使用 |$\symup{e}$|
%   \end{itemize}
%   \item 微分号使用正体，如
%   \begin{itemize}
%     \item $\mathrm{d} \varphi / \mathrm{d} t$
%           使用 |$\mathrm{d} \varphi / \mathrm{d} t$|
%   \end{itemize}
% \end{itemize}
%
% \subsubsection{定理环境}
%
% 模板使用 \pkg{ntheorem} 宏包配置定理类环境，提供了一系列选项。
% 您也可以通过第 \ref{subsubsec:optional-pkg} 节提供的选项禁用该宏包。
% \footnote{禁用后本节提供的设置均不会生效。}
%
% 以下选项用于定义定理类环境的样式。
%
% \begin{function}[added=2022-04-21]{theorem/style}
%   \begin{syntax}
%     \OPT{style} = <(plain)|break|change|margin|empty|...>
%   \end{syntax}
% 定理基本样式。等效于 \tn{theoremstyle}\marg{样式名称}。
% \end{function}
%
% \begin{function}[added=2022-04-21]{theorem/header-font}
%   \begin{syntax}
%     \OPT{header-font} = \meta{头部字体格式}
%   \end{syntax}
% 定理头部字体格式。等效于 \tn{theoremheaderfont}\marg{格式}。
% \end{function}
%
% \begin{function}[added=2022-04-21]{theorem/body-font}
%   \begin{syntax}
%     \OPT{body-font} = \meta{内部字体格式}
%   \end{syntax}
% 定理内部字体格式。等效于 \tn{theorembodyfont}\marg{格式}。
% \end{function}
%
% \begin{function}[added=2022-04-21]{theorem/qed-symbol}
%   \begin{syntax}
%     \OPT{qed-symbol} = \meta{证毕符号}
%   \end{syntax}
% 证毕符号。等效于 \tn{theoremsymbol}\marg{符号}。默认为空心方块（\mdlgwhtsquare）。
% 禁用 \pkg{unicode-math} 时为实心黑色方块（\rule{1ex}{1ex}）。
% \end{function}
%
% \begin{function}[added=2022-04-21]{theorem/counter}
%   \begin{syntax}
%     \OPT{counter} = <part|(chapter)|section|...>
%   \end{syntax}
% 定理计数器范围。
% \end{function}
%
% \begin{function}[added=2023-05-07]{theorem/share-counter}
%   \begin{syntax}
%     \OPT{share-counter} = <\TFF>
%   \end{syntax}
% 是否共享计数器。
% \end{function}
%
% 模板的默认设置等效于
%
% \begin{latexexample}[moretexcs={\njusetup,\bfseries,\itshape,\mdlgwhtsquare},
%   emph={[2]theorem},emph={[3]style,header-font,body-font,qed-symbol,counter}]
%   \njusetup[theorem]{
%       style         = plain,
%       header-font   = \normalfont \bfseries ,
%       body-font     = \itshape ,
%       qed-symbol    = \ensuremath { \mdlgwhtsquare },
%       counter       = chapter,
%       share-counter = false
%   }
% \end{latexexample}
%
% 以下选项用于创建定理类环境。
%
% \begin{function}[added=2022-08-05]{theorem/type}
%   \begin{syntax}
%     \OPT{type} = \{\marg{环境名,类型标识} \marg{头名称},...\}
%   \end{syntax}
% 需要定义的定理类型列表。在可选的 \meta{类型标识} 中，含有\emph{星号}表示
% 需要编号，含有\emph{加号}需要证毕符号。该选项存储的是用来定义环境的参数，
% 而\emph{不会直接创建环境}，且每次调用都会覆盖前面定义的环境列表。
% \end{function}
%
% \opt{theorem/type} 初始定义的环境列表如表~\ref{tab:mathenv} 所示。
% 这些环境并没有预先创建，使用方法见下面的例子。
%
% \begin{table}[htbp]
%   \centering
%   \begin{talltblr} [
%       caption = {预置的数学定理环境},
%       label   = {tab:mathenv},
%       note{a} = {证明环境较为特殊，不编号且会在结尾添加证毕符号。} ]
%     { colspec = {cc|cc} }
%     \toprule
%       标签       & 名称     & 标签       & 名称     \\
%     \midrule
%       axiom      & 公理     & lemma      & 引理     \\
%       corollary  & 推论     & proof \TA  & 证明     \\
%       definition & 定义     & theorem    & 定理     \\
%       example    & 例       &            &          \\
%     \bottomrule
%   \end{talltblr}
% \end{table}
%
% \begin{function}[added=2022-08-05]{theorem/define}
%   \begin{syntax}
%      <\OPT{define}>
%   \end{syntax}
% 创建定理环境。
% \end{function}
%
% \opt{theorem/define} 并没有参数。这个选项在调用后会读取
% \opt{theorem/type} 保存的列表以及前方的样式设置并创建相应环境。
% 这也就意味着该选项在 \opt{theorem/type} 为空时会报错。
%
% 在下面这个例子中，我们先创建了预置的七种环境。除了无编号的
% \env{proof}，其余六种共用一个计数器。随后我们将定理内部文字字体改为
% 宋体，定义了 \env{exercise} 和 \env{solution} 两种定理环境，后者没有编号。
%
% \begin{latexexample}[moretexcs={\njusetup,\normalfont},
%   emph={[2]theorem},emph={[3]define,body-font,type}]
%   \njusetup[theorem]{
%       share-counter = true ,
%       define ,
%       body-font   = \normalfont ,
%       type        = {
%           { {exercise} {习题} },
%           { {solution,*} {解} }
%       },
%       define
%   }
% \end{latexexample}
%
%
% \subsubsection{编号}
%
% \begin{function}[added=2022-07-31]{label-sep/figure,label-sep/table,label-sep/equation}
%   \begin{syntax}
%     \OPT{figure}   = \meta{符号}
%     \OPT{table}    = \meta{符号}
%     \OPT{equation} = \meta{符号}
%   \end{syntax}
% 图片、表格、公式编号中的连接符样式，默认为短横线（en dash）。
% \end{function}
%
%
% \subsection{参考文献}
%
% 本模板默认载入 \pkg{biblatex} 宏包，使用 \hologo{biber} 作为后端，
% 通过 \pkg{biblatex-gb7714-2015}\cite{biblatex-gb7714-2015} 实现
% GB/T 7714--2015 \cite{gb-t-7714-2015} 规定的参考文献著录规则国家标准。
% 需要使用 |biber| 命令编译才会显示正确的条目序号，详情请参照第
% \ref{subsubsec:compileseq} 节。本节提供的所有选项均基于此方案。
%
% 出于简化命令的考虑，本模板并不计划支持 \hologo{BibTeX}，但您可以通过第
% \ref{subsubsec:optional-pkg} 节提供的选项禁用默认的参考文献工具，
% 自行利用 \pkg{gbt7714} 等宏包完成参考文献样式的配置。
%
% \subsubsection{选项}
%
% \begin{function}[added=2021-12-19]{bib/style}
%   \begin{syntax}
%     \OPT{style} = <(numeric)|author-year|\meta{自定义样式}>
%   \end{syntax}
% 参考文献样式。可选顺序编码制 \opt{numeric} 和著者-出版年制 \opt{author-year}，
% 或自行填入任意其他 \pkg{biblatex} 样式。默认为顺序编码制。
% \end{function}
%
% 参考文献样式是一个整体的设置，会对正文中引用的文献的标注方法和
% 参考文献表的输出格式产生影响。根据国家规定\cite{gb-t-7714-2015}，
% 可以按照参考文献表的组织方式分为以下两种样式：
% \begin{description}
%   \item[顺序编码制] 顺序编码制是按正文中引用的文献出现的先后顺序连续
%                     编码，将序号置于方括号中。参考文献表采用顺序编码
%                     制组织时，各篇文献应按正文部分标注的序号依次列出。
%   \item[著者-出版年制] 正文引用的文献采用著者-出版年制时，各篇文献的
%                        标注内容由著者姓氏与出版年构成，并置于"()"内。
%                        参考文献表采用著者-出版年制组织时，各篇文献首
%                        先按文种集中，然后按著者字顺和出版年排列。
% \end{description}
%
% 对于本科生而言，学校规定文件表明参考文献表应当“用数字加方括号
% 表示”\cite{nju-bachelor-2023}，符合顺序编码制的格式，保持默认设置即可。
%
% \begin{function}[added=2022-02-15]{bib/option}
%   \begin{syntax}
%     \OPT{option} = \meta{选项列表}
%   \end{syntax}
% 待传入 \pkg{biblatex} 宏包的额外选项列表。
% \end{function}
%
% 本模板中 \pkg{biblatex} 并不是显式载入的。
% 如需在其基础上进行一些定制，可使用本设置项载入宏包选项\cite{biblatex}。
%
% \begin{function}[added=2021-12-19]{bib/resource}
%   \begin{syntax}
%     \OPT{resource} = \Arg{文件}
%   \end{syntax}
% 参考文献数据源。类似于 \tn{addbibresource} 命令，但可以使用逗号分隔的
% 列表形式。必须使用带扩展名（\file{.bib}）的完整文件名。
% \end{function}
%
% \begin{function}{\addbibresource}
%   \begin{syntax}
%     \tn{addbibresource}\Arg{文件}
%   \end{syntax}
% 添加参考文献源文件。为了与 \pkg{biblatex} 进行兼容，也可使用本命令
% 添加数据源。本命令不支持逗号分隔多个文件的形式，如果希望额外添加参
% 考文献列表，需要在导言区中多次调用。
% \end{function}
%
% 可以参考如下范例进行参考文献设置。
% 其中 \opt{bib/option} 的内容旨在关闭部分不需显示的文献信息，
% 并采取仅首字母大写的作者姓名格式，可根据需要使用。
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]bib},
%   emph={[3]style,resource,option}]
%   \njusetup[bib]{
%       style    = author-year,
%       resource = {njuthesis-sample.bib}，
%       option   = {
%           doi       = false,
%           isbn      = false,
%           url       = false,
%           eprint    = false,
%           gbnamefmt = lowercase
%       }
%   }
% \end{latexexample}
%
%
% \subsubsection{参考文献表}
%
% \begin{function}{\printbibliography}
% 生成参考文献表。
% \end{function}
%
% 显然只有被引用过的条目才会被输出至参考文献表。
%
% 假如需要在每章末尾附上单独的参考文献表，导言区添加以下设置，
% 并在每章后使用 \tn{printbibliography} 即可。
% \begin{latexexample}[moretexcs={\njusetup},emph={[2]bib},emph={[3]option}]
%   \njusetup[bib/option]{refsection = chapter}
% \end{latexexample}
%
% 如果开启了草稿模式，您可能会注意到部分条目存在超宽的问题。对此，
% 需要将 \pkg{biblatex-gb7714-2015} 宏包手动更新至 2022-04-16 以后的版本。
% 此外，由于 \TeX{} 预置的断词位置是有限的，不能覆盖学术上使用的复杂词汇，
% 您也可以自行在 \file{.bib} 文件中设置断行点，例如可以将 graphene
% 一词修改为 graph|\-|ene。
%
% \subsubsection{正文引用}
%
% \begin{function}{\cite}
%   \begin{syntax}
%     \tn{cite}\marg{文献}
%     \tn{cite}\oarg{页码}\marg{文献}
%   \end{syntax}
% 在正文中引用参考文献。
% \end{function}
%
% 引用命令 \tn{cite} 含有多个变体，以便使用文献条目中不同的信息域。
% 在两种参考文献样式下，这些命令的行为具体存在一些差异，
% 详见表 \ref{tab:numeric-style} 和表 \ref{tab:author-year-style}。
%
% \begin{table}[ht]
%   \centering
%   \begin{talltblr} [
%       caption = {顺序编码制下的引用样式},
%       label   = {tab:numeric-style} ]
%     { colspec = {cll} }
%     \toprule
%       引用方式 & 命令               &  排版效果                  \\
%     \midrule
%       单篇文献 & \tn{cite}          & 上标可设置页码             \\
%       单篇文献 & \tn{parencite}     & 非上标可设置页码           \\
%       多篇文献 & \tn{cite}          & 上标，逗号隔开或短横线连接 \\
%       标注页码 & \tn{pagescite}     & 上标加自动页码             \\
%       标注作者 & \tn{textcite}      & 作者为主语加非上标编号     \\
%       标注作者 & \tn{authornumcite} & 作者为主语加上标编号       \\
%       完整脚注 & \tn{footfullcite}  & 脚注方式                   \\
%     \bottomrule
%   \end{talltblr}
% \end{table}
%
% \begin{table}[ht]
%   \centering
%   \begin{talltblr} [
%       caption = {著者-出版年制下的引用样式},
%       label   = {tab:author-year-style},
%       note{a} = {在此样式下 \tn{parencite} 效果等同于 \tn{cite}。} ]
%     { colspec = {cll} }
%     \toprule
%       引用方式       & 命令               & 排版效果                       \\
%     \midrule
%       单篇文献       & \tn{cite} \TA      & 作者加年份用括号包围可设置页码 \\
%       多篇文献       & \tn{cite}          & 分号隔开                       \\
%       标注页码       & \tn{pagescite}     & 作者加年份用括号包围自动页码   \\
%       标注年份       & \tn{yearcite}      & 用括号包围的年份               \\
%       标注年份、页码 & \tn{yearpagescite} & 提供年份用括号包围自动页码     \\
%       标注作者       & \tn{textcite}      & 作者为主语加加括号包围年份     \\
%       完整脚注       & \tn{footfullcite}  & 脚注方式                       \\
%     \bottomrule
%   \end{talltblr}
% \end{table}
%
%
% \subsubsection{文献管理}
%
% 参考文献数据源理应是通过文献管理软件导出的，而不是逐条手动填写的。
%
% \subparagraph{使用 EndNote}
%
% 南京大学信息化建设管理服务中心已购买
% \href{https://itsc.nju.edu.cn/EndNote/list.htm}{EndNote}
% 供全校师生免费使用，最新版为 EndNote 20。
%
% \subparagraph{使用 JabRef}
%
% \href{https://www.jabref.org/}{JabRef} 是一款开源、跨平台的文献管理软件。
% JabRef 提供了对 \hologo{BibTeX} 和 \pkg{biblatex} 的原生支持，
% 能够直接管理 \file{.bib} 文件， 还可以向 TeXstudio 等外部软件推送引用命令。
%
% \subparagraph{使用 Zotero}
%
% \href{https://www.zotero.org/}{Zotero} 也是一款开源、跨平台的文献管理软件。
% Zotero 更为通用，其功能可以通过 \href{https://github.com/l0o0/jasminum}{Jasminum}、
% \href{https://github.com/retorquere/zotero-better-bibtex}{Better BibTeX}、
% \href{https://github.com/bwiernik/zotero-shortdoi}{DOI Manager} 等第三方插件，
% 以及 Zotero Connector 浏览器插件进行增强。
%
%
% \subsection{特殊页面}
%
% 本模板也预定义了一系列用于生成所需的特殊页面的命令与环境。
%
%
% \subsubsection{封面}
%
% \begin{function}{\maketitle}
% 生成封面。
% \end{function}
%
% 本科生模板仅会生成中文封面；研究生模板会生成中英文封面。
% 如果选择了 \opt{nl-cover}，\emph{仅仅}会生成研究生的国家图书馆封面。
% 如果选择了 \opt{decl-page}，会在封面后生成本科生的诚信承诺书或研究生的
% 原创性声明。在启用草稿模式后封面绘制将被禁用。
%
% \paragraph{封面图片}
%
% \begin{function}[added=2021-12-23,updated=2022-08-06]{
%   image/nju-emblem,image/nju-name}
%   \begin{syntax}
%     \OPT{nju-emblem} = \Arg{文件}
%     \OPT{nju-name}   = \Arg{文件}
%   \end{syntax}
% 校名、校徽图片文件路径。
% \end{function}
%
% 通过以上选项可以使用外置的校徽和校名图片，两个选项\emph{任一留空}则不会生效。
% 本模板封面中校徽及校名的绘制默认依赖 \pkg{njuvisual} 宏包提供的 \tikzlogo
% 矢量曲线，耗时较长，在替换为外置图片后可节省约1秒的编译时长。
%
%
% \subsubsection{摘要页}
% \changes{v0.11}{2021/10/01}{简化了摘要的编写方式。}
%
% \DescribeEnv{abstract}
% \DescribeEnv{abstract*}
% 摘要。带星号的会生成英文摘要。
%
% \begin{latexexample}[emph={[1]abstract,abstract*}]
%   \begin{abstract}
%       我的中文摘要
%   \end{abstract}
%
%   \begin{abstract*}
%       Abstract in English
%   \end{abstract*}
% \end{latexexample}
%
% \begin{function}[added=2022-02-04,updated=2022-07-31]{abstract/toc-entry}
%   \begin{syntax}
%     \OPT{toc-entry} = <\TTF>
%   \end{syntax}
% 是否将摘要条目插入目录，默认开启。
% 关闭此选项后摘要页将不会出现在目录中，仅保留其 PDF 书签。
% \end{function}
%
% \begin{function}[added=2023-04-23]{abstract/underline}
%   \begin{syntax}
%     \OPT{underline} = <\TTF>
%   \end{syntax}
% 选择研究生英文摘要条目内容是否需要下划线。默认添加。
% \end{function}
%
% \begin{function}[added=2022-03-26,updated=2022-07-31]{abstract/title-style}
%   \begin{syntax}
%     \OPT{title-style} = <(strict)|centered|natural>
%   \end{syntax}
% 选择研究生摘要标题样式。
% 默认为严格模式（\opt{strict}），即完全模仿材料包要求。
% \end{function}
%
% 材料包中的 Word 空白模板仅有两行空白下划线。
% 根据填写习惯的不同，模板预置了三种样式：
% \begin{itemize}
%   \item \opt{strict}，在两行空白下划线上左对齐填写标题。
%         如果该标题不足一行，则第二行下划线留空；
%         如果长度超出两行，则向后延伸并抛出一个警告信息。
%   \item \opt{centered}，将严格模式的左对齐改为居中。
%   \item \opt{natural}，仅居中标题，不做行数检查。
%         本模式更适合较短的题目。
% \end{itemize}
%
% \subsubsection{前言页}
%
% \DescribeEnv{preface}
% 使用 \env{preface} 环境定义。
%
% \begin{latexexample}[emph={[1]preface,flushright}]
%   \begin{preface}
%       我的前言
%       \vspace{1cm}
%       \begin{flushright}
%       我的名字\\
%       时间地点
%       \end{flushright}
%   \end{preface}
% \end{latexexample}
%
%
% \subsubsection{目录页}
%
% \begin{function}{\tableofcontents,\listoffigures,\listoftables}
% 分别生成目录、图片目录和表格目录。
% \end{function}
%
% \begin{function}[added=2022-08-08]{tableofcontents/dotline}
%   \begin{syntax}
%     \OPT{dotline} = <chapter|(section)>
%   \end{syntax}
% 目录中的引导线设置。选择 \opt{chapter} 会为章标题后添加引导线。
% \end{function}
%
% \begin{function}[added=2022-02-04,updated=2022-07-31]{
%   tableofcontents/toc-entry,listoffigures/toc-entry,
%   listoftables/toc-entry}
%   \begin{syntax}
%     \OPT{toc-entry} = <\TTF>
%   \end{syntax}
% 是否在目录中显示目录自身的条目，默认开启。关闭后目录、
% 插图目录和表格目录将不会出现在目录中，仅保留其 PDF 书签。
% 注意，虽然名称一样，但这其实是对应三种目录的三个选项。
% \end{function}
%
% 如果仅需要禁用插图目录和表格目录的条目，可以这样设置
% \begin{latexexample}[moretexcs={\njusetup},emph={[3]toc-entry},
%   emph={[2]tableofcontents,listoffigures,listoftables}]
%   \njusetup{
%       tableofcontents/toc-entry = true, % 仅作展示，无需手动启用
%       listoffigures/toc-entry   = false,
%       listoftables/toc-entry    = false
%   }
% \end{latexexample}
%
% 目录页的标题名称一般无需修改\footnote{尽管根据《学位论文编写规则》国家标准
% \cite{gb-t-7713.1-2006}，学位论文中理应使用“目次”这一名称来指代篇目的列表，
% 我们仍然建议遵从学校给出的范例。}。如有需求，请参考 \ref{subsubsec:edit-text} 节。
%
% \subsubsection{符号表}
%
% \DescribeEnv{notation}
% \DescribeEnv{notation*}
% 符号表，或者称为术语表、缩略词对照表。带有星号的符号表环境不会插入目录。
% \begin{syntax}
%   \tn{begin}\{notation\}\oarg{说明宽度}\oarg{符号宽度}
%   \quad\tn{item}\oarg{符号} \meta{说明}
%   \tn{end}\{notation\}
% \end{syntax}
%
%
% \subsubsection{致谢页}
%
% \DescribeEnv{acknowledgement}
% 使用 \env{acknowledgement} 环境生成致谢页，附带有相应目录条目。
% 在开启盲审模式时，仅显示该目录条目。
%
% \begin{latexexample}[emph={[1]acknowledgement}]
%   \begin{acknowledgement}
%       感谢NJU LUG
%   \end{acknowledgement}
% \end{latexexample}
%
%
% \subsubsection{附录页}
%
% \begin{function}{\appendix}
% 附录放在本命令后，以英文字母进行编号，编写方式同正文。
% \end{function}
%
%
% \subsubsection{成果列表}
%
% \begin{function}[added=2021-09-29,updated=2021-12-20]{\njupaperlist}
%   \begin{syntax}
%     \tn{njupaperlist}\oarg{标题}\marg{文献}
%   \end{syntax}
% 成果列表，生成一个列举文献条目的无编号节。可选参数为标题，
% 默认为“发表文章目录”。\Arg{文献} 的填写方式同 \tn{cite}，
% 多个文献需要使用英文半角逗号隔开。
% \end{function}
%
% 一个简单的例子如下所示：
% \begin{latexexample}[moretexcs={\njuchapter,\njupaperlist}]
%   \njuchapter{攻读博士学位期间研究成果}
%   \njupaperlist[攻读博士学位期间发表的学术论文]{
%     Nemec1997-209-214,Chiani1998-2998-3008,Chiani1998a}
% \end{latexexample}
%
% 为了便于识别，成果列表中默认对发表年份进行加粗处理。而对作者姓名的处理较为复杂。
% 利用 \pkg{biblatex} 的数据注解机制可以实现对特定文献信息的样式修改
% \footnote{\url{https://blog.csdn.net/xenonhu/article/details/120853247}}，
% 在此可以用来实现指定作者姓名的突出。经过注解后的一则参考文献条目如下所示：
% \begin{latexexample}[emph={[1]@inproceedings},emph={[2]author}]
%   @inproceedings{Nemec1997-209-214,
%     title = {Force control of redundant robots},
%     author = {B Nemec and Zhao, Mou Mou},
%     author+an = {2=thesisauthor},
%     booktitle = {Processings of Symposium on Robot Control},
%     shortbooktitle = {(PSRC)},
%     pages = {209-214},
%     country = {Nantes France},
%     year = {1997}
%   }
% \end{latexexample}
% 其中 |author+an| 提供了注解的标记，格式为 \meta{序号}|=|\meta{标签}，
% 以上条目中即是将第二名作者加入了指定论文作者的注解。\tn{njupaperlist}
% 会识别 |thesisauthor| 标签，为其指代的作者姓名进行加粗下划线处理。
%
% 除手动进行标记以外，以下也提供一种自动化处理办法。
% 下载 \href{https://github.com/hushidong/biblatex-map}{bibmap}
% 全部文件后，修改主目录下的 \file{bibmapaddauthoran.py} 中 |fieldsource|
% 为需要匹配的姓名，将需要进行标记的 \file{.bib} 文件拷贝至本目录
% （此处使用 \file{test.bib} 进行示范），运行以下命令生成的参考文献数据源
% 即可被成果列表识别加粗。
%
% \begin{shellexample}[morekeywords={python},deletekeywords={test}]
%   python bibmap.py test.bib -m bibmapaddauthoran.py
% \end{shellexample}
%
%
% \subsection{额外定制}
%
% 在研究生院松散的规定下，本模板仅能提供一个大体适用的框架，
% 势必需要为用户修改留出空间。这一节将提供一些定制方法。
%
% \subsubsection{固定文本}
% \label{subsubsec:edit-text}
%
% \begin{function}{\njusetname,\njusetname*,\njusettext,\njusettext*}
%   \begin{syntax}
%     \tn{njusetname}\marg{名称}\oarg{变体}\marg{内容}
%     \tn{njusetname*}\marg{名称}\oarg{变体}\marg{内容}
%     \tn{njusettext}\marg{名称}\oarg{变体}\marg{内容}
%     \tn{njusettext*}\marg{名称}\oarg{变体}\marg{内容}
%   \end{syntax}
% 修改固定文本内容，带星号的命令表示修改对应的英文字段。
% 名称对应的默认内容可以参见 \ref{subsubsec:constant-name} 与
% \ref{subsubsec:constant-text} 节。
% \end{function}
%
% 譬如，修改目录标题名称，示例如下：

% \begin{latexexample}[moretexcs={\njusetname}]
%   \njusetname{listoffigures}{插图清单}
%   \njusetname{listoftables}{表格清单}
% \end{latexexample}
%
% 将英文摘要页的小标题修改为仅首字母大写的样式，示例如下：
%
% \begin{latexexample}[moretexcs={\njusetname*}]
%   \njusetname*{abstract}[b]{Abstract}
% \end{latexexample}
%
% \subsubsection{长度值}
% \label{subsubsec:modify-length}
%
% \begin{function}{\njusetlength,\njusetlength*}
%   \begin{syntax}
%     \tn{njusetlength}\marg{名称}\marg{长度}
%     \tn{njusetlength*}\marg{名称}\marg{长度}
%   \end{syntax}
% 修改长度值，默认为修改固定长度（|dim| 类型），
% 带星号的命令表示修改弹性长度（|skip| 类型，目前未涉及）。
% 默认长度值可以参见 \ref{subsubsec:constant-length} 节。
% \end{function}
%
% 譬如，将封面页填写个人信息的横线加长，示例如下：
%
% \begin{latexexample}[moretexcs={\njusetlength}]
%   \njusetlength{crulewd}{330pt}
% \end{latexexample}
%
% \subsubsection{样式}
% \label{subsubsec:modify-format}
%
% \begin{function}{\njusetformat}
%   \begin{syntax}
%     \tn{njusetformat}\marg{名称}\marg{样式}
%   \end{syntax}
% 修改样式。所有可以修改的默认样式参见 \ref{subsubsec:constant-format} 节。
% \end{function}
%
% 譬如，将章标题字号加大到小二号，示例如下：
%
% \begin{latexexample}[moretexcs={\njusetformat,\zihao}]
%   \njusetformat{chapter}{\zihao{-2}\sffamily\centering}
% \end{latexexample}
%
% 修改表格内容的字体：
%
% \begin{latexexample}[moretexcs={\njusetformat,\zihao,\bfseries}]
%   \njusetformat{tabular}{\zihao{-4}\bfseries}
% \end{latexexample}
%
%
% \subsection{视觉识别系统}
%
% 视觉识别系统 \pkg{njuvisual} 现已被分离为独立宏包\cite{njuvisual}，
% 基本使用方法举例如下：
% \begin{latexexample}[moretexcs={\njuemblem,\njuname,\njuname*}]
%   \njuemblem{!}{3cm}                           % 生成高 3cm 的紫色校徽
%   \njuname{4cm}{!}                             % 生成宽 4cm 的紫色中文校名
%   \njuname*{4cm}{!}                            % 生成宽 4cm 的紫色英文校名
%   \njuemblem[black]{!}{3cm}                    % 黑色的校徽
%   \njuemblem[department=dii]{!}{4cm}           % 紫色匡院徽标
%   \njuemblem[department=cs,color=blue]{!}{3cm} % 纯蓝色计科徽标
% \end{latexexample}
%
% 本宏包的详细使用方法请参考其使用手册。
%
%
% \section{宏包依赖}
%
% 在任何情况下，本模板都会\emph{显式}调用以下宏包（或文档类）：
% \begin{itemize}
%   \item \pkg{xtemplate} 和 \pkg{l3keys2e}，用于扩展 \LaTeX3 编程环境。
%         它们属于 \pkg{l3packages} 宏集。
%   \item \cls{ctexbook}，提供中文排版的通用框架。属于 C\TeX
%         宏集 \cite{CTeX}。
%   \item \pkg{amsmath}，对 \LaTeX{} 的数学排版功能进行了全面扩展。
%         属于 \hologo{AmSLaTeX} 套件。
%   \item \pkg{geometry}，用于调整页面尺寸。
%   \item \pkg{setspace}，调整行距。
%   \item \pkg{fancyhdr}，处理页眉页脚。
%   \item \pkg{graphicx}，提供图形插入的接口。
%   \item \pkg{booktabs}，绘制三线表。
%   \item \pkg{caption}，用于设置题注。
%   \item \pkg{hyperref}，提供交叉引用、超链接、电子书签等功能。
% \end{itemize}
%
% 以下宏包可以在文档类选项中禁用：
% \begin{itemize}
%   \item \pkg{ntheorem}，提供定理类环境支持。
%   \item \pkg{unicode-math}，负责处理 Unicode 编码的 OpenType 数学字体。
%   \item \pkg{footmisc}，处理脚注。
%   \item \pkg{enumitem}，调整列表环境。
%   \item \pkg{cleveref}，用于自动生成引用标签。
%   \item \pkg{biblatex} 和 \pkg{biblatex-gb7714-2015}，用于生成国标下的参考文献样式。
% \end{itemize}
%
% 在开启某些选项时，本模板也会调用以下宏包：
% \begin{itemize}
%   \item \pkg{fandol}、\pkg{tex-gyre}、\pkg{tex-gyre-math}、\pkg{xits} 等，
%         提供自由字体。
%   \item \pkg{emptypage}，在双面模式下清空空白页的页眉、页脚和页码。
%   \item \pkg{circledtext} 和 \pkg{l3experimental}，用于在 \opt{footnote/circled}
%         和 \opt{footnote/circled*} 选项下生成脚注圈码。
%   \item \pkg{pifont}，用于在 \opt{footnote/pifont} 选项下生成脚注圈码。
%   \item \pkg{tikz} 和 \pkg{njuvisual}，用于绘制封面的校名校徽。
%   \item \pkg{tabularray}，用于绘制研究生的出版授权书信息表格。
%   \item \pkg{xeCJKfntef} 或 \pkg{lua-ul}，用于在对应引擎下绘制下划线。
% \end{itemize}
%
% 下列宏包会与本模板的默认配置产生冲突，或者不能发挥预期作用：
% \begin{itemize}
%   \item \pkg{natbib} 和 \pkg{gbt7714} 等 \hologo{BibTeX} 相关的参考文献宏包。
%   \item \pkg{bm} 等使用传统数学字体配置方案的宏包。
%   \item \pkg{babel} 在直接使用时会覆盖默认的中文名称设置。
%   \item \pkg{microtype} 在 \XeTeX 和 \LuaTeX 下支持有限。
% \end{itemize}
%
%
% \begin{thebibliography}{99}
%
% \newcommand\urlprefix{\newline\hspace*{\fill}}
% \let\OldUrl=\url
% \renewcommand\url[2][]{{\small\textit{#1}~\OldUrl{#2}}}
% \newcommand\CTANurl[2][]{{^^A
%   \small\textit{#1}~\href{http://mirror.ctan.org/#2}{\texttt{CTAN://#2}}}}
%
% \subsection*{书籍}
%
% \bibitem{lshort}
% \textsc{Oetiker T}, \textsc{Partl H}, \textsc{Hyna I}, et al.
% \newblock \textit{The Not So Short Introduction to \hologo{LaTeXe}: Or \hologo{LaTeXe} in 139 minutes} [EB/OL].
% \newblock version 6.4,
% \newblock (2021-03-09)
% \urlprefix\url{https://ctan.org/pkg/lshort-english}
% \urlprefix\CTANurl[文档：]{info/lshort/english/lshort.pdf}
%
% \bibitem{lshort-zh-cn}
% \textsc{Oetiker T}, \textsc{Partl H}, \textsc{Hyna I}, et al.
% \newblock \textit{一份（不太）简短的 \hologo{LaTeXe} 介绍: 或 111 分钟了解 \hologo{LaTeXe}} [EB/OL].
% \newblock \CTeX{} 开发小组, 译.
% \newblock 原版版本 version 6.4, 中文版本 version 6.03,
% \newblock (2021-11-21)
% \urlprefix\url{https://ctan.org/pkg/lshort-zh-cn}
% \urlprefix\CTANurl[文档：]{info/lshort/chinese/lshort-zh-cn.pdf}
%
% \bibitem{install-latex-guide-zh-cn}
% 王然.
% \newblock \textit{一份简短的关于 \LaTeX 安装的介绍} [EB/OL].
% \newblock version 2022.10.1,
% \newblock (2022-10-01)
% \urlprefix\url{https://ctan.org/pkg/install-latex-guide-zh-cn}
% \urlprefix\CTANurl[文档：]{info/install-latex-guide-zh-cn/install-latex-guide-zh-cn.pdf}
%
% \bibitem{刘海洋2013latex入门}
% 刘海洋.
% \newblock \textit{\LaTeX 入门} [M].
% \newblock 北京: 电子工业出版社, 2013
%
%
% \subsection*{标准、规范}
%
% \bibitem{gb-3100-93}
% 全国信息与文献标准化技术委员会.
% \newblock \textit{国际单位制及其应用: GB 3100--93} [S].
% \newblock 北京: 中国标准出版社, 1993
%
% \bibitem{gb-3101-93}
% 全国信息与文献标准化技术委员会.
% \newblock \textit{有关量、单位和符号的一般原则: GB 3101--93} [S].
% \newblock 北京: 中国标准出版社, 1993
%
% \bibitem{gb-3102-93}
% 全国信息与文献标准化技术委员会.
% \newblock \textit{物理科学和技术中使用的数学符号: GB/T 3102--93} [S].
% \newblock 北京: 中国标准出版社, 1993
%
% \bibitem{gb-t-7408-2005}
% 全国信息与文献标准化技术委员会.
% \newblock \textit{数据元和交换格式\quad 信息交换~ 日期和时间表示法: GB/T 7408--2005} [S].
% \newblock 北京: 中国标准出版社, 2005
%
% \bibitem{gb-t-7713.1-2006}
% 全国信息与文献标准化技术委员会.
% \newblock \textit{学位论文编写规则: GB/T 7713.1--2006} [S].
% \newblock 北京: 中国标准出版社, 2006
%
% \bibitem{gb-t-7714-2015}
% 全国信息与文献标准化技术委员会.
% \newblock \textit{信息与文献\quad 参考文献著录规则: GB/T 7714--2015} [S].
% \newblock 北京: 中国标准出版社, 2015
%
% \bibitem{nju-bachelor-2024}
% 南京大学本科生院.
% \newblock \textit{关于启动南京大学2024届本科毕业论文（设计）工作的通知} [EB/OL].
% \newblock (2023-12-19)
% \urlprefix\url{https://jw.nju.edu.cn/db/23/c26263a645923/page.htm}
%
% \bibitem{nju-graduate-2023}
% 南京大学研究生院.
% \newblock \textit{关于开展六月份学位申请、审核工作的通知} [EB/OL].
% \newblock (2023-04-26)
% \urlprefix\url{https://grawww.nju.edu.cn/63/a9/c905a615337/page.htm}
%
% \bibitem{nju-postdoc-2022}
% 南京大学人力资源处.
% \newblock \textit{博士后出站申请} [EB/OL].
% \newblock (2022-07-27)
% \urlprefix\url{https://hr.nju.edu.cn/6334/list.htm}
%
%
% \subsection*{宏包}
%
% \bibitem{biblatex}
% \textsc{Lehman P}, \textsc{Wright J}, \textsc{Boruvka A}, \textsc{Kime P}.
% \newblock \textit{Sophisticated Bibliographies in \LaTeX} [EB/OL].
% \newblock version 3.17,
% \newblock (2022-02-02)
% \urlprefix\url{https://ctan.org/pkg/biblatex}
% \urlprefix\CTANurl[文档：]{macros/latex/contrib/biblatex/doc/biblatex.pdf}
%
% \bibitem{biblatex-gb7714-2015}
% 胡振震.
% \newblock \textit{符合 GB/T 7714-2015 标准的 biblatex 参考文献样式} [EB/OL].
% \newblock version 1.1j,
% \newblock (2022-08-29)
% \urlprefix\url{https://ctan.org/pkg/biblatex-gb7714-2015}
% \urlprefix\CTANurl[文档：]{biblatex-contrib/biblatex-gb7714-2015/biblatex-gb7714-2015.pdf}
%
% \bibitem{CTeX}
% \textsc{CTEX.ORG}.
% \newblock \textit{\CTeX{} 宏集手册} [EB/OL].
% \newblock version 2.5.8,
% \newblock (2021-12-12)
% \urlprefix\url{https://ctan.org/pkg/ctex}
% \urlprefix\CTANurl[文档及源代码：]{language/chinese/ctex/ctex.pdf}
%
% \bibitem{circledtext}
% 耿楠.
% \newblock \textit{Create circled text} [EB/OL].
% \newblock version 1.1.0,
% \newblock (2022-04-28)
% \urlprefix\url{https://ctan.org/pkg/circledtext}
% \urlprefix\CTANurl[文档：]{macros/latex/contrib/circledtext/circledtext.pdf}
%
% \bibitem{latexmk}
% \textsc{Collins J}.
% \newblock \textit{Fully automated \LaTeX document generation} [EB/OL].
% \newblock version 4.76,
% \newblock (2021-11-20)
% \urlprefix\url{https://www.ctan.org/pkg/latexmk}
% \urlprefix\CTANurl[文档：]{support/latexmk/latexmk.pdf}
%
% \bibitem{listings}
% \textsc{Heinz C}, \textsc{Moses B}, \textsc{Hoffmann J}.
% \newblock \textit{Typeset source code listings using \LaTeX} [EB/OL].
% \newblock version 1.8d,
% \newblock (2020-03-24)
% \urlprefix\url{https://www.ctan.org/pkg/listings}
% \urlprefix\CTANurl[文档：]{macros/latex/contrib/listings/listings.pdf}
%
% \bibitem{njuvisual}
% \textsc{Xiong Y}.
% \newblock \textit{Display logos related to Nanjing University} [EB/OL].
% \newblock version 0.2.1,
% \newblock (2022-01-09)
% \urlprefix\url{https://ctan.org/pkg/njuvisual}
% \urlprefix\CTANurl[文档：]{macros/latex/contrib/njuvisual/njuvisual.pdf}
%
% \bibitem{pdfpages}
% \textsc{Matthias A}.
% \newblock \textit{Include PDF documents in \LaTeX} [EB/OL].
% \newblock version 0.5v,
% \newblock (2022-05-22)
% \urlprefix\url{https://www.ctan.org/pkg/pdfpages}
% \urlprefix\CTANurl[文档：]{macros/latex/contrib/pdfpages/pdfpages.pdf}
%
% \bibitem{siunitx}
% \textsc{Wright J}.
% \newblock \textit{A comprehensive (SI) units package} [EB/OL].
% \newblock version 3.1.0,
% \newblock (2022-04-25)
% \urlprefix\url{https://www.ctan.org/pkg/siunitx}
% \urlprefix\CTANurl[文档：]{macros/latex/contrib/siunitx/siunitx.pdf}
%
% \bibitem{tabularray}
% \textsc{Jianrui Lyu}.
% \newblock \textit{Typeset tabulars and arrays with \LaTeX3} [EB/OL].
% \newblock version 2021Q,
% \newblock (2021-12-01)
% \urlprefix\url{https://ctan.org/pkg/tabularray}
% \urlprefix\CTANurl[文档：]{macros/latex/contrib/tabularray/tabularray.pdf}
%
%
% \subsection*{模板}
%
% \bibitem{fduthesis}
% 曾祥东.
% \newblock \textit{fduthesis: 复旦大学论文模板} [EB/OL].
% \newblock version 0.7e,
% \newblock (2020-08-30)
% \urlprefix\url{https://ctan.org/pkg/fduthesis}
% \urlprefix\CTANurl[文档及源代码：]{macros/latex/contrib/fduthesis/fduthesis.pdf}
%
% \bibitem{thuthesis}
% 清华大学 TUNA 协会.
% \newblock \textit{\textsc{ThuThesis}：清华大学学位论文模板} [EB/OL].
% \newblock version 7.2.3,
% \newblock (2021-05-31)
% \urlprefix\url{https://ctan.org/pkg/thuthesis}
% \urlprefix\CTANurl[文档及源代码：]{macros/latex/contrib/thuthesis/thuthesis.pdf}
%
%
% \emph{以下模版现已停止更新。}
%
% \bibitem{wenboyang2013}
% 杨文博.
% \newblock \textit{南京大学学位论文 \LaTeX 模板} [EB/OL].
% \newblock (2018-06-23)
% \urlprefix\url{https://github.com/solrex/njuthesis}
%
% \bibitem{fireblue2013}
% \textsc{fireblue}.
% \newblock \textit{南京大学学位论文 \LaTeX 模板} [EB/OL].
% \newblock (2013-04-13)
% \urlprefix\url{https://github.com/fireblue/NJUThesis}
%
% \bibitem{wenhai-zheng2013}
% \textsc{wenhai-zheng}.
% \newblock \textit{南京大学本科毕业论文 \LaTeX 模板} [EB/OL].
% \newblock (2013-08-12)
% \urlprefix\url{https://github.com/wenhai-zheng/NJUThesis}
%
% \bibitem{zenglecao2013}
% 曹增乐.
% \newblock \textit{南京大学本科毕业论文（设计） \LaTeX 模板} [EB/OL].
% \newblock (2019-06-26)
% \urlprefix\url{https://github.com/ZLCao/NJUBachelor}
%
% \bibitem{haixinghu2013}
% 胡海星.
% \newblock \textit{南京大学学位论文 \XeLaTeX 模板} [EB/OL].
% \newblock (2018-08-08)
% \urlprefix\url{https://github.com/Haixing-Hu/nju-thesis}
%
% \bibitem{chuhengzhang2016}
% 张楚珩.
% \newblock \textit{南京大学本科生毕业论文 \LaTeX 模板} [EB/OL].
% \newblock (2016-06-01)
% \urlprefix\url{https://github.com/zhangchuheng123/NJUThesis}
%
% \bibitem{yanyanjiang2017}
% 蒋炎岩.
% \newblock \textit{南京大学山寨 \hologo{LyX} 研究生毕业论文模板} [EB/OL].
% \newblock (2019-01-16)
% \urlprefix\url{https://github.com/jiangyy/njuthesis}
%
% \bibitem{njuHan2018}
% \textsc{njuHan}.
% \newblock \textit{南京大学学位论文(本科/硕士/博士)，毕业论文 \LaTeX 模板} [EB/OL].
% \newblock (2021-06-15)
% \urlprefix\url{https://github.com/njuHan/njuthesis-nju-thesis-template}
%
% \bibitem{anyirao2018}
% 饶安逸.
% \newblock \textit{南京大学本科生毕业论文 \LaTeX 模板 2018 新版} [EB/OL].
% \newblock (2018-06-24)
% \urlprefix\url{https://github.com/AnyiRao/NJUThesis2018}
%
% \bibitem{yichenzhao2021}
% 赵懿晨.
% \newblock \textit{南京大学本科生毕业论文 \LaTeX 模板（2021版）} [EB/OL].
% \newblock (2021-09-23)
% \urlprefix\url{https://github.com/FengChendian/NJUThesis2021}
%
%
% \end{thebibliography}
%
%
% \end{documentation}
% \clearpage
%
% \begin{implementation}
%
% \section{代码实现}
% \changes{v0.10}{2021/09/26}{对代码实现部分进行了整理。}
%
% 本模板使用 \LaTeX3 语法编写，依赖 \pkg{expl3} 环境，
% 并需调用 \pkg{l3packages} 中的相关宏包。
%
% 以下代码中有一些形如\sgrd{class}的标记， 这是 \pkg{DocStrip} 中的
% “guard”，用来选择性地提取文件。“|*|”和“|/|”分别表示该部分的开始和结
% 束。不含“|*|”和“|/|”的 guard 出现在行号左侧，它们用来确定单独一行代
% 码的归属。这些 guard 的颜色不一，用以明确分类关系。
%
% 下文中，本科生模板配置对应\pgrd{u}，用于生成
% \file{njuthesis-undergraduate.def}；研究生模板配置对应\pgrd{g}，
% 用于生成 \file{njuthesis-graduate.def}；博士后模板配置对应\pgrd{p}，
% 用于生成 \file{njuthesis-postdoctoral.def}。
%
% 另有若干包含 \textsf{@@} 的 guard，用以表示名空间（模块）。
% 在删除注释生成格式文件时，源代码变量名称中的 \textsf{@@} 会被等号后的字段替换，
% 譬如在本模板主体部分中\grd{@@=nju}。
%
% \subsection{准备}
%
%    \begin{macrocode}
%<*class>
%<@@=nju>
%    \end{macrocode}
%
% \changes{v0.11}{2021/10/23}{添加了若干环境检查与警告信息。}
% \changes{v0.12}{2021/12/03}{放宽对于 \pkg{l3packages} 的版本要求。}
% 检查 \LaTeX3 编程环境。
%    \begin{macrocode}
\RequirePackage { xtemplate, l3keys2e }
\msg_new:nnn { njuthesis } { l3-too-old }
  {
    Package~ "#1"~ is~ too~ old. \\
    Please~ update~ an~ up-to-date~ version~ of~ the~
    bundles~ "l3kernel"~ and~ "l3packages"~ using~
    your~ TeX~ package~ manager~ or~ from~ CTAN.
  }
\clist_map_inline:nn { xtemplate, l3keys2e }
  {
    \@ifpackagelater {#1} { 2020/10/01 }
      { } { \msg_error:nnn { njuthesis } { l3-too-old } {#1} }
  }
%    \end{macrocode}
%
% \changes{v1.3}{2023/11/14}{兼容新版 \LaTeX3 的 |e| 型展开变化。}
% 兼容新版 L3 特性。另见 \url{https://github.com/CTeX-org/ctex-kit/pull/678}。
%    \begin{macrocode}
\@ifpackagelater { expl3 } { 2023/10/10 } { }
  {
    \cs_generate_variant:Nn \tl_set:Nn        { Ne }
    \cs_generate_variant:Nn \tl_const:Nn      { Ne }
    \cs_generate_variant:Nn \tl_gput_right:Nn { Ne }
  }
%    \end{macrocode}
%
% 目前 \cls{njuthesis} 仅支持 \XeTeX 和 \LuaTeX。
%    \begin{macrocode}
\msg_new:nnn { njuthesis } { unsupported-engine }
  {
    The~ njuthesis~ class~ requires~ either~
    XeTeX~ or~ LuaTeX. \\
    "#1"~ is~ not~ supported~ at~ present.~
    You~ must~ change~ your~ typesetting~ engine~
    to~ "xelatex"~ or~ "lualatex".
  }
\bool_lazy_or:nnF
  { \sys_if_engine_xetex_p:  }
  { \sys_if_engine_luatex_p: }
  { \msg_fatal:nne { njuthesis } { unsupported-engine } { \c_sys_engine_str } }
%    \end{macrocode}
%
%
% \subsection{定义变量}
%
% 本模板的变量名称通式为 \cs[no-index]{\meta{作用域}_@@_\meta{族}_\meta{描述}_\meta{类型}}
% （出现在源代码中）或 \cs[no-index,replace=false]{\meta{作用域}_@@_\meta{族}_\meta{描述}_\meta{类型}}
% （出现在文档中）。作用域为单个字母，|l| 代表局部变量，|g| 代表全局变量，|c| 代表常
% 量。最后一个下划线后的内容指示其类型，但引擎不会根据名称检查变量类型。
%
% \begin{variable}{
%   \l_@@_tmpa_box,\l_@@_tmpb_box,\l_@@_tmpc_box,\l_@@_tmp_clist,
%   \l_@@_tmpa_dim,\l_@@_tmpb_dim,\l_@@_tmpa_int,\l_@@_tmpb_int,
%   \l_@@_tmp_skip,\l_@@_tmpa_tl,\l_@@_tmpb_tl}
% 临时变量。
%    \begin{macrocode}
\box_new:N   \l_@@_tmpa_box
\box_new:N   \l_@@_tmpb_box
\box_new:N   \l_@@_tmpc_box
\clist_new:N \l_@@_tmp_clist
\dim_new:N   \l_@@_tmpa_dim
\dim_new:N   \l_@@_tmpb_dim
\int_new:N   \l_@@_tmpa_int
\int_new:N   \l_@@_tmpb_int
\skip_new:N  \l_@@_tmp_skip
\tl_new:N    \l_@@_tmpa_tl
\tl_new:N    \l_@@_tmpb_tl
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_info_type_int}
% 用于存储论文类型的变量。
%    \begin{macrocode}
\int_new:N \g_@@_info_type_int
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_opt_academic_bool}
% 用于判断学术型或专业型学位的变量。
%    \begin{macrocode}
\bool_new:N \g_@@_opt_academic_bool
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_opt_twoside_bool}
% 定义用于判断是否使用双面模式的变量，初始值为使用双面模式。
%    \begin{macrocode}
\bool_new:N       \g_@@_opt_twoside_bool
\bool_gset_true:N \g_@@_opt_twoside_bool
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_opt_supvii_bool}
% 定义用于判断是否有第二导师的变量。
%    \begin{macrocode}
\bool_new:N \g_@@_opt_supvii_bool
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{
%   \g_@@_info_supvfull_tl,
%   \g_@@_info_supvfull_en_tl}
% 用于存储导师姓名加职称的变量。
%    \begin{macrocode}
\tl_new:N \g_@@_info_supvfull_tl
\tl_new:N \g_@@_info_supvfull_en_tl
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{
%   \g_@@_info_major_tl,
%   \g_@@_info_majorc_tl}
% 用于存储专业名称的变量。
%    \begin{macrocode}
\tl_new:N \g_@@_info_major_tl
\tl_new:N \g_@@_info_majorc_tl
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{
%   \g_@@_font_set_tl,
%   \g_@@_font_latin_tl,
%   \g_@@_font_cjk_tl,
%   \g_@@_font_math_tl}
% 存储所使用字体名称的全局变量。
%    \begin{macrocode}
\tl_new:N \g_@@_font_set_tl
\tl_new:N \g_@@_font_latin_tl
\tl_new:N \g_@@_font_cjk_tl
\tl_new:N \g_@@_font_math_tl
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_font_path_tl}
% 存储字体路径的全局变量。
%    \begin{macrocode}
\tl_new:N \g_@@_font_path_tl
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_font_path_bool}
% 是否使用独立的字体文件。
%    \begin{macrocode}
\bool_new:N \g_@@_font_path_bool
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_config_tl}
% 保存配置文件名称。默认为空。
%    \begin{macrocode}
\tl_new:N \g_@@_config_tl
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\c_@@_name_today_tl}
% 编译当天日期，格式为 |yyyy-mm-dd|。
%    \begin{macrocode}
\tl_const:Ne \c_@@_name_today_tl
  {
    \int_to_arabic:n { \c_sys_year_int  } -
    \int_to_arabic:n { \c_sys_month_int } -
    \int_to_arabic:n { \c_sys_day_int   }
  }
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\c_@@_name_type_clist,\c_@@_name_type_en_clist}
% 论文类型与学位类型。
%    \begin{macrocode}
\clist_const:Nn \c_@@_name_type_clist
  { 学士, 硕士, 博士 }
\clist_const:Nn \c_@@_name_type_en_clist
  { Bachelor, Master, Doctor~of~Philosophy }
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\c_@@_name_month_en_clist}
% 英文月份名称。
%    \begin{macrocode}
\clist_const:Nn \c_@@_name_month_en_clist
  {
    January, February, March, April, May, June,
    July, August, September, October, November, December
  }
%    \end{macrocode}
% \end{variable}
%
% \changes{v1.1}{2023/03/07}{盲审模式下隐藏年级和学校名称。}
% \begin{variable}{\c_@@_name_anon_clist,\c_@@_name_anon_en_clist}
% 盲审模式下不显示的个人信息键名。
%    \begin{macrocode}
\clist_const:Nn \c_@@_name_anon_clist
  {
    author, chairman, email, grade, student-id, reviewer,
    supervisor-contact, supervisor, supervisor-ii
  }
\clist_const:Nn \c_@@_name_anon_en_clist
  { author, supervisor, supervisor-ii }
%    \end{macrocode}
% \end{variable}
%
%
% \subsection{内部函数}
%
% \begin{macro}{\@@_null:}
% 等价于 \LaTeXe{} 中的 \tn{null}。
%    \begin{macrocode}
\cs_new:Nn \@@_null: { \hbox:n { } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_quad:,\@@_qquad:}
% 等价于 \LaTeXe{} 中的 \tn{quad} 和 \tn{qquad}。
%    \begin{macrocode}
\cs_new:Nn \@@_quad:  { \skip_horizontal:n { 1 em } }
\cs_new:Nn \@@_qquad: { \skip_horizontal:n { 2 em } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_vskip:,\@@_hskip:}
% 生成一个较小的 skip。
%    \begin{macrocode}
\cs_new:Nn \@@_vskip: { \skip_vertical:N   \c_@@_vsep_dim }
\cs_new:Nn \@@_hskip: { \skip_horizontal:N \c_@@_hsep_dim }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_vskip:N}
% 类似于 \LaTeXe 中的 \tn{vspace*}
% \footnote{\url{https://tex.stackexchange.com/a/30065/251992}}，
% 从上一个页面元素底部开始生成 |skip|。
%    \begin{macrocode}
\cs_set_protected:Npn \@@_vskip:N #1
  {
    \tex_hrule:D \@height \c_zero_dim \scan_stop:
    \tex_penalty:D \@M
    \skip_vertical:N #1
    \skip_vertical:N \c_zero_dim
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_define_name:nn,\@@_define_name:nnn}
% 用来定义默认名称的辅助函数。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_define_name:nn #1#2
  { \tl_const:cn { c_@@_name_ #1    _tl } {#2} }
\cs_new_protected:Npn \@@_define_name:nnn #1#2#3
  {
    \tl_const:cn { c_@@_name_ #1    _tl } {#2}
    \tl_const:cn { c_@@_name_ #1 _en_tl } {#3}
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_define_fmt:nn}
% 用来定义默认样式的辅助函数。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_define_fmt:nn #1#2
  { \tl_const:cn { c_@@_fmt_ #1 _tl } {#2} }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_define_dim:nn,\@@_define_skip:nn}
% 用来定义默认间距的辅助函数。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_define_dim:nn #1#2
  { \dim_const:cn  { c_@@_ #1 _dim  } {#2} }
\cs_new_protected:Npn \@@_define_skip:nn #1#2
  { \skip_const:cn { c_@@_ #1 _skip } {#2} }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_name:n,\@@_info:n,\@@_fmt:n}
% 根据变量名调用名称、内容或格式信息。
%    \begin{macrocode}
\cs_new:Npn \@@_name:n #1 { \tl_use:c { c_@@_name_ #1 _tl } }
\cs_new:Npn \@@_info:n #1 { \tl_use:c { g_@@_info_ #1 _tl } }
\cs_new:Npn \@@_fmt:n  #1 { \tl_use:c { c_@@_fmt_  #1 _tl } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_name:nn}
% 根据变量名调用名称信息，可调整字符格式
%    \begin{macrocode}
\cs_new:Npn \@@_name:nn #1#2
  { \group_begin: \@@_fmt:n {#1} \@@_name:n {#2} \group_end: }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_fontsize:nn,\@@_fontsize:nnn}
% 用于设置字号的辅助函数。\pkg{ctex} 默认使用的行距倍数是 1.2，我们在这里重新计算
% \tn{baselineskip}，抛弃 \cs{l__ctex_font_size_tl} 中的第二个值。
%    \begin{macrocode}
\cs_new:Npn \@@_fontsize:nn #1#2
  { \fontsize {#1} {#2} \selectfont }
\cs_new:Npn \@@_fontsize:nnn #1#2#3
  { \@@_fontsize:nn {#1} { \fp_to_decimal:n { #3 * #1 } } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_zihao:nn,\@@_zihao:n}
% 设置字号，类似于 \cs{ctex_zihao:n}。
% \begin{arguments}
%   \item 行距倍数
%   \item 字号值，同 \tn{zihao}
% \end{arguments}
%    \begin{macrocode}
\cs_new:Npn \@@_zihao:nn #1#2
  {
    \prop_get:NnNTF \c__ctex_font_size_prop {#2} \l__ctex_font_size_tl
      { \exp_after:wN \@@_fontsize:nnn \l__ctex_font_size_tl {#1} }
      { \msg_error:nnn { ctex } { fontsize } {#2} }
  }
%    \end{macrocode}
% 默认行距倍数为 1.3。
%    \begin{macrocode}
\cs_new:Npn \@@_zihao:n { \@@_zihao:nn { 1.3 } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\cs_new:Npo}
% \begin{macro}{\@@_set_ccglue:n}
% 调整间距。由于涉及载入 \cls{ctexbook} 后才能生效的 \pkg{xeCJK} 或 \pkg{luatexja}
% 的内部命令，我们只展开一次完成引擎判断，而不用 |x| 型全部展开。
%    \begin{macrocode}
\cs_generate_variant:Nn \cs_new:Npn { Npo }
\cs_new:Npo \@@_set_ccglue:n #1
  {
    \sys_if_engine_xetex:TF
      { \skip_set:Nn \l__ctex_ccglue_skip {#1} }
      { \ltjsetparameter { kanjiskip = {#1} } }
  }
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
% \begin{macro}{\@@_box_ulined:NN,\@@_box_ulined:Nc}
% 带有下划线的水平盒子。
% \begin{arguments}
%   \item 宽度，|dim| 型变量
%   \item 内容，可带有格式
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_box_ulined:NN #1#2
  {
    \mode_leave_vertical:
    \rule [ \c_@@_ruledpi_dim ] {#1} { \c_@@_rulehti_dim }
    \skip_horizontal:n { -#1 }
    \hbox_to_wd:nn {#1} { \tex_hfil:D #2 \tex_hfil:D }
  }
\cs_generate_variant:Nn \@@_box_ulined:NN { Nc }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_box_ulined_info:Nn}
% 以上盒子只用来打印 \cs[no-index]{g_@@_info_\meta{描述}_tl} 变量。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_box_ulined_info:Nn #1#2
  { \@@_box_ulined:Nc #1 { g_@@_info_ #2 _tl } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_box_spread:NNNn}
% \changes{v0.19}{2022/05/16}{对超出盒子宽度的文字进行水平压缩。}
% 分散对齐的水平盒子，拉伸算法来自 \cls{fduthesis}。
% 在文字宽度小于给定宽度时，在字符中间填补 \tn{hfil} 以增大字距。
% 在文字宽度超出限制时，进行整体水平压缩。
% \begin{arguments}
%   \item 临时 |dim| 型变量
%   \item 宽度，|dim| 型变量
%   \item 格式
%   \item 内容，不可带有格式
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_box_spread:NNNn #1#2#3#4
  {
    \mode_leave_vertical:
    \@@_get_width:Nn #1 { #3 #4 }
    \hbox_to_wd:nn {#2}
      {
        \dim_compare:nTF { #1 > #2 }
          {
            \tex_hfil:D \scalebox
              { \dim_to_decimal_in_unit:nn {#2} {#1} }
              [ 1.0 ] { #3 #4 } \tex_hfil:D
          }
          { #3 \tl_map_inline:nn {#4} { ##1 \tex_hfil:D } \tex_unskip:D }
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_box_spread:NNn,\@@_box_spread:NNv,\@@_box_spread:NNe}
%    \begin{macrocode}
\cs_new:Npn \@@_box_spread:NNn { \@@_box_spread:NNNn \l_@@_tmp_skip }
\cs_generate_variant:Nn \@@_box_spread:NNn { NNv }
\cs_generate_variant:Nn \@@_box_spread:NNn { NNe }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_box_spread_name:Nn,\@@_box_spread_name:NNn}
% 以上盒子只用来打印 \cs[no-index]{c_@@_name_\meta{描述}_tl} 变量。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_box_spread_name:Nn #1#2
  { \@@_box_spread:NNv #1 \c_empty_tl { c_@@_name_ #2 _tl } }
\cs_new_protected:Npn \@@_box_spread_name:NNn #1#2#3
  { \@@_box_spread:NNv #1 #2 { c_@@_name_ #3 _tl } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_box_center:Nn}
% 居中对齐的水平盒子。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_box_center:Nn #1#2
  {
    \mode_leave_vertical:
    \hbox_to_wd:nn {#1} { \tex_hfil:D #2 \tex_hfil:D }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_box_multiline:NNNNn}
% 多行固定长度的下划线内容。
% \begin{arguments}
%   \item 用于存储条目数量的 |int| 型变量
%   \item 用于存储条目内容的 |tl| 型变量
%   \item 内容，|clist| 型变量
%   \item 宽度，|dim| 型变量
%   \item 条目数量
% \end{arguments}
% 默认绘制 4 条下划线。在评阅者人数超过 4 人时添加额外的条目。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_box_multiline:NNNNn #1#2#3#4#5
  {
    \int_set:Nn #1 { \int_max:nn { \clist_count:N #3 } {#5} }
    \int_step_inline:nn {#1}
      {
%    \end{macrocode}
% \changes{v1.1}{2022/11/29}{修复空返回值在国家图书馆封面引发的死循环。}
% 防止空的返回值引发死循环。
%    \begin{macrocode}
        \clist_gpop:NNF #3 #2 { \tl_set_eq:NN #2 \c_empty_tl }
        \@@_box_ulined:NN #4 #2 \tex_par:D
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_box_multiline:NNn}
%    \begin{macrocode}
\cs_new:Npn \@@_box_multiline:NNn
  { \@@_box_multiline:NNNNn \l_@@_tmpa_int \l_@@_tmpa_tl }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_uline:n}
% 指定宽度的下划线。
% \begin{arguments}
%   \item 宽度，|dim| 型变量
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_uline:n #1
  {
    \mode_leave_vertical:
    \rule [ \c_@@_ruledpi_dim ] {#1} { \c_@@_rulehti_dim }
    \skip_horizontal:n { -#1 }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_uuline:N}
% 指定宽度的双层下划线。
% \begin{arguments}
%   \item 宽度，|dim| 型变量
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_uuline:N #1
  {
    \mode_leave_vertical:
    \rule [ \c_@@_ruledpii_dim  ] {#1} { \c_@@_rulehtii_dim }
    \skip_horizontal:n { -#1 }
    \rule [ \c_@@_ruledpiii_dim ] {#1} { \c_@@_rulehtii_dim }
    \skip_horizontal:n { -#1 }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_get_width:Nn,\@@_get_width:NV,\@@_get_width:Nv}
% ^^A 来自 fduthesis
% 获取文本宽度。
% \begin{arguments}
%   \item 存储宽度的 |dim| 型变量
%   \item 文本
% \end{arguments}
% 将内容放入 \tn{hbox} 后读取其宽度，存入 |dim| 型变量。
%    \begin{macrocode}
\cs_new:Npn \@@_get_width:Nn #1#2
  {
    \hbox_set:Nn \l_@@_tmpa_box {#2}
    \dim_set:Nn #1 { \box_wd:N \l_@@_tmpa_box }
  }
\cs_generate_variant:Nn \@@_get_width:Nn { NV }
\cs_generate_variant:Nn \@@_get_width:Nn { Nv }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_get_max_width:NN}
% ^^A 来自 fduthesis，调整了实现方法
% 获取多个文本中的最大宽度，并存入 |dim| 型变量。
% 本模板中此函数仅用于处理 |info| 类型文本变量，
% 出现在博士后模板封面信息表。
% \begin{arguments}
%   \item |dim| 型变量
%   \item 文本 |clist|
% \end{arguments}
% 当 \cs{l_@@_tmp_clist} 非空时，弹出最后一个元素赋给 \cs{l_@@_tmpa_tl}，
% 获取其长度后与 |#1| 进行比较，二者中较大的那一个将成为 |#1| 的新值。
% 不断循环，直至 \cs{l_@@_tmp_clist} 为空。
%    \begin{macrocode}
\cs_new:Npn \@@_get_max_width:NN #1#2
  {
    \clist_map_inline:Nn #2
      {
        \@@_get_width:Nv \l_@@_tmpa_dim { g_@@_info_ ##1 _tl }
        \dim_gset:Nn #1 { \dim_max:nn {#1} { \l_@@_tmpa_dim } }
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_get_width_print:Nn,\@@_get_width_print:Nv,
%   \@@_get_width_print:Ne}
% 横跨整页的下划线。
% \begin{arguments}
%   \item 宽度，|dim| 型变量
%   \item 文本
% \end{arguments}
% 先使用 \cs{@@_get_width:Nn} 获取文本内容到右边距的宽度，
% 该宽度存储在调用的 |dim| 型变量中。随后输出文本内容。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_get_width_print:Nn #1#2
  {
    \@@_get_width:Nn #1 {#2}
    \dim_set:Nn #1 { \textwidth - #1 } #2
  }
\cs_generate_variant:Nn \@@_get_width_print:Nn { Nv }
\cs_generate_variant:Nn \@@_get_width_print:Nn { Ne }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_uline_entry:Nn}
% 生成占整页宽度的下划线条目。
% \begin{arguments}
%   \item 宽度，|dim| 型变量
%   \item 文本
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_uline_entry:Nn #1#2
  {
    \@@_get_width_print:Nv #1 { c_@@_name_ #2 _tl }
    \@@_box_ulined_info:Nn #1 {#2}
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_uline_bientry:Nn}
% 生成占半页宽度的下划线条目。
% \begin{arguments}
%   \item 宽度，|dim| 型变量
%   \item 文本
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_uline_bientry:Nn #1#2
  {
    \@@_get_width_print:Nv #1 { c_@@_name_ #2 _tl }
    \dim_sub:Nn #1 { \textwidth / 2 }
    \@@_box_ulined_info:Nn #1 {#2}
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_date:www,\@@_date_en:www}
% 将形如 |yyyy-mm-dd| 的 ISO 日期格式字符串转化为日期表示。
% 该格式符合国际标准 ISO 8601 以及国内标准 GB/T 7408--2005
% 《数据元和交换格式 信息交换 日期和时间表示法》。
% \begin{arguments}
%   \item 年份
%   \item 月份
%   \item 日期
% \end{arguments}
% 中文日期字样通过封装 \pkg{zhnumber} 的内部函数实现，默认使用阿拉伯数字表示，
% 可以通过该宏包提供的 |\zhnumsetup{time=Chinese}| 来使用中文数字；
% 英文日期字样用于研究生英文封面，格式为 \meta{月份缩写}~\meta{日},~\meta{年}。
% 其中，变量类型 |w| 表明参数符合特定语法格式，其参数必须经过完全展开。
%    \begin{macrocode}
\cs_new:Npn \@@_date:www    #1-#2-#3 \q_stop
  { \__zhnum_date_aux:nnn {#1} {#2} {#3} }
\cs_new:Npn \@@_date_en:www #1-#2-#3 \q_stop
  { \clist_item:Nn \c_@@_name_month_en_clist {#2} ~#3 , ~#1  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_date:nn}
%    \begin{macrocode}
\cs_new:Npn \@@_date:nn { \@@_date:nnn { } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_date:nnn}
% \changes{v0.20}{2022/05/24}{可在日期项留空以使用空白的年月日字样。}
% 用于日期格式转化的辅助命令。在传入的字符串为空时生成空白字样。
%    \begin{macrocode}
\cs_new:Npn \@@_date:nnn #1#2#3
  {
    \tl_gset:cx { g_@@_info_ #2 date #1 _tl }
      {
        \tl_if_empty:nTF {#3}
          { \@@_name:n { blankdate #1 } }
          { \use:c { @@_date #1 :www } #3 \q_stop }
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_at_begin_document:n}
% 封装 \LaTeX{} 的钩子管理机制，等效于 \tn{AtBeginDocument}。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_at_begin_document:n #1
  { \hook_gput_next_code:nn { begin document } {#1} }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cs_clear:N}
% 清空命令。
%    \begin{macrocode}
\cs_new:Npn \@@_cs_clear:N #1 { \cs_set_eq:NN #1 \tex_relax:D }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_msg:nn}
% 简化提示信息的创建。
%    \begin{macrocode}
\cs_new:Npn \@@_msg:nn { \msg_new:nnn { njuthesis } }
%    \end{macrocode}
% \end{macro}
%
% \subsubsection{封面相关}
% \changes{v0.16}{2022/03/10}{将封面和摘要内部函数定义移动到前部。}
%
% \begin{macro}{\@@_loop_until:nnn}
% 等效于 plain \TeX 的 \tn{loop} 循环，原始结构为\\
% \tn{loop}\meta{循环体1}\meta{终止条件}\meta{循环体2}\tn{repeat}。
% \begin{arguments}
%   \item |bool| 表达式
%   \item 循环体1
%   \item 循环体2
% \end{arguments}
% 两个代码块交替执行，如果在\meta{循环体1}结束后满足条件，则退出循环。
%    \begin{macrocode}
\cs_new:Npn \@@_loop_until:nnn #1#2#3
  { #2 \bool_if:nF {#1} { #3 \@@_loop_until:nnn {#1} {#2} {#3} } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_breakpar_loop:n}
% \changes{v1.0}{2022/08/01}{使用 \LaTeX3 语法重构下划线断行算法。}
% 带下划线的自然断行算法。
% \begin{arguments}
%   \item 循环体2的额外语句
% \end{arguments}
%    \begin{macrocode}
\cs_new:Npn \@@_breakpar_loop:n #1
  {
    \dim_set:Nn \l_@@_tmpa_dim
      { - \tex_prevdepth:D - \c_@@_ruledpi_dim - \c_@@_rulehti_dim }
    \hbox_gset:Nn \l_@@_tmpc_box { }
    \@@_loop_until:nnn { \box_if_empty_p:N \l_@@_tmpb_box }
      {
        \box_gset_to_last:N \l_@@_tmpb_box
        \tex_unskip:D \tex_unpenalty:D
      }
      {
        \hbox_gset:Nn \l_@@_tmpc_box
          {
            \vbox_top:n
              {
                \box_use_drop:N \l_@@_tmpb_box
                \__kernel_kern:n { \l_@@_tmpa_dim }
                \tex_hrule:D
              }
            \tex_penalty:D
            \l_@@_tmpa_box
            \hbox_unpack_drop:N \l_@@_tmpc_box
          }
        #1
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_breakpar_print:nn}
% 打印带下划线的自然断行算法结果。
%    \begin{macrocode}
\cs_new:Npn \@@_breakpar_print:nn #1#2
  {
    \group_begin:
      \tex_noindent:D #1
      \hbox_unpack_drop:N \l_@@_tmpc_box #2
      \tex_par:D
    \group_end:
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_uline_title:}
% \changes{v0.17}{2022/04/09}{优化封面标题的断行方式。}
% 多行带下划线标题。使用 \TeX 原生断行算法实现。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_uline_title:
  {
    \vbox_set:Nn \l_@@_tmpa_box
      {
        \skip_set:Nn \tex_leftskip:D { .5 em plus 1 fill }
        \skip_set_eq:NN \tex_rightskip:D \tex_leftskip:D
        \g_@@_info_title_tl \tex_par:D
%    \end{macrocode}
% 使用循环寻找断行点，存入已被清空的 3 号盒子。
%    \begin{macrocode}
        \@@_breakpar_loop:n { }
      }
%    \end{macrocode}
% 输出绘制好的标题。
%    \begin{macrocode}
    \@@_breakpar_print:nn { } { }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cover_entry_title:NNNN,\@@_cover_entry_title:NNN}
% 生成普通封面页的标题条目，包括标签和标题本身。
% \begin{arguments}
%   \item 分隔符
%   \item 名称盒子宽度，|dim| 型变量
%   \item 内容盒子宽度，|dim| 型变量
%   \item 标签格式
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_cover_entry_title:NNNN #1#2#3#4
  {
    \tl_if_empty:NT \g_@@_info_title_tl
      { \msg_error:nn { njuthesis } { missing-title } }
    \@@_box_spread_name:NNn #2 #4 { title }
    \mode_leave_vertical: #1
%    \end{macrocode}
% 这里需要存储 \tn{prevdepth} 的值，以使 \tn{parbox} 后行距正确。
% \footnote{\url{https://tex.stackexchange.com/q/34971/}}
%    \begin{macrocode}
    \parbox [ t ] {#3}
      {
        \c_@@_fmt_covertitle_tl \@@_uline_title:
        \dim_gset_eq:NN \l_@@_tmpa_dim \tex_prevdepth:D
      }
    \tex_par:D
    \dim_set_eq:NN \tex_prevdepth:D \l_@@_tmpa_dim
  }
\cs_new:Npn \@@_cover_entry_title:NNN { \@@_cover_entry_title:NNNN \@@_hskip: }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cover_entry:NNNNn,\@@_cover_entry:NNNn}
% 生成单项信息条目。
% \begin{arguments}
%   \item 分隔符
%   \item 名称盒子宽度，|dim| 型变量
%   \item 内容盒子宽度，|dim| 型变量
%   \item 标签格式
%   \item 条目名称
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_cover_entry:NNNNn #1#2#3#4#5
  {
    \@@_box_spread_name:NNn #2 #4 {#5} #1
    \@@_box_ulined_info:Nn  #3    {#5} \tex_par:D
  }
\cs_new:Npn \@@_cover_entry:NNNn { \@@_cover_entry:NNNNn \@@_hskip: }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cover_entry:NNNnn}
% 生成两项信息条目，仅用于本科生封面。
% \begin{arguments}
%   \item 名称盒子宽度，|dim| 型变量
%   \item 内容盒子宽度，|dim| 型变量
%   \item 标签格式
%   \item 左侧条目名称
%   \item 右侧条目名称
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_cover_entry:NNNnn #1#2#3#4#5
  {
    \@@_box_spread_name:NNn #1 #3 {#4} \@@_hskip:
    \@@_box_ulined_info:Nn  #2    {#4} \@@_hskip:
    \@@_box_spread_name:NNn #1 #3 {#5} \@@_hskip:
    \@@_box_ulined_info:Nn  #2    {#5} \tex_par:D
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cover_entry_supv:NNNn}
% 生成两项导师信息条目，仅用于本科生封面。
% \begin{arguments}
%   \item 长内容盒子宽度，|dim| 型变量
%   \item 短内容盒子宽度，|dim| 型变量
%   \item 标签格式
%   \item 条目名称
% \end{arguments}
% |clist| 最后一个元素为空时弹出的是无法展开的 \cs{q_novalue_tl}，
% 需要简单处理以使用分散对齐的盒子。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_cover_entry_supv:NNNn #1#2#3#4
  {
    \tl_set:Nn \l_@@_tmpa_tl
      { \clist_item:cn { g_@@_info_ #4 _clist } { 1 } }
    \tl_set:Nn \l_@@_tmpb_tl
      { \clist_item:cn { g_@@_info_ #4 _clist } { 2 } }
    \@@_box_spread_name:NNn #1 #3 {#4}        \@@_hskip:
    \@@_box_ulined:NN #2 \l_@@_tmpa_tl        \@@_hskip:
    \@@_box_spread_name:NNn #1 #3 { supvtitle } \@@_hskip:
    \@@_box_ulined:NN #2 \l_@@_tmpb_tl        \tex_par:D
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_emblem:N,\@@_name:N}
% 封装图片绘制命令，参数为图片宽度。
% 此时 \tn{njuemblem}、\tn{njuname} 和相关长度都是没有定义的。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_emblem:N #1
  { \njuemblem [ \c_@@_fmt_emblemcolor_tl ] {#1} { ! } }
\cs_new_protected:Npn \@@_name:N   #1
  { \njuname   [ \c_@@_fmt_namecolor_tl   ] {#1} { ! } }
%    \end{macrocode}
% \end{macro}
%
% \subsubsection{摘要相关}
%
% \begin{macro}{\@@_abs_bookmark:nn,\@@_abs_bookmark:Vn}
% \changes{v0.14}{2021/12/21}{将摘要插入目录。}
% 生成摘要的目录条目。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_abs_bookmark:nn #1#2
  {
    \phantomsection
    \@@_bookmark:Nnn \g_@@_abs_showentry_bool {#1} {#2}
    \@@_chapter_header:n {#1}
  }
\cs_generate_variant:Nn \@@_abs_bookmark:nn { Vn }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_abs_title:N}
% 摘要标题双层下划线格式。
% \begin{arguments}
%   \item 宽度，|dim| 型变量
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_abs_title:N #1
  {
    \@@_get_width:NV \l_@@_tmpa_dim #1
    \@@_uuline:N     \l_@@_tmpa_dim #1
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_uline_list:NNn,\@@_uline_list:NNe}
% \changes{v0.16}{2022/03/25}{使用原生断行算法处理摘要页标题。}
% 用于研究生摘要页面的多行标题。
% \begin{arguments}
%   \item 内容
%   \item 左边距
%   \item 标签
% \end{arguments}
% 这里转化了使用 plain \TeX{} 语法实现的的断行算法。
% \footnote{\url{https://tex.stackexchange.com/q/637861/}，对其语法的简要介绍可以参考
% \href{http://petr.olsak.net/ftp/olsak/optex/tex-nutshell.pdf}{\file{tex-nutshell.pdf}}。}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_uline_list:NNn #1#2#3
  {
    \vbox_set:Nn \l_@@_tmpa_box
      {
        \@@_get_width:Nn \tex_hangindent:D {#3}
        \int_set:Nn \tex_hangafter:D { -1 }
        \skip_set_eq:NN \tex_leftskip:D #2
        \skip_set_eq:NN \tex_rightskip:D \tex_leftskip:D
        \tex_noindent:D #1 \tex_par:D
%    \end{macrocode}
% 使用循环寻找断行点，存入已被清空的 3 号盒子，同时统计行数。
%    \begin{macrocode}
        \int_gzero:N \l_@@_tmpa_int
        \@@_breakpar_loop:n { \int_gincr:N \l_@@_tmpa_int }
      }
      \@@_breakpar_print:nn {#3}
        {
%    \end{macrocode}
% 在使用自然断行算法后，研究生的摘要标题可选择 \opt{strict}
% 或者 \opt{natural} 模式。前者会为少于两行的标题补齐下划线，
% 并对多于三行的标题生成警告信息。这里通过行数处理边界条件，
% 包括标题未填写、标题只有一行，以及标题过长的情况。
%    \begin{macrocode}
        \bool_if:NT \g_@@_abs_title_strict_bool
          {
            \int_case:nnF { \l_@@_tmpa_int }
              {
                { 0 } { \msg_error:nn { njuthesis } { missing-title } }
                { 1 } { \@@_uline:n { \textwidth } }
                { 2 } { }
              }
              { \msg_warning:nn { njuthesis } { abs-title-too-long } }
            \tex_par:D
          }
      }
  }
\cs_generate_variant:Nn \@@_uline_list:NNn { NNe }
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{页面对象}
% \changes{v0.15}{2022/01/24}{使用 \pkg{xtemplate} 重构封面。}
%
% 本模板使用 \pkg{xtemplate} 提供的面向对象方法简化封面和摘要的绘制过程。
%
% 以下分别从页面元素（element）和页面整体（page）的层次进行了抽象。
% 当我们把页面部件考虑为一个对象时，它天然地只具备有限数量的属性：
% 内容、格式、边距、对齐方式等。而具体的页面是这些对象的实例的集合，
% 附加边距、行距等属性，创建页面只需传入一个列表调用各个 Instance
% 即可。通过 \pkg{xtemplate} 提供的功能，我们可以根据这些属性创建模板
% （template），进而能大量构建具有\emph{相似行为}的实例（instance）。
% 这种做法能充分分离内容和样式，极大优化代码的可读性。
%
% 声明对象类型。此类对象不需要参数。
%    \begin{macrocode}
\DeclareObjectType { nju } { \c_zero_int }
%    \end{macrocode}
%
% \subsubsection{元素模板}
% \changes{v1.0}{2022/08/02}{修正元素对象的底部间距设置。}
%
%    \begin{macrocode}
%<@@=njuelem>
%    \end{macrocode}
%
% \begin{macro}{\@@_align:}
% 声明元素模板接口。
% 元素是一个页面的基本组成单位，包括文段、图片等等。
% 一个抽象的元素应当具备以下属性：
% \begin{description}
%   \item[\opt{content}] 内容，即剥离样式的元素本身
%   \item[\opt{format}] 格式，例如字号、字体
%   \item[\opt{bottom-skip}] 下间距，即与下一个元素的距离
%   \item[\opt{align}] 对齐方式，包括左对齐、右对齐、居中、正常段落
% \end{description}
%    \begin{macrocode}
\DeclareTemplateInterface { nju } { element } { \c_zero_int }
  {
    content     : tokenlist = \c_empty_tl,
    format      : tokenlist = \c_empty_tl,
    bottom-skip : skip      = \c_zero_skip,
    align       : choice { l, r, c, n } = c
  }
%    \end{macrocode}
%
% 声明元素模板代码。涉及的变量将被自动创建。
%    \begin{macrocode}
\DeclareTemplateCode { nju } { element } { \c_zero_int }
  {
    content     = \l_@@_content_tl,
    format      = \l_@@_format_tl,
    bottom-skip = \l_@@_bottom_skip,
    align =
      {
        l = { \cs_set_eq:NN \@@_align: \raggedright },
        r = { \cs_set_eq:NN \@@_align: \raggedleft  },
        c = { \cs_set_eq:NN \@@_align: \centering   },
        n = { \cs_set:Nn    \@@_align: { }          }
      }
  }
  {
    \AssignTemplateKeys
    \group_begin:
      \@@_align:
      \l_@@_format_tl \l_@@_content_tl \tex_par:D
    \group_end:
    \__nju_vskip:N \l_@@_bottom_skip
  }
%    \end{macrocode}
% \end{macro}
%
% \subsubsection{页面模板}
% \changes{v1.0}{2022/07/27}{为页面模板添加书签选项。}
%
%    \begin{macrocode}
%<@@=njupage>
%    \end{macrocode}
%
% \begin{macro}{\exp_args:NVV}
%    \begin{macrocode}
\exp_args_generate:n { NVV }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_bookmark:nn}
% 声明页面模板接口。
% 页面是元素的集合。一个抽象的页面应当具备以下属性：
% \begin{description}
%   \item[\opt{element}] 包含的元素，这里使用的是名称列表
%   \item[\opt{prefix}] 元素名称前缀
%   \item[\opt{format}] 格式，例如行距
%   \item[\opt{top-skip}] 上间距，即与页面顶部的距离
%   \item[\opt{bottom-skip}] 下间距，即与页面底部的距离
%   \item[\opt{bm-text}] PDF 书签名称
%   \item[\opt{bm-name}] PDF 书签锚点名
%   \item[\opt{bookmark}] 添加书签的类型，分别为目录条目、仅 PDF 书签、不显示。
% \end{description}
%    \begin{macrocode}
\DeclareTemplateInterface { nju } { page } { \c_zero_int }
  {
    element     : commalist = \c_empty_clist,
    prefix      : tokenlist = \c_empty_tl,
    format      : tokenlist = \c_empty_tl,
    top-skip    : skip      = \c_zero_skip,
    bottom-skip : skip      = \c_zero_skip,
    bm-text     : tokenlist = \c_empty_tl,
    bm-name     : tokenlist = \c_empty_tl,
    bookmark    : choice { toc, pdf, none } = none
  }
%    \end{macrocode}
%
% 声明页面模板代码。
%    \begin{macrocode}
\DeclareTemplateCode { nju } { page } { \c_zero_int }
  {
    element     = \l_@@_element_clist,
    prefix      = \l_@@_prefix_tl,
    format      = \l_@@_format_tl,
    top-skip    = \l_@@_top_skip,
    bottom-skip = \l_@@_bottom_skip,
    bm-text     = \l_@@_bm_text_tl,
    bm-name     = \l_@@_bm_name_tl,
    bookmark    =
      {
        toc  = { \cs_set_eq:NN \@@_bookmark:nn \__nju_bookmark_toc:nn },
        pdf  = { \cs_set_eq:NN \@@_bookmark:nn \__nju_bookmark_pdf:nn },
        none = { \cs_set:Nn    \@@_bookmark:nn { } }
      }
  }
  {
    \AssignTemplateKeys
    \clearpage
    \thispagestyle { empty }
%    \end{macrocode}
% 由于起始位置没有内容，\tn{vspace*} 会使第一个元素的位置与上边距有一定距离。
%    \begin{macrocode}
    \__nju_vskip:N \l_@@_top_skip
    \exp_args:NVV \@@_bookmark:nn
      \l_@@_bm_text_tl \l_@@_bm_name_tl
    \group_begin:
      \l_@@_format_tl
      \clist_map_inline:Nn \l_@@_element_clist
        { \UseInstance { nju } { \l_@@_prefix_tl ##1 } }
    \group_end:
    \__nju_vskip:N \l_@@_bottom_skip
  }
%    \end{macrocode}
% \end{macro}
%
% \subsubsection{外部接口}
%
% \begin{macro}{\@@_declare_element:nn,\@@_declare_page:nn}
% 封装 \pkg{xtemplate} 提供的函数，简化创建实例的过程。
% \begin{arguments}
%   \item 实例名称
%   \item 参数列表
% \end{arguments}
%    \begin{macrocode}
%<@@=nju>
\cs_new:Npn \@@_declare_element:nn #1#2
  { \DeclareInstance { nju } {#1} { element } {#2} }
\cs_new:Npn \@@_declare_page:nn    #1#2
  { \DeclareInstance { nju } {#1} { page    } {#2} }
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{提示信息}
% \changes{v1.1}{2022/12/03}{整理提示信息。}
%
% 本节集中定义模板中的错误信息。
%    \begin{macrocode}
\@@_msg:nn { abs-title-too-long }
  {
    Your~ title~ seems~ too~ long~ to~ fit~ in~ two~ lines.\\
    I~ have~ drawn~ additional~ lines~ to~ contain~ it,~
    which~ will~ probably~ make~ your~ abstract~ page~
    look~ slightly~ different~ from~ the~ standard.~
    You~ can~ use~ the~ "abstract/title-style"~ key~
    to~ disable~ this~ message.
  }
\@@_msg:nn { empty-theorem-type }
  {
    Empty~ theorem~ list~ to~ define.\\
    The~ key~ "theorem/type"~ should~ not~ be~ left~ empty.
  }
\@@_msg:nn { load-config  }
  { I~ am~ loading~ config~ file~ "#1". }
\@@_msg:nn { missing-image }
  {
    You~ have~ not~ selected~ local~ files~
    for~ emblem~ and~ name~ images.\\
    It~ seems~ that~ you~ haven't~ fill~ in~ both~
    "image/nju-emblem"~ and~ "image/nju-name",~ therefore~
    I~ am~ using~ the~ package~ "njuvisual"~ instead,~
    which~ may~ slow~ down~ the~ compilation.
  }
\@@_msg:nn { missing-ntheorem }
  {
    "ntheorem"~ package~ not~ detected.\\
    The~ functionality~ of~ built-in~ theorem~ settings~
    requires~ loading~ the~ class~ with~ "ntheorem"~ option~
    set~ to~ "true".
  }
\@@_msg:nn { missing-symbol }
  {
    \string\mdwhtsquare\ and~ \string\checkmark\ are~ not~
    contained~ in~ the~ standard~ amsmath~ package.~ You~
    should~ redefine~ them~ with~ other~ packages~ loaded~
    to~ properly~ generate~ the~ declaration~ page.
  }
\@@_msg:nn { missing-title }
  {
    Thesis~ title~ should~ not~ be~ left~ blank.\\
    Please~ check~ whether~ you~ have~ fill~ in~
    both Chinese~ and~ English~ titles.
  }
\@@_msg:nn { no-small-caps }
  {
    I~ am~ using~ TeX~ Gyre~ Termes~ as~ default~ Roman~ font.\\
    This~ is~ because~ the~ "Times~ New~ Roman"~ font~ in~ your~
    system~ does~ not~ embed~ glyphs~ for~ small~ capitals.~
    You~ can~ ignore~ this~ warning~ if~ you~ do~ not~ need~
    \string\textsc.~ For~ more~ information,~
    please~ refer~ to~ section~ 3.2.6~ of~ the~ documentation.
  }
\@@_msg:nn { package-too-old }
  {
    Package~ "#1"~ is~ too~ old.\\
    The~ "njuthesis"~ class only~ supports~ "#1"~ with~
    a~ version~ higher~ than~ v#2.~
    Please~ update~ an~ up-to-date~ version~ of~ it~
    using~ your~ TeX~ package~ manager~ or~ from~ CTAN.
  }
\@@_msg:nn { package-conflict }
  {
    The~ "#2"~ package~ is~ incompatible~ with~ "#1".\\
    I~ have~ loaded~ "#1"~ by~ default.~ Maybe~ You~ should~
    refer~ to~ section~ 4~ of~ the~ documentation.
  }
\@@_msg:nn { missing-stzhongs }
  {
    "STZHONGS.TTF"~ is~ not~ found~ in~ your~ system.\\
    The~ font~ is~ normally~ distributed~ with~ MS~ Windows.~
    I~ have~ used~ songti~ for~ substitution.
  }
%    \end{macrocode}
%
%
% \subsection{模板选项}
% \changes{v0.11}{2021/11/15}{进行了效率优化。}
%
%    \begin{macrocode}
\keys_define:nn { nju }
  {
%    \end{macrocode}
%
% \begin{macro}{type}
% \changes{v1.0}{2022/06/30}{修改类型选项。}
% 学位，默认为学士。
%    \begin{macrocode}
    type               .choices:nn = { bachelor, master, doctor, postdoc }
      { \int_gset_eq:NN \g_@@_info_type_int \l_keys_choice_int },
    type               .initial:n  = bachelor,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{degree}
% \changes{v1.0}{2022/06/30}{修改学位选项。}
% 研究生的学位类型，默认为学术学位。
%    \begin{macrocode}
    degree              .choice:,
    degree / academic     .code:n  =
      { \bool_gset_true:N  \g_@@_opt_academic_bool },
    degree / professional .code:n  =
      { \bool_gset_false:N \g_@@_opt_academic_bool },
    degree             .initial:n  = academic,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{nl-cover,\g_@@_opt_nlcover_bool}
% 是否需要国家图书馆封面。本选项仅用于研究生模板，默认关闭。
% \footnote{nl 代表 National Library。}
%    \begin{macrocode}
    nl-cover         .bool_gset:N  = \g_@@_opt_nlcover_bool,
    nl-cover           .initial:n  = false,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{decl-page,\g_@@_opt_decl_bool}
% \changes{v0.13}{2021/12/15}{新增诚信承诺书选项。}
% \changes{v0.14}{2022/01/06}{修改选项名称。}
% 是否需要诚信承诺书或原创性声明（默认关闭）。
% \footnote{原创性声明的英文翻译为 Declaration of Originality，
% 为了使选项表义更清晰同时缩减名称长度，将其修改为“声明页”这一名称。}
%    \begin{macrocode}
    decl-page        .bool_gset:N  = \g_@@_opt_decl_bool,
    decl-page          .initial:n  = false,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{draft,\g_@@_opt_draft_bool}
% \changes{v0.13}{2021/12/15}{新增草稿模式选项。}
% 是否开启草稿模式（默认关闭）。
%    \begin{macrocode}
    draft            .bool_gset:N  = \g_@@_opt_draft_bool,
    draft              .initial:n  = false,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{oneside,twoside}
% \changes{v0.14}{2022/01/14}{新增单双面模式选项。}
% 单双面模式（默认为双面）。
%    \begin{macrocode}
    oneside    .value_forbidden:n  = true,
    twoside    .value_forbidden:n  = true,
    oneside  .bool_gset_inverse:N  = \g_@@_opt_twoside_bool,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{anonymous}
% \changes{v0.18}{2022/04/19}{新增盲审模式选项。}
% \changes{v1.0}{2022/07/05}{重命名盲审模式选项。}
% \begin{macro}{\g_@@_opt_anon_bool}
% 盲审模式。
%    \begin{macrocode}
    anonymous        .bool_gset:N  = \g_@@_opt_anon_bool,
    anonymous          .initial:n  = false,
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
% \begin{macro}{latin-font,cjk-font}
% \changes{v0.14}{2021/12/12}{简化字体选项名称。}
% 中英文字体选项。\opt{fandol} 和 \opt{gyre} 是等价的。
%    \begin{macrocode}
    latin-font         .choices:nn =
      { fandol, gyre, mac, macoffice, win, none }
      { \tl_gset:Nn \g_@@_font_latin_tl {#1} },
    cjk-font           .choices:nn =
      { fandol, founder, mac, macoffice, noto, source, win, none }
      { \tl_gset:Nn \g_@@_font_cjk_tl   {#1} },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{latin-font,cjk-font}
% \changes{v1.4}{2023/12/15}{增加统一的字体选项名称。}
% 中英文字体选项。\opt{fontset} 这个名称和 \pkg{ctex} 是一致的。
%    \begin{macrocode}
    fontset            .choices:nn =
      { fandol, mac, macoffice, win, none }
      { \keys_set:nn { nju } { latin-font = #1, cjk-font = #1 } },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{math-font}
% \changes{v1.0}{2022/07/02}{增加数学字库选择功能。}
% 数学字体选项。
% 由 \pkg{unicode-math} 指定 \XeTeX 和 \LuaTeX 下使用的数学字体。
%    \begin{macrocode}
    math-font          .choices:nn =
      {
        asana, cambria, fira, garamond, lm, libertinus, newcm,
        stix, bonum, dejavu, pagella, schola, termes, xits, none
      }
      { \tl_gset_eq:NN \g_@@_font_math_tl  \l_keys_choice_tl },
    math-font          .initial:n  = xits,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{font-path}
% 独立字体文件的路径。
%    \begin{macrocode}
    font-path             .code:n  =
      {
        \bool_gset_true:N \g_@@_font_path_bool
        \tl_gset_eq:NN \g_@@_font_path_tl \l_keys_value_tl
      },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{zihao}
% \changes{v1.0}{2022/07/04}{新增字号选项。}
% \begin{macro}{\g_@@_opt_zihao_tl}
% 字号。默认为小四号。
%    \begin{macrocode}
    zihao              .tl_gset:N  = \g_@@_opt_zihao_tl,
    zihao              .initial:n  = -4,
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
% \begin{macro}{linespread}
% \changes{v1.0}{2022/07/04}{新增行距选项。}
% \begin{macro}{\g_@@_opt_linespread_tl}
% 行距。\LaTeX 默认1.2行距，MS Word 默认行距是1.3，要求1.5倍
% Word 行距，故默认值为 $1.5\times\frac{1.3}{1.2} = 1.625$。
% 更详细的说明请参考 \pkg{zhlineskip} 宏包文档。
%    \begin{macrocode}
    linespread         .tl_gset:N  = \g_@@_opt_linespread_tl,
    linespread         .initial:n  = 1.625,
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
% \begin{macro}{config,\g_@@_config_clist}
% \changes{v0.16}{2022/02/23}{新增 \opt{config} 选项。}
% 配置文件路径。
%    \begin{macrocode}
    config          .clist_gset:N  = \g_@@_config_clist
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\g_@@_name_optional_pkg_clist}
%    \begin{macrocode}
\clist_new:N \g_@@_name_optional_pkg_clist
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_define_pkg_keys:nnn}
% \begin{arguments}
%   \item 宏包名
%   \item 简写名称，一般为宏包使用的名空间
%   \item 是否默认载入
% \end{arguments}
% 定义是否载入宏包的的文档类选项，以及相应的载入命令。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_define_pkg_keys:nnn #1#2#3
  {
    \keys_define:nn { nju }
      {
        #1 .bool_gset:c = { g_@@_opt_load_ #2 _bool },
        #1   .initial:n = #3
      }
    \cs_new_protected:cpn { @@_loadpkg_ #2 : }
      {
        \bool_if:cT { g_@@_opt_load_ #2 _bool }
          { \RequirePackage {#1} }
      }
    \clist_gput_right:Nn \g_@@_name_optional_pkg_clist {#1}
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{
%   biblatex,
%   cleveref,
%   enumitem,
%   footmisc,
%   ntheorem,
%   unicode-math,
%   \g_@@_opt_load_blx_bool,
%   \g_@@_opt_load_cref_bool,
%   \g_@@_opt_load_nthm_bool,
%   \g_@@_opt_load_enit_bool,
%   \g_@@_opt_load_fm_bool,
%   \g_@@_opt_load_um_bool,
%   \@@_loadpkg_blx:,
%   \@@_loadpkg_cref:,
%   \@@_loadpkg_enit:,
%   \@@_loadpkg_fm:,
%   \@@_loadpkg_nthm:,
%   \@@_loadpkg_um:}
%    \begin{macrocode}
\clist_map_inline:nn
  {
    { biblatex       } { blx   } { true  },
    { cleveref       } { cref  } { true  },
    { ntheorem       } { nthm  } { true  },
    { enumitem       } { enit  } { true  },
    { footmisc       } { fm    } { true  },
    { unicode-math   } { um    } { true  }
  }
  { \@@_define_pkg_keys:nnn #1 }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{minimal}
% \changes{v1.0}{2022/08/03}{新增最小化载入宏包选项。}
% 最小化模式，不载入进行功能拓展的额外宏包。
%    \begin{macrocode}
\keys_define:nn { nju }
  {
    minimal .value_forbidden:n = true,
    minimal            .code:n =
      {
        \clist_map_inline:Nn \g_@@_name_optional_pkg_clist
          { \keys_set:nn { nju } { ##1 = false } }
        \keys_set:nn { nju } { math-font = none }
      }
  }
%    \end{macrocode}
% \end{macro}
%
% 获取输入的文档类选项。
%    \begin{macrocode}
\ProcessKeysOptions { nju }
%    \end{macrocode}
%
% 处理单双面模式选项。
%    \begin{macrocode}
\bool_if:NTF \g_@@_opt_twoside_bool
  { \tl_const:Nn \c_@@_name_pagemode_tl { twoside } }
  { \tl_const:Nn \c_@@_name_pagemode_tl { oneside } }
%    \end{macrocode}
%
% \changes{v1.1}{2022/09/26}{盲审模式下不显示声明页。}
% 盲审模式下不显示声明页。
%    \begin{macrocode}
\bool_if:NT \g_@@_opt_anon_bool
  { \bool_gset_false:N \g_@@_opt_decl_bool }
%    \end{macrocode}
%
%
% \subsection{用户接口}
%
% \begin{macro}{abstract, bib, image, footer, footnote, header,
%   info, label-sep, listoffigures, listoftables,
%   math, style, theorem, tableofcontents}
% 定义模块名的元（meta）键值对。
%    \begin{macrocode}
\clist_map_inline:nn
  {
    abstract, bib, image, footer, footnote, header,
    info, label-sep, listoffigures, listoftables,
    math, style, theorem, tableofcontents
  }
  { \keys_define:nn { nju } { #1 .meta:nn = { nju / #1 } {##1} } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_keys_set:nn}
% \changes{v1.1}{2022/09/26}{使用 \cs{keys_set_filter:nnn} 重构盲审模式。}
% 在开启盲审模式时，屏蔽被编入 \opt{anonymous} 分组的键值对输入。
%    \begin{macrocode}
\bool_if:NTF \g_@@_opt_anon_bool
  {
    \cs_new:Npn \@@_keys_set:nn #1#2
      { \keys_set_filter:nnn {#1} { anonymous } {#2} }
  }
  { \cs_new_eq:NN \@@_keys_set:nn \keys_set:nn }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\njusetup}
% \changes{v0.6}{2021/09/10}{改用键值对输入信息。}
% \changes{v1.0}{2022/08/01}{增加输入键路径的可选参数。}
% 定义设置接口。
% \begin{arguments}
%   \item 可选的键路径
%   \item 设置项
% \end{arguments}
% \cls{njuthesis} 的键值对设置一共三层：最外层为指示名空间的
% \opt{nju}，第二层为上方设定的模块名称，最内层为具体设置项。
% 在路径留空时，本接口仅使用最外层名空间，向下兼容旧版设置；
% 在路径填入模块名时，第二个参数为键值对类型，可以减少一层缩进；
% 在路径填入完整设置项时，第二个参数为具体的值。
%    \begin{macrocode}
\NewDocumentCommand \njusetup { o m }
  {
    \tl_if_novalue:nTF {#1}
      { \@@_keys_set:nn { nju } {#2} }
      {
        \tl_if_in:nnTF {#1} { / }
          { \@@_keys_set:nn { nju } { #1 = {#2} } }
          { \@@_keys_set:nn { nju  /  #1 } {#2}   }
      }
  }
%    \end{macrocode}
% \end{macro}
% \tn{njusetup} 仅能在导言区使用。
%    \begin{macrocode}
\@onlypreamble \njusetup
%    \end{macrocode}
%
% \begin{macro}{\njusetformat}
% \changes{v0.17}{2022/04/09}{提供修改默认样式的接口。}
% \changes{v0.19}{2022/05/11}{提供默认页面样式的修改方式。}
% \changes{v0.20}{2022/05/25}{提供页眉页脚样式的修改方式。}
% \changes{v0.20}{2022/05/25}{提供内置校名校徽颜色的修改方式。}
% 定义修改默认样式的接口。
%    \begin{macrocode}
\NewDocumentCommand \njusetformat { m m }
  { \tl_gset:cn { c_@@_fmt_ #1 _tl } {#2} }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\njusetlength,\njusetlength*}
% \changes{v0.17}{2022/04/09}{提供修改长度值的接口。}
% \changes{v0.18}{2022/04/20}{统一管理校名校徽尺寸。}
% 定义修改长度值的接口。可选星号表示修改弹性长度。
%    \begin{macrocode}
\NewDocumentCommand \njusetlength { s m m }
  {
    \bool_if:nTF {#1}
      { \skip_gset:cn { c_@@_ #2 _skip } {#3} }
      { \dim_gset:cn  { c_@@_ #2 _dim  } {#3} }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\njusetname,\njusetname*,\njusettext,\njusettext*}
% \changes{v0.17}{2022/04/01}{提供修改固定文本的接口。}
% \changes{v1.1}{2022/12/12}{修复 \tn{njusetname} 和 \tn{njusettext} 的可选参数问题。}
% 定义修改固定文本的接口。
%    \begin{macrocode}
\NewDocumentCommand \njusetname { s m O{} m }
  { \@@_set_tokenlist:nnnnn {#1} {#2} {#3} {#4} { name } }
\NewDocumentCommand \njusettext { s m O{} m }
  { \@@_set_tokenlist:nnnnn {#1} {#2} {#3} {#4} { text } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_set_tokenlist:nnnnn}
% 用于修改名称、文字常量的辅助函数。
% \begin{arguments}
%   \item 是否含有可选星号，传入 |bool| 型变量
%   \item 被修改变量名称
%   \item 可选的变体，用字母标记
%   \item 修改后的内容
%   \item 类别，name 或者 text
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_set_tokenlist:nnnnn #1#2#3#4#5
  {
    \bool_if:nTF {#1}
      { \tl_set_eq:NN \l_@@_tmpb_tl \c_@@_name_suffix_en_tl }
      { \tl_clear:N   \l_@@_tmpb_tl }
    \tl_gset:cn { c_@@_ #5 _ #2 #3 \l_@@_tmpb_tl _tl } {#4}
  }
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{外部宏包}
%
% \subsubsection{默认选项}
%
% \changes{v0.12}{2021/12/07}{重新组织宏包载入顺序。}
% 将选项传入 \cls{ctexbook} 文档类。
%    \begin{macrocode}
\exp_args:Ne \PassOptionsToClass
  {
    a4paper,
    UTF8,
    scheme = chinese,
%    \end{macrocode}
% 传入单双面模式选项。
%    \begin{macrocode}
    \c_@@_name_pagemode_tl,
%    \end{macrocode}
% 开启草稿模式后传入 |draft| 选项。
%    \begin{macrocode}
    \bool_if:NT \g_@@_opt_draft_bool { draft, }
%    \end{macrocode}
% 行距。
%    \begin{macrocode}
    linespread = \g_@@_opt_linespread_tl,
%    \end{macrocode}
% 默认不载入任何字体，供本模板自行设置。
%    \begin{macrocode}
    fontset    = none,
%    \end{macrocode}
% 正文字号设置。
%    \begin{macrocode}
    zihao      = \g_@@_opt_zihao_tl
  }
  { ctexbook }
%    \end{macrocode}
%
% 传入各宏包选项。
%    \begin{macrocode}
\clist_map_inline:nn
  {
%    \end{macrocode}
% 隐藏 |does not contain script "CJK"| 警告。
%    \begin{macrocode}
%     { quiet   } { xeCJK    },
    { no-math } { fontspec },
    { perpage } { footmisc },
    { capitalise, nameinlink, noabbrev } { cleveref },
%    \end{macrocode}
% \pkg{ntheorem} 依赖 \pkg{amsthm} 和 \pkg{thmmarks} 实现 QED 符号等功能。
%    \begin{macrocode}
    { amsmath, thmmarks, noconfig      } { ntheorem }
  }
  { \PassOptionsToPackage #1 }
%    \end{macrocode}
%
% \subsubsection{载入文档类}
%
% 使用\pkg{ctexbook}作为基础文档类。
%    \begin{macrocode}
\LoadClass { ctexbook } [ 2018/04/01 ]
%    \end{macrocode}
%
% \subsubsection{载入宏包}
%
% \changes{v0.14}{2021/12/21}{移除 \pkg{hologo}。}
% \changes{v0.15}{2022/01/17}{移除 \pkg{url}。}
% \changes{v0.13}{2021/12/13}{使用 \pkg{ntheorem} 创建定理环境，
%   移除 \pkg{amsthm} 和 \pkg{thmtools}。}
% \changes{v0.16}{2022/03/19}{不显式载入 \pkg{amsmath}。}
% \changes{v0.18}{2022/04/20}{不强制载入 \pkg{ntheorem}。}
% \changes{v1.0}{2022/07/03}{移除 \pkg{mathtools}。}
% \changes{v1.0}{2022/08/03}{选择性载入 \pkg{ntheorem}。}
%
%    \begin{macrocode}
\@@_loadpkg_enit:
\@@_loadpkg_fm:
%    \end{macrocode}
% 为保证 \pkg{cleveref} 在 \pkg{unicode-math}
% 缺失的情况下也能正常工作，载入了 \pkg{amsmath}。
%    \begin{macrocode}
\bool_if:NTF \g_@@_opt_load_um_bool
  { \RequirePackage { unicode-math } }
  {
    \RequirePackage { amsmath }
    \bool_if:NT \g_@@_opt_decl_bool
      {
        \msg_warning:nn { njuthesis } { missing-symbol }
        \cs_new:Npn \mdwhtsquare { }
        \cs_new:Npn \checkmark { }
      }
  }
%    \end{macrocode}
%
% 载入各种宏包。
%    \begin{macrocode}
\RequirePackage
  {
    geometry,
    fancyhdr,
    setspace,
%    \end{macrocode}
% \changes{v0.14}{2021/12/21}{移除内置的 \pkg{multirow}、\pkg{subcaption}
%   和 \pkg{wrapfig}。}
% 图片与表格。
%    \begin{macrocode}
    booktabs,
    caption,
    graphicx,
  }
\@@_loadpkg_nthm:
%    \end{macrocode}
% \pkg{hyperref} 覆写了大量命令，因此需要在其他包最后载入。
%    \begin{macrocode}
\RequirePackage { hyperref }
%    \end{macrocode}
%
% \changes{v1.3}{2024/01/16}{调整 \pkg{cleveref} 到 \pkg{ntheorem} 后载入。}
% \pkg{cleveref} 需要在 \pkg{ntheorem} 和 \pkg{hyperref} 后载入。
%    \begin{macrocode}
\@@_loadpkg_cref:
%    \end{macrocode}
%
% 在双面模式下，使用 \pkg{emptypage} 清除空白页的页眉、页脚和页码。
%    \begin{macrocode}
\bool_if:NT \g_@@_opt_twoside_bool { \RequirePackage { emptypage } }
%    \end{macrocode}
%
% \changes{v0.13}{2021/12/13}{移除会与 \pkg{ntheorem} 冲突的 \pkg{microtype}。}
% \begin{macro}{\njuline}
% 针对编译引擎，使用不同的宏包构建可以对中文正常换行的下划线命令。
%    \begin{macrocode}
\sys_if_engine_xetex:T
  {
    \RequirePackage { xeCJKfntef }
    \NewDocumentCommand \njuline { m } { \CJKunderline{#1} }
  }
%    \end{macrocode}
% \pkg{lua-ul} 中需要在结尾使用 \tn{null} 保护尾部空白。
%    \begin{macrocode}
\sys_if_engine_luatex:T
  {
    \RequirePackage { lua-ul }
    \NewDocumentCommand \njuline { m } { \underLine{#1} \@@_null: }
  }
%</class>
%    \end{macrocode}
% \end{macro}
%
% 使用 \pkg{tabularray} 绘制研究生的出版授权书。
%    \begin{macrocode}
%<def-g>\bool_if:NT \g_@@_opt_decl_bool { \RequirePackage { tabularray } }
%    \end{macrocode}
%
% \subsubsection{检查宏包}
%
% \begin{macro}{\@@_check_pkg_version:nnn}
% 检查宏包版本是否过时。
%    \begin{macrocode}
%<*class>
\cs_new:Npn \@@_check_pkg_version:nnn #1#2#3
  {
    \@ifpackagelater {#1} {#2}
      { } { \msg_error:nnnn { njuthesis } { package-too-old } {#1} {#3} }
  }
%    \end{macrocode}
% \end{macro}
%
% 检查绘制下划线所需的 \pkg{luatexja} 包版本。该宏包在 2021-09-18 的更新
% 解决了下划线中断问题，然而在 2021-10-24 的更新才提供了正确的内嵌日期。
%    \begin{macrocode}
\sys_if_engine_luatex:T
  { \@@_check_pkg_version:nnn { luatexja } { 2021/10/24 } { 20211024.0 } }
%    \end{macrocode}
%
% \changes{v0.18}{2022/04/28}{增加宏包冲突检查。}
% \changes{v1.0}{2022/08/03}{移除 \pkg{filehook}，改用 \pkg{ctex} 内置的宏包钩子。}
%
% \begin{macro}{\@@_check_pkg_conflict:nn}
% 检查用户载入的宏包是否会与预置宏包发生冲突。
% \begin{arguments}
%   \item 模板载入的宏包
%   \item 产生冲突的宏包
% \end{arguments}
%    \begin{macrocode}
\cs_new:Npn \@@_check_pkg_conflict:nn #1#2
  {
    \ctex_at_begin_package:nn {#2}
      { \msg_warning:nnnn { njuthesis } { package-conflict } {#1} {#2} }
  }
%    \end{macrocode}
% \end{macro}
%
% 检查数学宏包冲突。
%    \begin{macrocode}
\bool_if:NT \g_@@_opt_load_um_bool
  {
    \clist_map_inline:nn
      {
        amscd, amsfonts, amssymb, bbm, bm, eucal,
        eufrak, mathrsfs, newtxmath, upgreek
      }
      { \@@_check_pkg_conflict:nn { unicode-math } {#1} }
  }
%    \end{macrocode}
%
% \subsection{配置文件}
%
% \cls{njuthesis} 包含三套区别较大的模板配置，分别适用于\emph{本科生}、
% \emph{研究生}和\emph{博士后}。出于定义的简洁起见，本模板将其不同之处
% 拆分为单独的参数配置文件，编译过程中将会根据导言区设置的类型选项，载
% 入对应默认配置。注意，尽管在手册中封面、摘要、常量等的代码实现位于靠
% 后部分，拆分后实际上是在此处载入运行的，务必要注意处理的逻辑顺序。
%    \begin{macrocode}
\exp_args:Ne \file_input:n
  {
    njuthesis-
    \int_case:nn { \g_@@_info_type_int }
      {
        { 1 } { undergraduate }
        { 2 } { graduate      }
        { 3 } { graduate      }
        { 4 } { postdoctoral  }
      }
    .def
  }
%    \end{macrocode}
%
% 载入用户设置，可用于对模板做额外修改。
%    \begin{macrocode}
\clist_map_inline:Nn \g_@@_config_clist
  {
    \msg_info:nnn { njuthesis } { load-config } {#1}
    \file_input:n {#1}
  }
%    \end{macrocode}
%
%
% \subsection{个人信息}
% \changes{v0.11}{2021/10/01}{将个人信息变量名改为小写字母加连字符的形式。}
% \changes{v0.15}{2022/01/22}{将个人信息设置移到载入宏包后。}
%
%    \begin{macrocode}
\keys_define:nn { nju / info }
  {
%    \end{macrocode}
%
% \begin{macro}{info/title,info/title*}
% \changes{v0.13}{2021/12/12}{简化多行标题的输入方式。}
% \changes{v0.14}{2022/01/14}{将标题断行控制符修改为 |\\|。}
% 题目。中文题目可使用 |\\| 手动断行。以下标注星号（|*|）的皆为对应的英文字段。
%    \begin{macrocode}
    title              .tl_gset:N = \g_@@_info_title_tl             ,
    title              .initial:n = { 空 }                            ,
    title*             .tl_gset:N = \g_@@_info_title_en_tl          ,
    title*             .initial:n = { Empty }                         ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/keywords,info/keywords*}
% \changes{v0.11}{2021/10/01}{修改了添加关键词的方式。}
% 关键词列表。
%    \begin{macrocode}
    keywords        .clist_gset:N = \g_@@_info_keywords_clist       ,
    keywords*       .clist_gset:N = \g_@@_info_keywords_en_clist    ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/grade,info/student-id,info/author,info/author*}
% 年级、学号、姓名。
%    \begin{macrocode}
    grade              .tl_gset:N = \g_@@_info_grade_tl             ,
    student-id         .tl_gset:N = \g_@@_info_id_tl                ,
    author             .tl_gset:N = \g_@@_info_author_tl            ,
    author*            .tl_gset:N = \g_@@_info_author_en_tl         ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/department,info/department*,
%   info/major*,info/field,info/field*}
% 院系、专业、方向。
%    \begin{macrocode}
    department         .tl_gset:N = \g_@@_info_dept_tl              ,
    department*        .tl_gset:N = \g_@@_info_dept_en_tl           ,
    major*             .tl_gset:N = \g_@@_info_major_en_tl          ,
    field              .tl_gset:N = \g_@@_info_field_tl             ,
    field*             .tl_gset:N = \g_@@_info_field_en_tl          ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/major}
% \changes{v1.3}{2023/05/11}{专业型研究生封面可额外修改专业名称。}
% \changes{v1.3}{2023/12/05}{调整专业型学位的填写方式。}
% 专业。研究生专业型学位可以取封面和摘要的两个值，此外都取第一个值。
%    \begin{macrocode}
    major                 .code:n =
      {
        \bool_if:NTF \g_@@_opt_academic_bool
          {
            \clist_pop:NN  \l_keys_value_tl \l_@@_tmpa_tl
            \tl_gset_eq:NN \g_@@_info_major_tl \l_@@_tmpa_tl
          }
          {
            \clist_pop:NN  \l_keys_value_tl \l_@@_tmpa_tl
            \tl_gset_eq:NN \g_@@_info_majorc_tl \l_@@_tmpa_tl
            \clist_pop:NNTF \l_keys_value_tl \l_@@_tmpa_tl
              { \tl_gset_eq:NN \g_@@_info_major_tl \l_@@_tmpa_tl }
              { \tl_gset_eq:NN \g_@@_info_major_tl \g_@@_info_majorc_tl }
          }
      },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/supervisor,info/supervisor*}
% \changes{v0.13}{2021/12/11}{修改了导师选项的变量名称。}
% \changes{v0.14}{2022/01/12}{精简导师信息选项。}
% 导师信息。中文导师全称使用 |clist| 存储，便于在本科生封面中进行分割。
%    \begin{macrocode}
    supervisor      .clist_gset:N = \g_@@_info_supv_clist           ,
    supervisor*        .tl_gset:N = \g_@@_info_supv_en_tl           ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/supervisor-ii,info/supervisor-ii*}
% 第二导师信息。
%    \begin{macrocode}
    supervisor-ii   .clist_gset:N = \g_@@_info_supvii_clist         ,
    supervisor-ii*     .tl_gset:N = \g_@@_info_supvii_en_tl         ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/chairman,info/reviewer}
% 答辩委员会信息。
%    \begin{macrocode}
    chairman           .tl_gset:N = \g_@@_info_chairman_tl          ,
    reviewer        .clist_gset:N = \g_@@_info_reviewer_clist       ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/clc,info/udc}
% 分类号。
%    \begin{macrocode}
    clc                .tl_gset:N = \g_@@_info_clc_tl               ,
    udc                .tl_gset:N = \g_@@_info_udc_tl               ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/secret-level}
% 密级。
%    \begin{macrocode}
    secret-level       .tl_gset:N = \g_@@_info_secretlv_tl          ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/supervisor-contact}
% 导师联系方式。
%    \begin{macrocode}
    supervisor-contact .tl_gset:N = \g_@@_info_supvcont_tl          ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/email}
% \changes{v0.14}{2022/01/12}{新增电邮地址设置项。}
% 用于学位论文出版授权书的电子邮件地址。
%    \begin{macrocode}
    email              .tl_gset:N = \g_@@_info_email_tl             ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/school-code}
% \changes{v1.2}{2023/04/27}{新增学校代码设置项。}
% 学校代码。
%    \begin{macrocode}
    school-code        .tl_gset:N = \g_@@_info_code_tl              ,
    school-code        .initial:n = { 10284 }                       ,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{info/degree,info/degree*}
% \changes{v1.2}{2023/04/24}{新增学位名称设置项。}
% 覆盖预定义的学位字段。
%    \begin{macrocode}
    degree             .tl_gset:N = \g_@@_info_degree_tl            ,
    degree*            .tl_gset:N = \g_@@_info_degree_en_tl         ,
%    \end{macrocode}
% \end{macro}
%
% 提交日期，初始值为编译当天日期。
%    \begin{macrocode}
  }
%    \end{macrocode}
%
% \changes{v1.3}{2023/05/18}{日期字段直接在输入键值时处理。}
%
% \begin{macro}{info/submit-date}
% \changes{v0.14}{2022/01/14}{精简提交日期选项。}
% \begin{macro}{info/defend-date}
% \changes{v0.14}{2022/01/14}{精简答辩日期选项。}
% \begin{macro}{info/confer-date}
% \changes{v0.19}{2022/05/23}{新增国家图书馆封面的学位授予日期设置项。}
% \begin{macro}{info/bottom-date}
% \changes{v0.19}{2022/05/23}{新增国家图书馆封面的底部日期设置项。}
% \begin{variable}{\g_@@_info_submitdate_tl,\g_@@_info_defenddate_tl,
%   \g_@@_info_bottomdate_tl,\g_@@_info_conferdate_tl}
% 日期。
%    \begin{macrocode}
\clist_map_inline:nn { submit, defend, confer, bottom }
  {
    \keys_define:nn { nju / info }
      {
        #1-date    .code:n = \@@_date:nn {#1} {##1},
        #1-date .initial:V = \c_@@_name_today_tl
      }
  }
%    \end{macrocode}
% \end{variable}
% \end{macro}
% \end{macro}
% \end{macro}
% \end{macro}
%
% 将指定信息项归入 \opt{anonymous} 组，以在盲审模式下选择性屏蔽。
%    \begin{macrocode}
\clist_map_inline:Nn \c_@@_name_anon_clist
  { \keys_define:nn { nju / info } { #1   .groups:n = { anonymous } } }
\clist_map_inline:Nn \c_@@_name_anon_en_clist
  { \keys_define:nn { nju / info } { #1 * .groups:n = { anonymous } } }
%    \end{macrocode}
%
% \changes{v0.15}{2022/01/22}{正确处理双导师信息。}
% \changes{v1.1}{2022/11/04}{修复研究生模板封面的导师信息居中问题。}
% 在导言区录入用户信息后进行变量设置。此处使用到了 \pkg{ctex} 提供的命令，
% 应当位于载入文档类之后。
%    \begin{macrocode}
\@@_at_begin_document:n
  {
%    \end{macrocode}
% 拼合双导师的姓名和职称。
%    \begin{macrocode}
    \tl_gset:Ne \g_@@_info_supvfull_tl
      { \clist_use:Nn \g_@@_info_supv_clist { \@@_hskip: } }
    \clist_if_empty:NF \g_@@_info_supvii_clist
      {
        \bool_gset_true:N \g_@@_opt_supvii_bool
        \tl_gput_right:Ne \g_@@_info_supvfull_tl
          { \@@_quad: \clist_use:Nn \g_@@_info_supvii_clist { \@@_hskip: } }
      }
    \tl_gset_eq:NN \g_@@_info_supvfull_en_tl \g_@@_info_supv_en_tl
    \tl_if_empty:NF \g_@@_info_supvii_en_tl
      {
        \tl_gput_right:Ne \g_@@_info_supvfull_en_tl
          { \@@_quad: \g_@@_info_supvii_en_tl }
      }
  }
%</class>
%    \end{macrocode}
%
% \begin{variable}{\g_@@_info_submitdate_en_tl}
% 研究生封面额外需要英文日期。
%    \begin{macrocode}
%<*def-g>
\cs_set:Npn \@@_date:nn #1#2
  { \@@_date:nnn { } {#1} {#2} \@@_date:nnn { _en } {#1} {#2} }
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_info_confer_tl}
%    \begin{macrocode}
\tl_new:N  \g_@@_info_confer_tl
\tl_gset:Nn \g_@@_info_confer_tl
  {
    \textbf { \c_@@_name_nju_tl } \hfil
    \g_@@_info_conferdate_tl
  }
%    \end{macrocode}
% \end{variable}
%
% \changes{v0.16}{2022/03/06}{正确处理学位和类型信息。}
% 设置学位信息。该设置需要放在 \tn{ProcessKeysOptions} 命令后进行。
%
% \begin{variable}{\g_@@_info_type_tl}
% 文档类型字样。
%    \begin{macrocode}
\tl_new:N  \g_@@_info_type_tl
\tl_gset:Ne \g_@@_info_type_tl
  { \clist_item:Nn \c_@@_name_type_clist { \g_@@_info_type_int } }
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_info_degree_tl}
% 学位类型字样。
%    \begin{macrocode}
\tl_new:N     \g_@@_info_degree_tl
\tl_gset_eq:NN \g_@@_info_degree_tl \g_@@_info_type_tl
\bool_if:NF \g_@@_opt_academic_bool
  { \tl_gput_right:Nn \g_@@_info_degree_tl { 专业 } }
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_info_degree_en_tl}
% 英文的学位字样。
%    \begin{macrocode}
\tl_new:N  \g_@@_info_degree_en_tl
\tl_gset:Ne \g_@@_info_degree_en_tl
  { \clist_item:Nn \c_@@_name_type_en_clist { \g_@@_info_type_int } }
%</def-g>
%    \end{macrocode}
% \end{variable}
%
% 盲审模式下抹去学校名称。
%    \begin{macrocode}
%<*class>
\bool_if:NT \g_@@_opt_anon_bool
  {
    \tl_gclear:N \c_@@_name_nju_tl
    \tl_gclear:N \c_@@_name_nju_en_tl
  }
%    \end{macrocode}
%
%
% \subsection{字体设置}
%
% \pkg{fontspec} 包含于 \pkg{ctex} 宏集，无需另行载入。
%
% \subsubsection{操作系统检测}
%
% \begin{variable}{\c_@@_path_macoffice_tl}
% mac Office 字体路径。
%    \begin{macrocode}
\tl_const:Nn \c_@@_path_macoffice_tl
  { /Applications/Microsoft~ Word.app/Contents/Resources/DFonts/ }
%    \end{macrocode}
% \end{variable}
%
% 操作系统检测。相较于 \pkg{ctex} 提供的 \cs{ctex_detect_platform:}，
% 额外增加了对 macOS 上 MS Office 的检测。
%    \begin{macrocode}
\sys_if_platform_windows:TF
  { \tl_gset:Nn \g_@@_font_set_tl { win } }
  {
    \ctex_if_platform_macos:TF
      {
        \file_if_exist:nTF { \c_@@_path_macoffice_tl times.ttf }
          { \tl_gset:Nn \g_@@_font_set_tl { macoffice } }
          { \tl_gset:Nn \g_@@_font_set_tl { mac       } }
      }
      { \tl_gset:Nn \g_@@_font_set_tl { fandol } }
  }
%    \end{macrocode}
% 判断用户是否自定义了中英文字体。如果其中任意一种未被定义，
% 则使用系统预装字体覆盖字体选项。
% Windows 或 macOS 外的系统被判断为 Linux，一律使用自由字体。
%    \begin{macrocode}
\tl_if_empty:NT \g_@@_font_latin_tl
  { \tl_gset_eq:NN \g_@@_font_latin_tl \g_@@_font_set_tl }
\tl_if_empty:NT \g_@@_font_cjk_tl
  { \tl_gset_eq:NN \g_@@_font_cjk_tl   \g_@@_font_set_tl }
%    \end{macrocode}
%
%
% \subsubsection{定义英文字库}
%
% 接下来逐个定义所需要使用的字库。
%
% \begin{macro}{\@@_loadfont_latin:n,
%   \@@_loadfont_latin_win:,\@@_loadfont_latin_mac:}
% Windows 与 macOS 西文字体的区别主要在于默认等宽字体。
%    \begin{macrocode}
\cs_new:Npn \@@_loadfont_latin:n #1
  {
    \__fontspec_main_setmainfont:nn { } { Times~New~Roman }
    \__fontspec_main_setsansfont:nn { } { Arial           }
    \__fontspec_main_setmonofont:nn { Scale = MatchLowercase } {#1}
  }
\cs_new_protected:Npn \@@_loadfont_latin_win:
  { \@@_loadfont_latin:n { Courier~New } }
\cs_new_protected:Npn \@@_loadfont_latin_mac:
  {
    \@@_loadfont_latin:n { Menlo }
%    \end{macrocode}
% \changes{v1.1}{2022/12/03}{添加对 Times New Roman 的 smcp 特性的检测。}
% 检测 Times New Roman 是否具有小型大写字母（small caps）字型。
% 这是 macOS 预装的字体版本较旧导致的。
%    \begin{macrocode}
    \fontspec_if_small_caps:F
      {
        \msg_warning:nn { njuthesis } { no-small-caps }
        \__fontspec_main_setmainfont:nn
          { \c_@@_name_gyrefeature_clist } { texgyretermes }
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_latin_macoffice:}
% mac Office 西文字体。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_loadfont_latin_macoffice:
  {
    \__fontspec_main_setmainfont:nn
      { \c_@@_name_macofficefeature_clist } { times }
    \__fontspec_main_setsansfont:nn
      { \c_@@_name_macofficefeature_clist } { arial }
    \__fontspec_main_setmonofont:nn
      { Scale     = MatchLowercase } { Menlo }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{variable}{\c_@@_name_macofficefeature_clist}
% 用于 \pkg{fontspec} 的 mac Office 字体特性列表。
%    \begin{macrocode}
\clist_const:Nn \c_@@_name_macofficefeature_clist
  {
    Path           = \c_@@_path_macoffice_tl,
    Extension      = .ttf,
    UprightFont    = *,
    BoldFont       = *bd,
    ItalicFont     = *i,
    BoldItalicFont = *bi
  }
%    \end{macrocode}
% \end{variable}
%
% \begin{macro}{\@@_loadfont_latin_gyre:}
% 开源的 \TeX Gyre 西文字体。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_loadfont_latin_gyre:
  {
    \__fontspec_main_setmainfont:nn
      { \c_@@_name_gyrefeature_clist } { texgyretermes }
    \__fontspec_main_setsansfont:nn
      { \c_@@_name_gyrefeature_clist } { texgyreheros  }
    \__fontspec_main_setmonofont:nn
      {
        \c_@@_name_gyrefeature_clist,
        Scale     = MatchLowercase,
        Ligatures = CommonOff
      }
      { texgyrecursor }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_latin_fandol:}
% 为兼容 \pkg{ctex} 做出的名称改变。
%    \begin{macrocode}
\cs_new_eq:NN \@@_loadfont_latin_fandol:  \@@_loadfont_latin_gyre:
%    \end{macrocode}
% \end{macro}
%
% \begin{variable}{\c_@@_name_gyrefeature_clist}
% 用于 \pkg{fontspec} 的 \TeX Gyre 字体特性列表。
%    \begin{macrocode}
\clist_const:Nn \c_@@_name_gyrefeature_clist
  {
    Extension      = .otf,
    UprightFont    = *-regular,
    BoldFont       = *-bold,
    ItalicFont     = *-italic,
    BoldItalicFont = *-bolditalic
  }
%    \end{macrocode}
% \end{variable}
%
%
% \subsubsection{定义中文字库}
%
% \begin{macro}{\@@_hide_no_script_msg:}
% 隐藏 |does not contain script "CJK"| 警告。
%    \begin{macrocode}
\cs_new:Npn \@@_hide_no_script_msg:
  { \msg_redirect_name:nnn { fontspec } { no-script } { info } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_cjk_win:N,\@@_loadfont_cjk_win:}
% Windows 中文字体。
%    \begin{macrocode}
\cs_new:Npn \@@_loadfont_cjk_win:N #1
  {
    \setCJKmainfont { SimSun   } [ #1, ItalicFont = KaiTi ]
    \setCJKsansfont { SimHei   } [#1]
    \setCJKmonofont { FangSong } [#1]
    \setCJKfamilyfont { zhsong } { SimSun   } [#1]
    \setCJKfamilyfont { zhhei  } { SimHei   } [#1]
    \setCJKfamilyfont { zhfs   } { FangSong } [#1]
    \setCJKfamilyfont { zhkai  } { KaiTi    } [#1]
    \@@_stzhongs:n {#1}
  }
\cs_new:Npn \@@_loadfont_cjk_win:
  { \@@_loadfont_cjk_win:N \c_@@_name_fakebold_tl }
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@@_loadfont_cjk_mac:}
% macOS 字体。
% ^^A TODO: 修复 macOS 字体支持，实现开箱即用。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_loadfont_cjk_mac:
  {
    \@@_hide_no_script_msg:
    \setCJKmainfont { Songti~SC~Light }
      [
        BoldFont       = Songti~SC~Bold,
        ItalicFont     = Kaiti~SC,
        BoldItalicFont = Kaiti~SC~Bold
      ]
    \setCJKsansfont { Heiti~SC~Light  } [ BoldFont = Heiti~SC~Medium ]
    \setCJKmonofont { STFangsong      }
    \setCJKfamilyfont { zhsong } { Songti~SC~Light } [ BoldFont = Songti~SC~Bold ]
    \setCJKfamilyfont { zhhei  } { Heiti~SC~Light  } [ BoldFont = Heiti~SC~Medium ]
    \setCJKfamilyfont { zhfs   } { STFangsong      }
    \setCJKfamilyfont { zhkai  } { Kaiti~SC        } [ BoldFont = Kaiti~SC~Bold ]
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_cjk_macoffice:n,\@@_loadfont_cjk_macoffice:}
% mac Office 中文字体。
%    \begin{macrocode}
\cs_new:Npn \@@_loadfont_cjk_macoffice:n #1
  {
    \setCJKmainfont { Simsun.ttc   } [ ItalicFont = Kaiti.ttf, #1 ]
    \setCJKsansfont { SimHei.ttf   } [#1]
    \setCJKmonofont { Fangsong.ttf } [#1]
    \setCJKfamilyfont { zhsong } { Simsun.ttc   } [#1]
    \setCJKfamilyfont { zhhei  } { SimHei.ttf   } [#1]
    \setCJKfamilyfont { zhfs   } { Fangsong.ttf } [#1]
    \setCJKfamilyfont { zhkai  } { Kaiti.ttf    } [#1]
    \@@_stzhongs:nn { STZHONGS.ttf } {#1}
  }
\cs_new:Npn \@@_loadfont_cjk_macoffice:
  {
    \@@_loadfont_cjk_macoffice:n
      { Path = \c_@@_path_macoffice_tl, \c_@@_name_fakebold_tl }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_cjk_fandol:}
% Fandol 字体。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_loadfont_cjk_fandol:
  {
    \@@_hide_no_script_msg:
    \setCJKmainfont { FandolSong-Regular }
      [
        Extension  = .otf,
        BoldFont   = FandolSong-Bold,
        ItalicFont = FandolKai-Regular
      ]
    \setCJKsansfont { FandolHei-Regular  }
      [
        Extension = .otf,
        BoldFont  = FandolHei-Bold
      ]
    \setCJKmonofont { FandolFang-Regular }
      [ Extension = .otf ]
    \setCJKfamilyfont { zhsong } { FandolSong-Regular }
      [
        Extension = .otf,
        BoldFont  = FandolSong-Bold
      ]
    \setCJKfamilyfont { zhhei  } { FandolHei-Regular  }
      [
        Extension = .otf,
        BoldFont  = FandolHei-Bold
      ]
    \setCJKfamilyfont { zhfs   } { FandolFang-Regular }
      [ Extension = .otf ]
    \setCJKfamilyfont { zhkai  } { FandolKai-Regular  }
      [ Extension = .otf, \c_@@_name_fakebold_tl ]
  }
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@@_loadfont_cjk_founder:}
% 方正字库（简繁扩展）
%    \begin{macrocode}
\cs_new_protected:Npn \@@_loadfont_cjk_founder:
  {
%    \end{macrocode}
% 调整方正字体括号位置。
% \footnote{\XeTeX 的调整方法来自 \url{https://www.zhihu.com/question/46241367/answer/101660183}。}
%    \begin{macrocode}
    \sys_if_engine_xetex:T
      { \xeCJKEditPunctStyle { quanjiao } { optimize-kerning = true } }
    \sys_if_engine_luatex:T
      { \defaultCJKfontfeatures { JFM = { zh_CN / { quanjiao, fzpr } } } }
    \setCJKmainfont { FZShuSong-Z01  }
      [ BoldFont = FZXiaoBiaoSong-B05, ItalicFont = FZKai-Z03 ]
    \setCJKsansfont { FZXiHeiI-Z08   } [ BoldFont = FZHei-B01 ]
    \setCJKmonofont { FZFangSong-Z02 }
    \setCJKfamilyfont { zhsong } { FZShuSong-Z01  }
      [ BoldFont = FZXiaoBiaoSong-B05 ]
    \setCJKfamilyfont { zhhei  } { FZHei-B01      }
      [ \c_@@_name_fakebold_tl ]
    \setCJKfamilyfont { zhkai  } { FZKai-Z03      }
      [ \c_@@_name_fakebold_tl ]
    \setCJKfamilyfont { zhfs   } { FZFangSong-Z02 }
    \defaultCJKfontfeatures { }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_cjk_noto:}
% Noto 思源字体。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_loadfont_cjk_noto:
  {
    \setCJKmainfont [ \c_@@_name_notofeature_clist ]
      { NotoSerifCJKsc }
    \setCJKsansfont [ \c_@@_name_notofeature_clist ]
      { NotoSansCJKsc  }
    \setCJKmonofont { Noto~Sans~Mono~CJK~SC }
    \setCJKfamilyfont { zhsong } { Noto~Serif~CJK~SC }
    \setCJKfamilyfont { zhhei  } { Noto~Sans~CJK~SC  }
    \setCJKfamilyfont { zhfs   } { FZFangSong-Z02    }
    \setCJKfamilyfont { zhkai  } { FZKai-Z03         }
      [ \c__nju_name_fakebold_tl ]
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_cjk_source:}
% \changes{v0.14}{2021/12/20}{增加 Adobe Source Han 作为思源字体。}
% Source Han 思源字体。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_loadfont_cjk_source:
  {
    \setCJKmainfont [ \c_@@_name_notofeature_clist ]
      { SourceHanSerifSC }
    \setCJKsansfont [ \c_@@_name_notofeature_clist ]
      { SourceHanSansSC  }
    \setCJKmonofont { FZFangSong-Z02 }
    \setCJKfamilyfont { zhsong } { Source~Han~Serif~SC }
    \setCJKfamilyfont { zhhei  } { Source~Han~Sans~SC  }
    \setCJKfamilyfont { zhfs   } { FZFangSong-Z02      }
    \setCJKfamilyfont { zhkai  } { FZKai-Z03           }
      [ \c_@@_name_fakebold_tl ]
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{variable}{\c_@@_name_fakebold_tl}
%    \begin{macrocode}
\tl_const:Nn \c_@@_name_fakebold_tl { AutoFakeBold = 2.17 }
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\c_@@_name_notofeature_clist}
% 用于 \pkg{fontspec} 的思源字体特性列表。
%    \begin{macrocode}
\clist_const:Nn \c_@@_name_notofeature_clist
  {
    Extension          = .otf,
    UprightFont        = *-Regular,
    BoldFont           = *-Bold,
    ItalicFont         = *-Regular,
    BoldItalicFont     = *-Bold,
    ItalicFeatures     = FakeSlant,
    BoldItalicFeatures = FakeSlant
  }
%    \end{macrocode}
% \end{variable}
%
% \begin{macro}{\@@_loadfont_stzhongs:,\@@_stzhongs:nn,\@@_stzhongs:n,\@@_stzhongs:}
% \changes{v1.2}{2023/04/30}{在研究生模板载入华文中宋。}
% \changes{v1.3}{2023/10/09}{可以手动指定华文中宋文件位置。}
% 研究生封面额外需要的华文中宋。
%    \begin{macrocode}
\cs_new:Npn \@@_stzhongs:nn #1#2
  { \newCJKfontfamily \@@_stzhongs: {#1} [#2] }
\cs_new:Npn \@@_stzhongs:n { \@@_stzhongs:nn { 华文中宋 } }
\cs_new_protected:Npn \@@_loadfont_stzhongs:
  {
    \cs_if_exist_use:NF \@@_stzhongs:
      {
        \fontspec_font_if_exist:nTF { 华文中宋 }
          { \@@_stzhongs:n { \c_@@_name_fakebold_tl } }
          {
            \bool_if:NTF \g_@@_font_path_bool
              {
                \@@_stzhongs:nn { \c_@@_name_stzhongsfile_tl }
                  { Path = \g_@@_font_path_tl, \c_@@_name_fakebold_tl }
              }
              {
                \cs_set_eq:NN \@@_stzhongs: \rmfamily
                \msg_warning:nn { njuthesis } { missing-stzhongs }
              }
          }
      }
  }
%    \end{macrocode}
% \end{macro}
%
%
% \subsubsection{定义数学字库}
%
% \begin{macro}{\@@_define_math_font:nn}
% 批量定义数学字体配置。
%    \begin{macrocode}
\cs_new:Npn \@@_define_math_font:nn #1#2
  {
    \cs_new:cpn { @@_loadfont_math_ #1 : }
      { \__um_setmathfont:nn { } {#2} }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{
%   \@@_loadfont_math_asana:,
%   \@@_loadfont_math_fira:,
%   \@@_loadfont_math_garamond:,
%   \@@_loadfont_math_lm:,
%   \@@_loadfont_math_libertinus:,
%   \@@_loadfont_math_stix:,
%   \@@_loadfont_math_bonum:,
%   \@@_loadfont_math_dejavu:,
%   \@@_loadfont_math_pagella:,
%   \@@_loadfont_math_schola:,
%   \@@_loadfont_math_termes:}
% 批量定义若干数学字体的载入命令。
%    \begin{macrocode}
\clist_map_inline:nn
  {
    { asana      } { Asana-Math.otf             },
    { fira       } { FiraMath-Regular.otf       },
    { garamond   } { Garamond-Math.otf          },
    { lm         } { latinmodern-math.otf       },
    { libertinus } { LibertinusMath-Regular.otf },
    { stix       } { STIXMath-Regular.otf       },
    { bonum      } { texgyrebonum-math.otf      },
    { dejavu     } { texgyredejavu-math.otf     },
    { pagella    } { texgyrepagella-math.otf    },
    { schola     } { texgyreschola-math.otf     },
    { termes     } { texgyretermes-math.otf     }
  }
  { \@@_define_math_font:nn #1 }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_math_cambria:}
% Cambria Math 字体配置。
%    \begin{macrocode}
\cs_new:Npn \@@_loadfont_math_cambria:
  {
    \bool_if:NTF \g_@@_font_path_bool
      {
        \__um_setmathfont:nn
          { Path = \g_@@_font_path_tl/, FontIndex = 1 }
          { cambria.ttc }
      }
      { \__um_setmathfont:nn { } { Cambria~Math } }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_math_xits:}
% XITS Math 字体。
%    \begin{macrocode}
\cs_new:Npn \@@_loadfont_math_xits:
  {
    \bool_if:NTF \g_@@_opt_math_int_bool
      { \tl_set:Nn  \l_@@_tmpa_tl { 8 } }
      { \tl_clear:N \l_@@_tmpa_tl       }
    \__um_setmathfont:nn
      {
        Extension    = .otf,
        StylisticSet = \l_@@_tmpa_tl,
        BoldFont     = XITSMath-Bold
      }
      { XITSMath-Regular }
    \__um_setmathfont:nn
      {
        Extension    = .otf,
        StylisticSet = 1,
        range        = {cal,bfcal}
      }
      { XITSMath-Regular }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_math_newcm:}
% New Computer Modern Math 字体。
%    \begin{macrocode}
\cs_new:Npn \@@_loadfont_math_newcm:
  {
    \bool_if:NTF \g_@@_opt_math_int_bool
      { \tl_set:Nn  \l_@@_tmpa_tl { 2 } }
      { \tl_clear:N \l_@@_tmpa_tl       }
    \__um_setmathfont:nn
      {
        Extension      = .otf,
        StylisticSet   = \l_@@_tmpa_tl
      }
      { NewCMMath-Book }
    \__um_setmathfont:nn
      {
        Extension      = .otf,
        StylisticSet   = 1,
        range          = {scr,bfscr}
      }
      { NewCMMath-Book }
    \__fontspec_main_setmathrm:nn
      {
        Extension      = .otf,
        UprightFont    = *-Book,
        BoldFont       = *-Bold,
        ItalicFont     = *-BookItalic,
        BoldItalicFont = *-BoldItalic
      }
      { NewCM10 }
    \__fontspec_main_setmathsf:nn
      {
        Extension      = .otf,
        UprightFont    = *-Book,
        BoldFont       = *-Bold,
        ItalicFont     = *-BookOblique,
        BoldItalicFont = *-BoldOblique
      }
      { NewCMSans10 }
    \__fontspec_main_setmathtt:nn
      {
        Extension      = .otf,
        UprightFont    = *-Book,
        ItalicFont     = *-BookItalic,
        BoldFont       = *-Bold,
        BoldItalicFont = *-BoldOblique
      }
      { NewCMMono10 }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_loadfont_math_none:}
% 不进行数学字体配置。
%    \begin{macrocode}
\@@_cs_clear:N \@@_loadfont_math_none:
%    \end{macrocode}
% \end{macro}
%
%
% \subsubsection{载入指定字库}
% \changes{v0.10}{2021/09/28}{修正了数学字体。}
%
% \begin{macro}{\@@_loadfont:}
% 载入字体命令。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_loadfont:
  {
    \use:c { @@_loadfont_latin_ \g_@@_font_latin_tl : }
    \use:c { @@_loadfont_cjk_   \g_@@_font_cjk_tl   : }
%    \end{macrocode}
% 自行定义 \pkg{ctex} 中的四类字体命令。
%    \begin{macrocode}
    \NewDocumentCommand \songti   { } { \CJKfamily { zhsong } }
    \NewDocumentCommand \heiti    { } { \CJKfamily { zhhei  } }
    \NewDocumentCommand \fangsong { } { \CJKfamily { zhfs   } }
    \NewDocumentCommand \kaishu   { } { \CJKfamily { zhkai  } }
%    \end{macrocode}
% \begin{macro}{\bigger}
% 重定义字号命令。
%    \begin{macrocode}
    \NewDocumentCommand \bigger   { } { \ctex_zihao:n { 4   } }
  }
%    \end{macrocode}
% \end{macro}
% \end{macro}
%
% 载入设置的字体。^^A 为了吸收导言区的设置，放在其后载入。
%    \begin{macrocode}
% \BeforeBeginEnvironment { document } { \@@_loadfont: }
\@@_loadfont:
%</class>
%    \end{macrocode}
%
% 只有研究生模板需要华文中宋。我们把它放在文档类最后载入。
%    \begin{macrocode}
%<def-g>\ctex_at_end_preamble:n { \@@_loadfont_stzhongs: }
%    \end{macrocode}
%
%
% \subsection{页面布局}
%
% \subsubsection{页边距}
%
% 使用\pkg{geometry}设置页边距。
%    \begin{macrocode}
%<*class>
\geometry
  {
    vmargin    = 2.54 cm,
    hmargin    = 3.18 cm,
    headheight = 15 pt
  }
%    \end{macrocode}
%
% 草稿模式下显示页面文字范围边界以及页眉、页脚线。
%    \begin{macrocode}
\bool_if:NT \g_@@_opt_draft_bool { \geometry { showframe } }
%    \end{macrocode}
%
%
% \subsubsection{页眉页脚}
% \changes{v1.0}{2022/07/01}{删除 |header/format| 和 |footer/format|。}
% \changes{v1.0}{2022/08/01}{页眉接口更名为 \opt{header} 类。}
% \changes{v1.0}{2022/08/01}{页脚接口更名为 \opt{footer} 类。}
%
% 提供设置页眉页脚的用户接口。在 \tn{fancyhead} 的可选参数中，
% \opt{E} 和 \opt{O} 分别表示在偶数页（even）和奇数页（odd），
% 而 \opt{L}、\opt{R} 和 \opt{C} 则分别表示左（left）、右
% （right）和中间（center）。按照通常的排版规则，在双面模式下，
% 偶数页的中间页眉文字在左，奇数页则在右。单面模式下，左右页眉都要显示。
%    \begin{macrocode}
\keys_define:nn { nju / header }
  {
%    \end{macrocode}
%
% \begin{macro}{header/content,header/content*}
% \changes{v0.16}{2022/03/18}{可手动指定页眉内容。}
% 页眉内容，分别对应双面模式和单面模式。
% 为了便于指定复杂的页眉样式，这里用 |clist| 存储位置和内容信息。
%    \begin{macrocode}
    content  .clist_gset:N = \g_@@_header_twoside_clist,
    content* .clist_gset:N = \g_@@_header_oneside_clist,
    content     .initial:n =
      { { EL } { \leftmark  }, { OR } { \rightmark } },
    content*    .initial:n =
      { {  L } { \leftmark  }, {  R } { \rightmark } }
%    \end{macrocode}
% \end{macro}
%
%    \begin{macrocode}
  }
\keys_define:nn { nju / footer }
  {
%    \end{macrocode}
% \begin{macro}{footer/content,footer/content*}
% \changes{v0.16}{2022/03/18}{可手动指定页脚内容。}
% 页脚内容，同页眉。
%    \begin{macrocode}
    content  .clist_gset:N = \g_@@_footer_twoside_clist,
    content* .clist_gset:N = \g_@@_footer_oneside_clist,
    content     .initial:n = { { C } { \thepage } },
    content*    .initial:n = { { C } { \thepage } }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\g_@@_header_clist,\g_@@_footer_clist}
% 存储页眉页脚内容。
%    \begin{macrocode}
\clist_new:N \g_@@_header_clist
\clist_new:N \g_@@_footer_clist
%    \end{macrocode}
% \end{macro}
%
% 在导言区末尾确定页眉页脚内容。
%    \begin{macrocode}
\ctex_at_end_preamble:n
  {
    \clist_gset_eq:Nc \g_@@_header_clist
      { g_@@_header_ \c_@@_name_pagemode_tl _clist }
    \clist_gset_eq:Nc \g_@@_footer_clist
      { g_@@_footer_ \c_@@_name_pagemode_tl _clist }
  }
%    \end{macrocode}
%
% \begin{macro}{\@@_header:nn,\@@_footer:nn}
% 对 \pkg{fancyhdr} 的命令进行包装，便于设置页眉页脚。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_header:nn #1#2
  { \fancyhead [#1] { \c_@@_fmt_header_tl \nouppercase {#2} } }
\cs_new_protected:Npn \@@_footer:nn #1#2
  { \fancyfoot [#1] { \c_@@_fmt_footer_tl \nouppercase {#2} } }
%    \end{macrocode}
% \end{macro}
%
% 重定义 \pkg{fancyhdr} 的 \opt{plain} 样式，即本科生正文和部分特殊页面使用的
% 页眉页脚样式。页眉无内容；页脚为居中的页码，使用五号新罗马体数字。
% 标记页眉页脚横线宽度的变量并不属于 |dim| 类型，但是采取了该类型的格式。
%    \begin{macrocode}
\fancypagestyle { plain }
  {
    \fancyhf { }
    \clist_map_inline:Nn \g_@@_footer_clist { \@@_footer:nn ##1 }
    \tl_set:Nn \headrulewidth { \c_zero_dim }
    \tl_set:Nn \footrulewidth { \c_zero_dim }
  }
%    \end{macrocode}
%
% \changes{v0.15}{2022/01/17}{修复单页模式的页眉问题。}
% 以 \opt{plain} 样式为基础的 \opt{headings} 样式，用于研究生模板。
%    \begin{macrocode}
\fancypagestyle { headings }
  {
    \fancyhf { }
    \clist_if_empty:NTF \g_@@_header_clist
      {
        \tl_set:Nn \headrulewidth { \c_zero_dim }
      }
      {
        \tl_set:Nn \headrulewidth { 0.4 pt }
        \dim_set:Nn \headheight { 20 pt }
        \clist_map_inline:Nn \g_@@_header_clist
          { \@@_header:nn ##1 }
      }
    \clist_map_inline:Nn \g_@@_footer_clist { \@@_footer:nn ##1 }
    \tl_set:Nn \footrulewidth { \c_zero_dim }
  }
%    \end{macrocode}
%
% \begin{macro}{\frontmatter}
% 重定义 \tn{frontmatter}，设置前言区默认的页眉页脚以及页码样式。
%    \begin{macrocode}
\RenewDocumentCommand \frontmatter { }
  {
    \cleardoublepage
    \exp_args:NV \pagestyle \c_@@_fmt_pagestyle_tl
    \pagenumbering { Roman }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\mainmatter}
% \changes{v0.12}{2021/12/03}{修复了摘要页字体格式泄漏到正文的问题。}
% \changes{v0.12}{2021/12/03}{修复了页眉上长标题重叠的问题。}
% 重定义 \tn{mainmatter}，在论文主体部分载入页面样式设置，
% 使用阿拉伯数字重新进行页码编号。
%    \begin{macrocode}
\RenewDocumentCommand \mainmatter { }
  {
    \cleardoublepage
    \exp_args:NV \pagestyle \c_@@_fmt_pagestyle_tl
    \pagenumbering { arabic }
    \normalfont \normalsize
  }
%    \end{macrocode}
% \end{macro}
%
% \changes{v0.16}{2022/03/18}{研究生模板的目录、摘要等页面也显示页眉。}
% 在文档起始位置设置默认页面样式。
%    \begin{macrocode}
\AtBeginEnvironment { document }
  {
    \exp_args:NV \pagestyle \c_@@_fmt_pagestyle_tl
    \pagenumbering { Roman }
  }
%    \end{macrocode}
%
%
% \subsection{章节标题格式}
%
% \begin{macro}{\@@_bookmark_toc:n,\@@_bookmark_toc:V}
% 为无编号章添加目录条目，需手动指定格式为四号、不加粗、黑体。
%    \begin{macrocode}
\cs_new:Npn \@@_bookmark_toc:n #1
  { \addcontentsline { toc } { chapter } { \c_@@_fmt_chapterintoc_tl #1 } }
\cs_generate_variant:Nn \@@_bookmark_toc:n { V }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_bookmark_toc:nn}
% 为了保持形式一致，进行封装。
%    \begin{macrocode}
\cs_new:Npn \@@_bookmark_toc:nn #1#2
  { \phantomsection \_@@_bookmark_toc:n {#1} }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_bookmark_pdf_nosec:nn,\@@_bookmark_pdf:nn}
% 封装 \pkg{hyperref} 的 PDF 书签命令。
%    \begin{macrocode}
\cs_new:Npn \@@_bookmark_pdf_nosec:nn { \pdfbookmark [0] }
\cs_new:Npn \@@_bookmark_pdf:nn
  { \phantomsection \@@_bookmark_pdf_nosec:nn }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_bookmark:Nnn}
% 书签。
%    \begin{macrocode}
\cs_new:Npn \@@_bookmark:Nnn #1#2#3
  {
    \bool_if:NTF #1
      { \_@@_bookmark_toc:n        {#2}        }
      { \_@@_bookmark_pdf_nosec:nn {#2} {#3} }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_chapter:Nnn,\@@_chapter:cnn,\@@_chapter:n,\@@_chapter:V}
% 含有目录和 PDF 标签的无编号章。
%    \begin{macrocode}
\cs_new:Npn \@@_chapter:Nnn #1#2#3
  {
    \chapter *           {#2}
    \@@_bookmark:Nnn #1  {#2} {#3}
    \@@_chapter_header:n {#2}
  }
\cs_new:Npn \@@_chapter:n #1
  { \@@_chapter:Nnn \c_true_bool {#1} { } }
\cs_generate_variant:Nn \@@_chapter:Nnn { cnn }
\cs_generate_variant:Nn \@@_chapter:n   { V   }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_chapter_header:n}
% 单页模式下，目录、摘要、符号表等特殊页面的页眉中间为相应标题，左右为空。这里通
% 过居中的 \tn{leftmark} 实现。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_chapter_header:n #1
  {
    \bool_if:NTF \g_@@_opt_twoside_bool
      { \markboth {#1} {#1} }
      { \markboth { \hfill #1 \hfill } { } }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\njuchapter}
% 封装无编号章环境，供用户在正文中使用。
%    \begin{macrocode}
\NewDocumentCommand \njuchapter { m } { \@@_chapter:n {#1} }
%    \end{macrocode}
% \end{macro}
%
% |\keys_set:nn{ctex}| 实际相当于 \tn{ctexset}。
%    \begin{macrocode}
\keys_set:nn { ctex }
  {
    chapter        / beforeskip = \c_@@_chapterbefore_dim,
    chapter        / afterskip  = \c_@@_chapterafter_dim,
    chapter        / format     = \c_@@_fmt_chapter_tl,
    section        / format     = \c_@@_fmt_section_tl,
    subsection     / format     = \c_@@_fmt_subsection_tl,
    subsubsection  / format     = \c_@@_fmt_subsubsection_tl,
    paragraph      / format     = \c_@@_fmt_paragraph_tl,
    subparagraph   / format     = \c_@@_fmt_subparagraph_tl,
%    \end{macrocode}
%
%
% \subsection{目录格式}
% \changes{v0.13}{2021/12/09}{移除 \pkg{tocloft}，用 \pkg{ctex} 修改目录样式。}
%
% 设置目录标题默认名称。
%    \begin{macrocode}
    contentsname   = \c_@@_name_tableofcontents_tl,
    listfigurename = \c_@@_name_listoffigures_tl,
    listtablename  = \c_@@_name_listoftables_tl,
%    \end{macrocode}
% 设置目录中章标题的样式。
%    \begin{macrocode}
    chapter / tocline = \c_@@_fmt_chapterintoc_tl \CTEXnumberline {#1} #2
  }
%    \end{macrocode}
%
% \changes{v1.0}{2022/08/01}{整合目录设置项。}
% \begin{macro}{\@@_make_toc:nn,\@@_make_toc:Vn}
% 通过 group 内修改标题设置，将目录页标题格式单独设置为三号粗宋体。
% 目录自身不出现在目录中时需特别处理。参考
% \url{https://tex.stackexchange.com/a/1821}。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_make_toc:nn #1#2
  {
    \group_begin:
      \keys_set:nn { ctex }
        { chapter/format = \c_@@_fmt_toctitle_tl }
      \@@_chapter:cnn { g_@@_ #2 _showentry_bool } {#1} {#2}
    \group_end:
    \@starttoc {#2}
  }
\cs_generate_variant:Nn \@@_make_toc:nn { vn }
%    \end{macrocode}
% \end{macro}
%
% \changes{v0.15}{2022/02/04}{可选择目录自身是否出现在目录中。}
% \begin{macro}{\@@_define_toc_cmd:nnn}
% 重定义目录命令，修改标题格式并插入书签。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_define_toc_cmd:nnn #1#2#3
  {
    \keys_define:nn { nju / #1 }
      {
        toc-entry .bool_gset:c = { g_@@_ #3 _showentry_bool },
        toc-entry   .initial:n = true
      }
    \exp_args:Nc \RenewDocumentCommand {#1} { }
      { \@@_make_toc:vn { #2 name } {#3} }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{
%   \tableofcontents,\listoffigures,\listoftables,
%   tableofcontents/toc-entry,
%   listoffigures/toc-entry,
%   listoftables/toc-entry,
%   \g_@@_toc_showentry_bool,
%   \g_@@_lof_showentry_bool,
%   \g_@@_lot_showentry_bool}
%    \begin{macrocode}
\clist_map_inline:nn
  {
    { tableofcontents } { contents   } { toc },
    { listoffigures   } { listfigure } { lof },
    { listoftables    } { listtable  } { lot }
  }
  { \@@_define_toc_cmd:nnn #1 }
%    \end{macrocode}
% \end{macro}
%
% 如果不显示主目录的条目，则插图目录和表格目录一并不显示。
%    \begin{macrocode}
\ctex_at_end_preamble:n
  {
    \bool_if:NF \g_@@_toc_showentry_bool
      {
        \bool_gset_false:N \g_@@_lof_showentry_bool
        \bool_gset_false:N \g_@@_lot_showentry_bool
      }
  }
%    \end{macrocode}
%
% \begin{macro}{tableofcontents/dotline}
% \changes{v1.0}{2022/08/08}{可选择是否为目录中的章名添加引导线。}
% 修改 \cls{book} 文档类中的命令以添加引导线。
%    \begin{macrocode}
\keys_define:nn { nju / tableofcontents }
  {
    dotline         .choice:,
    dotline / chapter .code:n =
      {
        \cs_set_protected_nopar:Npn \l@chapter
          {
            \skip_vertical:N 1.0 em \@plus \p@ \scan_stop:
            \@dottedtocline { \z@ } { \z@ } { 1.5 em }
          }
      },
    dotline / section .code:n = { }
  }
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{参考文献}
%
% \begin{variable}{\g_@@_blx_option_clist}
% 存储传入 \pkg{biblatex} 的选项列表。
%    \begin{macrocode}
\clist_new:N \g_@@_blx_option_clist
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\g_@@_blx_resource_clist}
% 存储参考文献数据源列表。
%    \begin{macrocode}
\clist_new:N \g_@@_blx_resource_clist
%    \end{macrocode}
% \end{variable}
%
%    \begin{macrocode}
\keys_define:nn { nju / bib }
  {
%    \end{macrocode}
%
% \begin{macro}{bib/style}
% \changes{v0.14}{2021/12/19}{提供选择参考文献样式的接口。}
% \changes{v0.15}{2022/02/11}{可使用国标以外的文献样式。}
% 参考文献样式。国家标准为顺序编码制 \opt{numeric} 和著者-出版年制
% \opt{author-year}，分别对应 \pkg{biblatex} 的 \opt{gb7714-2015}
% 和 \opt{gb7714-2015ay} 样式。其余样式一律视作 \opt{unknown}。用户
% 选取的样式会被加入选项列表中，以待传进 \pkg{biblatex} 宏包。
%    \begin{macrocode}
    style             .choice:,
    style / numeric     .code:n =
      {
        \clist_gput_right:Nn \g_@@_blx_option_clist
          { style = gb7714-2015      }
      },
    style / author-year .code:n =
      {
        \clist_gput_right:Nn \g_@@_blx_option_clist
          { style = gb7714-2015ay    }
      },
    style / unknown     .code:n =
      { \clist_gput_right:Nn \g_@@_blx_option_clist { style = #1 } },
    style            .initial:n = numeric,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{bib/option}
% \changes{v0.15}{2022/02/15}{提供传入 \pkg{biblatex} 宏包选项的接口。}
% 待传入 \pkg{biblatex} 的额外宏包选项，以列表形式储存。
% 更为常见的参考文献样式设置已由 \opt{bib/style} 提供，
% 两者中后传入的设置会覆盖已有的设定。本设置项等效于在导言区使用
% |\PassoptionsToPackage{|\meta{key}|=|\meta{value}|}{biblatex}| 命令。
%    \begin{macrocode}
    option              .code:n =
      {
            \clist_gput_right:NV \g_@@_blx_option_clist
              \l_keys_value_tl
      },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{bib/resource}
% \changes{v0.14}{2021/12/19}{提供批量导入参考文献数据源的接口。}
% 参考文献数据源，以列表形式储存。
%    \begin{macrocode}
    resource            .code:n =
      { \clist_gput_right:NV \g_@@_blx_resource_clist \l_keys_value_tl },
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\addbibresource}
% 为了吸收用户在导言区设置的选项，\pkg{biblatex} 宏包被设置在导言区末尾才会载
% 入。此处单独定义了可以在导言区使用的 \tn{addbibresource} 命令，用于兼容传统的
% 添加参考文献数据源的方法。
%    \begin{macrocode}
\bool_if:NT \g_@@_opt_load_blx_bool
  {
    \NewDocumentCommand \addbibresource { m }
      { \clist_gput_right:Nn \g_@@_blx_resource_clist {#1} }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_blx_pre_setup:}
% 载入 \pkg{biblatex} 宏包前，必须禁用自行定义的 \tn{addbibresource}
% 命令，并传入用户设置的选项。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_blx_pre_setup:
  {
    \cs_undefine:N \addbibresource
    \clist_gput_right:Nn \g_@@_blx_option_clist { backend = biber }
    \exp_args:NV \PassOptionsToPackage \g_@@_blx_option_clist { biblatex }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_blx_post_setup:}
% \pkg{biblatex} 宏包载入后的设置。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_blx_post_setup:
  {
%    \end{macrocode}
% \changes{v0.12}{2021/12/06}{设置输出参考文献的默认选项。}
% \changes{v0.15}{2022/02/17}{可在每章后附上参考文献表。}
% 修改参考文献的头部样式，自动添加目录条目。默认为 |chapter| 级别。
% 如果需要在每章后附上一个参考文献表，即对 \pkg{biblatex} 传入了
%  |refsection = chapter| 选项，则默认为 |section| 级别。
%    \begin{macrocode}
    \defbibheading { njubibintoc } [ \bibname ] { \@@_chapter:n { ##1 } }
    \tl_if_eq:NnTF \blx@refsecreset@level { 2 }
      { \DeclarePrintbibliographyDefaults { heading = subbibintoc } }
      { \DeclarePrintbibliographyDefaults { heading = njubibintoc } }
%    \end{macrocode}
% 传入参考文献源文件，此时可正常使用 \tn{addbibresource} 命令。
%    \begin{macrocode}
    \clist_map_inline:Nn \g_@@_blx_resource_clist
      { \addbibresource { ##1 } }
  }
%    \end{macrocode}
% \end{macro}
%
% 使用 \pkg{etoolbox} 提供的 \tn{BeforeBeginEnvironment}，在 \env{document} 环境
% 开始的钩子前载入 \pkg{biblatex} 并进行相关设置。
%    \begin{macrocode}
\bool_if:NT \g_@@_opt_load_blx_bool
  {
    \BeforeBeginEnvironment { document }
      {
        \@@_blx_pre_setup:
        \RequirePackage { biblatex }
        \@@_blx_post_setup:
      }
  }
%    \end{macrocode}
%
%
% \subsection{引用}
%
% \changes{v1.3}{2024/03/06}{将可能需要覆盖的 \pkg{hyperref} 设置移动到导言区前。}
%    \begin{macrocode}
\hypersetup
  {
    bookmarksnumbered = true,
    psdextra          = true,
    unicode           = true,
    hidelinks
  }
%    \end{macrocode}
% \changes{v0.17}{2022/04/09}{PDF 书签中不生成额外空格。}
% 忽略 PDF 字符串中的特定命令，从而抑制 \pkg{hyperref} 警告。
%    \begin{macrocode}
\pdfstringdefDisableCommands
  {
    \clist_map_inline:nn
      { \\, \quad, \qquad, \bigger }
      { \@@_cs_clear:N #1 }
  }
%    \end{macrocode}
% 在导言区末尾进行 \pkg{hyperref} 设置。填写 PDF 元信息。
% \changes{v0.11}{2021/10/01}{写入 PDF 元数据。}
%    \begin{macrocode}
\ctex_at_end_preamble:n
  {
    \hypersetup
      {
        pdftitle    = \g_@@_info_title_tl,
        pdfauthor   = \g_@@_info_author_tl,
        pdfkeywords = \g_@@_info_keywords_clist,
        pdfcreator  = \c_@@_name_pdfcreator_tl
      }
  }
%    \end{macrocode}
%
% \begin{macro}{\@@_cref_name:n}
% 用于修改 \pkg{cleveref} 的标签名称的辅助函数。
% \begin{arguments}
%   \item 标签名
% \end{arguments}
%    \begin{macrocode}
\cs_new:Npn \@@_cref_name:n #1
  { \crefname {#1} { \@@_name:n {#1} } { \@@_name:n {#1} } }
%    \end{macrocode}
% \end{macro}
%
% 修改 \pkg{cleveref} 的标签格式。默认在名称后面添加空格，删除公式编号的括号。
%    \begin{macrocode}
\bool_if:NT \g_@@_opt_load_cref_bool
  {
    \crefdefaultlabelformat { #2#1#3\, }
    \crefformat { equation      } { 公式~#2#1#3~   }
    \crefformat { chapter       } { 第#2#1#3章     }
    \crefformat { section       } { 第~#2#1#3~节   }
    \crefformat { subsection    } { 第~#2#1#3~小节 }
    \crefformat { subsubsection } { 第~#2#1#3~小节 }
%    \end{macrocode}
% 修改 \pkg{cleveref} 的标签名称。
%    \begin{macrocode}
    \clist_map_inline:nn { figure, table, appendix }
      { \@@_cref_name:n {#1} }
  }
%    \end{macrocode}
%
%
% \subsection{脚注}
% \changes{v0.18}{2022/05/01}{提供脚注设置项。}
% ^^A 借鉴 fduthesis
%
% \begin{variable}{\g_@@_fn_ctext_option_clist}
% 存储传入 \pkg{circledtext} 宏包的选项列表。
% 由于当前版本放在编号位置的带圈数字无法正确缩放，这里手动指定了字体大小。
%    \begin{macrocode}
\clist_gset:Nn \g_@@_fn_ctext_option_clist { charf = \scriptsize }
%    \end{macrocode}
% \end{variable}
%
%    \begin{macrocode}
\keys_define:nn { nju / footnote }
  {
%    \end{macrocode}
% \begin{macro}{footnote/style}
% \changes{v1.1}{2022/10/16}{增加 \opt{circled} 和 \opt{circled*} 选项。}
% 脚注编号的样式。
%    \begin{macrocode}
    style .choices:nn = { plain, pifont, circled, circled* }
      {
        \int_case:nnF { \l_keys_choice_int }
          {
%    \end{macrocode}
% \opt{pifont} 类型，用作对旧发行版的兼容选项。
%    \begin{macrocode}
            { 2 }
              {
                \RequirePackage { pifont }
                \cs_set_eq:NN \@@_fn_number:N \@@_fn_number_pifont:N
              }
%    \end{macrocode}
% \opt{circled} 类型，带星号的版本为阴文，需引入 \pkg{circledtext} 宏包。
%    \begin{macrocode}
            { 3 }
              {
                \RequirePackage { circledtext }
                \cs_set:Npn \@@_fn_number:N
                  { \@@_fn_number_circled:NV \c_false_bool }
              }
            { 4 }
              {
                \RequirePackage { circledtext }
                \cs_set:Npn \@@_fn_number:N
                  { \@@_fn_number_circled:NV \c_true_bool }
              }
          }
%    \end{macrocode}
% \opt{plain} 或未知类型直接使用计数器的值。
%    \begin{macrocode}
          { \cs_set_eq:NN \@@_fn_number:N \int_use:N }
      },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{footnote/circledtext-option}
% \changes{v1.1}{2022/10/16}{将生成脚注圈码的 \pkg{pifont} 替换为 \pkg{circledtext}。}
% \pkg{circledtext} 宏包选项。
%    \begin{macrocode}
    circledtext-option .code:n =
      { \clist_gput_right:Nn \g_@@_fn_ctext_option_clist {#1} },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{footnote/hang}
% \changes{v1.1}{2022/10/16}{新增悬挂缩进选项。}
% 是否悬挂缩进。
%    \begin{macrocode}
    hang             .choice:,
    hang / true        .code:n =
      {
        \cs_set:Npn \@@_fn_hang:
          {
            \int_set:Nn \tex_hangafter:D { 1 }
            \dim_set_eq:NN \tex_hangindent:D \c_@@_fnhang_dim
          }
      },
    hang / false       .code:n = { \@@_cs_clear:N \@@_fn_hang: },
    hang            .initial:n = true
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_fn_number_pifont:N}
% \opt{pifont} 选项提供的带圈数字。
%    \begin{macrocode}
\cs_new:Npn \@@_fn_number_pifont:N #1 { \ding { \int_eval:n { 171 + #1 } } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_fn_number_circled:Nn,\@@_fn_number_circled:NV}
% \opt{circled} 选项提供的带圈数字。
%    \begin{macrocode}
\cs_generate_variant:Nn \__circledtext_handle:nn { Vn }
\cs_new_protected:Npn \@@_fn_number_circled:Nn #1#2
  {
    \group_begin:
      \bool_set_eq:NN \l__circledtext_negative_bool #1
      \__circledtext_handle:Vn \g_@@_fn_ctext_option_clist {#2}
    \group_end:
  }
\cs_generate_variant:Nn \@@_fn_number_circled:Nn { NV }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_fn_number:N}
% 脚注编号。默认使用计数器 |footnote| 的值。
%    \begin{macrocode}
\cs_new_eq:NN \@@_fn_number:N \int_use:N
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\thefootnote}
% 重定义脚注编号。
%    \begin{macrocode}
\bool_if:NT \g_@@_opt_load_fm_bool
  {
    \cs_set:Npn \thefootnote { \@@_fn_number:N \c@footnote }
%    \end{macrocode}
% \end{macro}
%
% \subsubsection{整体样式}
%
% \begin{macro}[int]{\@makefntext}
% 重定义内部脚注文字命令，使脚注编号不使用上标，宽度为 \qty{1.5}{em}
% \footnote{\url{http://tex.stackexchange.com/q/19844},
% \url{https://www.zhihu.com/question/53030087}}，
% 并自行实现悬挂缩进。注意这个操作会使 \pkg{footmisc} 宏包内建的 \opt{hang} 选项失效。
%    \begin{macrocode}
    \cs_set:Npn \@makefntext #1
      {
        \mode_leave_vertical:
        \hbox_to_wd:nn { \c_@@_fnhang_dim } { \@thefnmark \tex_hfil:D }
        \tex_penalty:D \@M
        \@@_fn_hang:
        #1
      }
  }
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{图片表格}
%
% \begin{macro}{image/path}
% \changes{v1.0}{2022/08/06}{提供图片路径设置。}
% 外置图片路径，等效于 \tn{graphicspath}。
%    \begin{macrocode}
\keys_define:nn { nju / image } { path .code:n = { \graphicspath {#1} } }
%    \end{macrocode}
% \end{macro}
%
% 设置默认图片扩展名，允许在不键入扩展名时自动进行补全。
%    \begin{macrocode}
\DeclareGraphicsExtensions { .pdf, .eps, .jpg, .png }
%    \end{macrocode}
%
% \changes{v0.16}{2022/03/11}{表格内字体设为五号。}
% \changes{v1.0}{2022/08/06}{兼容 \pkg{tabularray} 设置。}
% \changes{v1.3}{2024/03/06}{调整 \pkg{tabularray} 设置。}
% 表格默认居中，字号设置为五号。^^A  https://www.zhihu.com/question/366803177/answer/977853129
%    \begin{macrocode}
\BeforeBeginEnvironment { tabular } { \centering \c_@@_fmt_tabular_tl }
\ctex_at_end_package:nn { tabularray }
  {
%    \end{macrocode}
% 等效于 \tn{UseTblrLibrary}、\tn{SetTblrInner} 与 \tn{SetTblrOuter}。
%    \begin{macrocode}
    \__tblr_use_lib_booktabs:
    \tl_set:Nn \l_@@_tmpb_tl
      { , abovesep = 4 pt, stretch  = 0.8, cells = { font = \c_@@_fmt_tabular_tl } }
    \tl_put_right:NV \l__tblr_default_tblr_inner_tl     \l_@@_tmpb_tl
    \tl_put_right:NV \l__tblr_default_talltblr_inner_tl \l_@@_tmpb_tl
    \tl_put_right:NV \l__tblr_default_longtblr_inner_tl \l_@@_tmpb_tl
%    \end{macrocode}
% 为了和标准文档类中的间距一致，文档介绍的值为 \qty{10}{pt}，实际是 \qty{12.63}{pt}。
%    \begin{macrocode}
    \tl_put_right:Nn \l__tblr_default_talltblr_outer_tl { , headsep = 12.63 pt }
    \tl_put_right:Nn \l__tblr_default_longtblr_outer_tl { , headsep = 12.63 pt }
%    \end{macrocode}
% 处理 \env{talltblr} 表注的限宽问题。
% \footnote{\url{https://github.com/lvjr/tabularray/issues/255}}
%    \begin{macrocode}
    \DefTblrTemplate { caption-tag } { default }
      { \c_@@_name_table_tl \hspace { 0.25em } \thetable }
    \DefTblrTemplate { caption-sep } { default } { \quad }
    \DefTblrTemplate { firsthead   } { caption }
      {
        \makebox [ \tablewidth ]
          { \parbox { \columnwidth } { \UseTblrTemplate {caption} {normal} } }
      }
    \SetTblrTemplate { firsthead   } { caption }
    \SetTblrStyle { caption } { font = \normalfont \bfseries \small }
    \SetTblrStyle { note    } { font = \normalfont \footnotesize    }
    \SetTblrStyle { remark  } { font = \normalfont \footnotesize    }
  }
%    \end{macrocode}
%
% \changes{v0.12}{2021/12/06}{删除了可能导致冲突的 \pkg{floatrow}。}
% \changes{v0.18}{2022/05/08}{图表标题使用粗体。}
% 图表标题样式。文字设置为五号宋体，标签设置为粗体，间隔一个全角空格。
%    \begin{macrocode}
\DeclareCaptionStyle{njucap}
  {
    font          = {small, bf},
    labelsep      = quad,
    justification = centering
  }
\captionsetup [ figure ] { style = njucap }
\captionsetup [ table  ] { style = njucap }
%    \end{macrocode}
%
% \begin{macro}{\ctex_patch_cmd:Nnn}
%    \begin{macrocode}
\cs_generate_variant:Nn \ctex_patch_cmd:Nnn { cnv }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{label-sep/figure,label-sep/table,label-sep/equation}
% \changes{v1.0}{2022/07/31}{添加编号连接符设置项。}
% 修改图片、表格、公式编号中的连接符。
% \footnote{\url{https://tex.stackexchange.com/q/61756/}}
%    \begin{macrocode}
\clist_map_inline:nn { figure, table, equation }
  {
    \keys_define:nn { nju / label-sep }
      {
        #1 .tl_gset:c = { g_@@_sep_ #1 _tl },
%    \end{macrocode}
% 根据本科生撰写规范的建议，默认连接符为短横线（en dash）。
%    \begin{macrocode}
        #1 .initial:n = { - }
      }
    \@@_at_begin_document:n
      { \ctex_patch_cmd:cnv { the #1 } {.} { g_@@_sep_ #1 _tl } }
  }
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{列表环境}
% \changes{v0.12}{2021/12/07}{删除了 \pkg{enumitem} 的部分列表环境设置。}
%
% 缩减列表环境的条目间距。
%    \begin{macrocode}
\bool_if:NT \g_@@_opt_load_enit_bool { \setlist { noitemsep } }
%    \end{macrocode}
%
%
% \subsection{定理环境}
% \changes{v0.18}{2022/04/21}{新增定理环境的若干定制项。}
%
% \begin{macro}{\c_@@_name_qed_tl}
% 证毕符号使用 \tn{mdlgwhtsquare} 绘制，对应于 |U+25A1| 字符。
% \footnote{\url{https://tex.stackexchange.com/q/567135/}}
% 如果 \pkg{unicode-math} 未载入，则使用黑色方块代替。
%    \begin{macrocode}
\bool_if:NTF \g_@@_opt_load_um_bool
  { \tl_const:Nn \c_@@_name_qed_tl { \ensuremath { \mdlgwhtsquare    } } }
  { \tl_const:Nn \c_@@_name_qed_tl { \ensuremath { \rule {1ex} {1ex} } } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\l_@@_thm_share_tl}
% 存储共享的计数器名称。
%    \begin{macrocode}
\tl_new:N \l_@@_thm_share_tl
%    \end{macrocode}
% \end{macro}
%
%    \begin{macrocode}
\keys_define:nn { nju / theorem }
  {
%    \end{macrocode}
% \begin{macro}{theorem/style,theorem/header-font,theorem/body-font,
%   theorem/qed-symbol,theorem/counter}
% 定义 |nju/theorem| 键值类。^^A 这是否也可以抽象到 xtemplate？
% 目前这套选项只适用于模板预定义的若干种定理环境。
%    \begin{macrocode}
    style           .tl_set:N = \l_@@_thm_style_tl,
    header-font     .tl_set:N = \l_@@_thm_header_font_tl,
    body-font       .tl_set:N = \l_@@_thm_body_font_tl,
    qed-symbol      .tl_set:N = \l_@@_thm_qed_symbol_tl,
    counter         .tl_set:N = \l_@@_thm_counter_tl,
%    \end{macrocode}
% 定理环境的缺省值。
%    \begin{macrocode}
    style          .initial:n = plain,
    header-font    .initial:n = \normalfont \bfseries,
    body-font      .initial:n = \itshape,
    qed-symbol     .initial:V = \c_@@_name_qed_tl,
    counter        .initial:n = chapter,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{theorem/type}
% 定义定理类环境。
%    \begin{macrocode}
    type        .clist_gset:N = \g_@@_thm_type_clist,
    type           .initial:n =
      {
        { axiom      } { 公理 },
        { corollary  } { 推论 },
        { definition } { 定义 },
        { example    } { 例   },
        { lemma      } { 引理 },
        { proof, *+  } { 证明 },
        { theorem    } { 定理 }
      },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{theorem/share-counter}
% \changes{v1.3}{2023/05/07}{批量创建定理类环境时可以共享计数器。}
% 是否在分组内使用同一计数器。
%    \begin{macrocode}
    share-counter .bool_set:N = \l_@@_thm_share_bool,
    share-counter  .initial:n = false,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{theorem/define}
% 创建定理类环境。
%    \begin{macrocode}
    define .value_forbidden:n = true,
    define            .code:n =
      {
        \clist_if_empty:NT \g_@@_thm_type_clist
          { \msg_error:nn { njuthesis } { empty-theorem-type } }
        \tl_clear:N \l_@@_thm_share_tl
        \clist_map_inline:Nn \g_@@_thm_type_clist
          { \@@_thm_define:Nnn \l_@@_thm_share_tl ##1 }
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_thm_define:Nnn}
% 配置定理环境。
% \begin{arguments}
%   \item 共享的计数器名称，|tl| 型变量
%   \item 环境名与类型标识，|clist| 型变量
%   \item 定理头名称
% \end{arguments}
%    \begin{macrocode}
\cs_new:Npn \@@_thm_define:Nnn
  { \@@_thm_define:NNNNnn \l_@@_tmp_clist \l_@@_tmpa_tl \l_@@_tmpb_tl }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_thm_define:NNNNnn}
%    \begin{macrocode}
\cs_new:Npn \@@_thm_define:NNNNnn #1#2#3#4#5#6
  {
    \bool_if:NF \g_@@_opt_load_nthm_bool
      { \msg_error:nn { njuthesis } { missing-ntheorem } }
    \exp_args:NV \theoremstyle      \l_@@_thm_style_tl
    \exp_args:NV \theoremheaderfont \l_@@_thm_header_font_tl
    \exp_args:NV \theorembodyfont   \l_@@_thm_body_font_tl
%    \end{macrocode}
% 拆分环境名与类型标识。这里是考虑到标识符不一定出现在环境名中，
% 典型如 \env{proof} 环境默认无编号但也不含星号。
%    \begin{macrocode}
    \clist_set:Nn #1 {#5}
    \clist_pop:NN #1 #2
    \clist_pop:NN #1 #3
%    \end{macrocode}
% 判断是否需要证毕符号或编号。
%    \begin{macrocode}
    \tl_if_in:NnT  #3 { + }
      { \exp_args:NV \theoremsymbol \l_@@_thm_qed_symbol_tl }
    \tl_if_in:NnTF #3 { * }
      { \@@_thm_new:VVVn #2 \c_novalue_tl        #4 {#6} }
      { \@@_thm_new:VVVn #2 \l_@@_thm_counter_tl #4 {#6} }
%    \end{macrocode}
% 存储共享的计数器。
%    \begin{macrocode}
    \bool_if:NT \l_@@_thm_share_bool
      {
        \tl_gset_eq:NN #4 #2
        \bool_gset_false:N \l_@@_thm_share_bool
      }
%    \end{macrocode}
% 设置 \pkg{cleveref} 引用名。
%    \begin{macrocode}
    \bool_if:NT \g_@@_opt_load_cref_bool
      { \exp_args:NV \crefname #2 {#6} {#6} }
%    \end{macrocode}
% 清除保存的证毕符号。
%    \begin{macrocode}
    \theoremsymbol { }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_thm_new:nnnn,\@@_thm_new:VVVn}
% 包装 \tn{newtheorem} 以便展开输入的变量。根据 \file{interface3.pdf}
% 手册 5.3 节最后一段建议的展开顺序，这里将 |V| 型参数放在靠前的位置。
% \begin{arguments}
%   \item 环境名
%   \item 计数器名
%   \item 头名称
% \end{arguments}
% 根据环境结束命令是否存在可以判断该环境是否有定义，
% 相应地可以利用局部定义切换定义和重定义环境的命令。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_thm_new:nnnn #1#2#3#4
  {
    \group_begin:
      \cs_if_exist:cT { end #1 }
        { \cs_set_eq:NN \newtheorem \renewtheorem }
      \tl_if_novalue:nTF {#2}
        { \newtheorem * {#1} {#4} }
        {
          \tl_if_empty:nTF {#3}
            { \newtheorem {#1}      {#4} [#2] }
            { \newtheorem {#1} [#3] {#4}      }
        }
    \group_end:
  }
\cs_generate_variant:Nn \@@_thm_new:nnnn { VVVn }
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{公式样式}
% \changes{v1.0}{2022/07/31}{新增若干公式样式设置。}
%
% \begin{variable}{
%   \g_@@_opt_math_re_bool,
%   \g_@@_opt_math_int_bool,
%   \g_@@_opt_math_leq_bool,
%   \g_@@_opt_math_vec_bool}
% 用于以下若干选项的 |bool| 变量。
%    \begin{macrocode}
\bool_new:N \g_@@_opt_math_re_bool
\bool_new:N \g_@@_opt_math_int_bool
\bool_new:N \g_@@_opt_math_leq_bool
\bool_new:N \g_@@_opt_math_vec_bool
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\c_@@_name_integral_tl}
% 保存 \pkg{unicode-math} 内置的所有积分号命令。
%    \begin{macrocode}
\bool_if:NTF \g_@@_opt_load_um_bool
  { \tl_set_eq:NN \c_@@_name_integral_tl \l__um_nolimits_tl }
  { \tl_set_eq:NN \c_@@_name_integral_tl \c_empty_tl        }
%    \end{macrocode}
% \end{variable}
%
% \begin{macro}{\@@_um_setup:n}
% 封装 \tn{unimathsetup}。
%    \begin{macrocode}
\bool_if:NTF \g_@@_opt_load_um_bool
  { \cs_new:Npn   \@@_um_setup:n #1 { \keys_set:nn { unicode-math } {#1} } }
  { \cs_new_eq:NN \@@_um_setup:n \use_none:n }
%    \end{macrocode}
% \end{macro}
%
% ^^A 选项名称来自 thuthesis
%    \begin{macrocode}
\keys_define:nn { nju / math }
  {
%    \end{macrocode}
% \begin{macro}{math/integral}
% 积分号样式，直立或倾斜。
%    \begin{macrocode}
    integral                      .choice:,
    integral / upright              .code:n  =
      { \bool_gset_true:N  \g_@@_opt_math_int_bool },
    integral / slanted              .code:n  =
      { \bool_gset_false:N \g_@@_opt_math_int_bool },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{math/integral-limits}
% 积分号上下限的位置，在上下或在右侧。
% 两个选项分别相当于 \tn{removenolimits} 和 \tn{addnolimits}。
%    \begin{macrocode}
    integral-limits               .choice:,
    integral-limits / true          .code:n  =
      { \tl_clear:N   \l__um_nolimits_tl },
    integral-limits / false         .code:n  =
      { \tl_set_eq:NN \l__um_nolimits_tl \c_@@_name_integral_tl },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{math/less-than-or-equal}
% 小于等于号和大于等于号的横线样式，倾斜或水平。
%    \begin{macrocode}
    less-than-or-equal            .choice:,
    less-than-or-equal / slanted    .code:n  =
      { \bool_gset_true:N  \g_@@_opt_math_leq_bool },
    less-than-or-equal / horizontal .code:n  =
      { \bool_gset_false:N \g_@@_opt_math_leq_bool },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{math/math-ellipsis}
% 省略号的样式，居中或底部。
%    \begin{macrocode}
    math-ellipsis                 .choice:,
    math-ellipsis / centered        .code:n  =
      {
        \DeclareRobustCommand \mathellipsis
          { \mathinner { \unicodecdots    } }
      },
    math-ellipsis / lower           .code:n  =
      {
        \DeclareRobustCommand \mathellipsis
          { \mathinner { \unicodeellipsis } }
      },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{math/partial}
% 偏微分号样式，正体或斜体。
%    \begin{macrocode}
    partial                      .choices:nn =
      { upright, italic } { \@@_um_setup:n { partial = #1 } },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{math/real-part}
% 实部和虚部符号的样式，罗马体或花体。
%    \begin{macrocode}
    real-part                     .choice:,
    real-part / roman               .code:n  =
      { \bool_set_true:N  \g_@@_opt_math_re_bool },
    real-part / fraktur             .code:n  =
      { \bool_set_false:N \g_@@_opt_math_re_bool },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{math/vector}
% 向量符号样式，粗斜体或箭头。
%    \begin{macrocode}
    vector                        .choice:,
    vector / boldfont               .code:n  =
      { \bool_gset_true:N  \g_@@_opt_math_vec_bool },
    vector / arrow                  .code:n  =
      { \bool_gset_false:N \g_@@_opt_math_vec_bool },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{math/uppercase-greek}
% 大写希腊字母的样式，正体或斜体。
%    \begin{macrocode}
    uppercase-greek               .choice:,
    uppercase-greek / upright       .code:n  =
      { \@@_um_setup:n { math-style = ISO } },
    uppercase-greek / italic        .code:n  =
      { \@@_um_setup:n { math-style = TeX } },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{math/style}
% 整体样式。
%    \begin{macrocode}
    style                         .choice:,
    style / TeX                     .code:n  =
      {
        \keys_set:nn { nju / math }
          {
            integral           = slanted,
            integral-limits    = false,
            less-than-or-equal = horizontal,
            math-ellipsis      = centered,
            partial            = italic,
            real-part          = fraktur,
            vector             = arrow,
            uppercase-greek    = upright
          }
        \@@_um_setup:n { bold-style = TeX }
      },
    style / ISO                     .code:n  =
      {
        \keys_set:nn { nju / math }
          {
            integral           = upright,
            integral-limits    = true,
            less-than-or-equal = horizontal,
            math-ellipsis      = lower,
            partial            = upright,
            real-part          = roman,
            vector             = arrow,
            uppercase-greek    = italic
          }
        \@@_um_setup:n { bold-style = ISO }
      },
    style / GB                      .code:n  =
      {
        \keys_set:nn { nju / math }
          {
            integral           = upright,
            integral-limits    = false,
            less-than-or-equal = slanted,
            math-ellipsis      = centered,
            partial            = upright,
            real-part          = roman,
            vector             = boldfont,
            uppercase-greek    = italic
          }
        \@@_um_setup:n { bold-style = ISO }
      },
    style                        .initial:n  = GB
  }
%    \end{macrocode}
% \end{macro}
%
% \changes{v1.3}{2023/05/22}{禁用 \pkg{unicode-math} 时不配置数学字体。}
% 在 |\begin{document}| 处载入字体以兼容 \pkg{mathtools}，
% 并设置小于等于号和实部符号等的样式。
%    \begin{macrocode}
\bool_if:NT \g_@@_opt_load_um_bool
  {
    \@@_at_begin_document:n
      {
        \use:c { @@_loadfont_math_ \g_@@_font_math_tl : }
        \bool_if:NT \g_@@_opt_math_leq_bool
          {
            \cs_set_eq:NN \le  \leqslant
            \cs_set_eq:NN \ge  \geqslant
            \cs_set_eq:NN \leq \leqslant
            \cs_set_eq:NN \geq \geqslant
          }
        \bool_if:NT \g_@@_opt_math_re_bool
          {
            \cs_set:Npn \Re { \operatorname { Re } }
            \cs_set:Npn \Im { \operatorname { Im } }
          }
        \bool_if:NT \g_@@_opt_math_vec_bool
          { \cs_set_eq:NN \vec \symbf }
      }
  }
%</class>
%    \end{macrocode}
%
%
% \subsection{封面}
%
% \subsubsection{绘制部件}
% \changes{v0.16}{2022/03/01}{将封面部件分离到 \file{.def} 文件。}
%
% \paragraph{本科生}
%
% \subparagraph{封面}
%
% \begin{macro}{u/cover/emblem-img}
% \changes{v1.1}{2023/01/15}{本科生模板封面校徽居中。}
% \changes{v1.2}{2023/05/02}{更正本科生模板封面字体和行距。}
% 本科生封面校徽图片实例。
%    \begin{macrocode}
%<*def-u>
\@@_declare_element:nn { u / cover / emblem-img }
  {
    content     = \@@_emblem:N \c_@@_emblemwd_dim,
    bottom-skip = 1.2 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{u/cover/name-img}
% 本科生封面校名图片实例。
%    \begin{macrocode}
\@@_declare_element:nn { u / cover / name-img }
  {
    content     = \@@_name:N \c_@@_namewd_dim,
    bottom-skip = 1 cm,
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{u/cover/title}
% 本科生封面标题实例。
%    \begin{macrocode}
\@@_declare_element:nn { u / cover / title }
  {
    content     = \@@_name:n { type },
    format      = \zihao { 1 } \bfseries \@@_set_ccglue:n { .5 em },
    bottom-skip = 0 cm plus 1 fill
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{u/cover/info}
% \changes{v1.3}{2023/05/25}{将本科生封面信息恢复至 v1.1 的宋体格式。}
% 本科生封面信息栏实例。
%    \begin{macrocode}
\@@_declare_element:nn { u / cover / info }
  {
    content = \@@_u_cover_info:,
    format  = \zihao { 3 }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_u_cover_info:NNNN}
% 本科生封面信息栏。
% \begin{arguments}
%   \item 名称盒子宽度，|dim| 型变量
%   \item 长内容盒子宽度，|dim| 型变量
%   \item 间隔宽度，|dim| 型变量
%   \item 标签格式
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_u_cover_info:NNNN #1#2#3#4
  {
    \@@_cover_entry:NNNn #1 #2 #4 { dept  }
    \@@_cover_entry:NNNn #1 #2 #4 { major }
    \@@_cover_entry_title:NNN #1 #2 #4
%    \end{macrocode}
% 短内容盒子的长度值是通过计算得到的。|dim| 型变量的乘除需要采取
% \cs{dim_ratio:nn} 提供的形式。
%    \begin{macrocode}
    \dim_set:Nn \l_@@_tmpb_dim { #2 * 1/2 - #1 * 1/2 - #3 }
    \@@_cover_entry:NNNnn #1 \l_@@_tmpb_dim #4 { grade } { id }
    \@@_cover_entry:NNNn #1 #2 #4 { author }
    \@@_cover_entry_supv:NNNn #1 \l_@@_tmpb_dim #4 { supv }
    \bool_if:NT \g_@@_opt_supvii_bool
      { \@@_cover_entry_supv:NNNn #1 \l_@@_tmpb_dim #4 { supvii } }
    \@@_cover_entry:NNNn #1 #2 #4 { submitdate }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_u_cover_info:}
%    \begin{macrocode}
\cs_new:Npn \@@_u_cover_info:
  {
    \@@_u_cover_info:NNNN \c_@@_clabelwd_dim \c_@@_crulewd_dim
      \c_@@_hsep_dim \kaishu
  }
%    \end{macrocode}
% \end{macro}
%
% \subparagraph{诚信承诺书}
% \changes{v1.2}{2023/05/02}{更正本科生模板承诺书行距。}
%
% \begin{macro}{u/decl/orig/emblem}
% 本科生诚信承诺书校徽实例。
%    \begin{macrocode}
\@@_declare_element:nn { u / decl / orig / emblem }
  {
    content     = \@@_emblem:N \c_@@_emblemwdi_dim,
    bottom-skip = 30 pt
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{u/decl/orig/title}
% 本科生诚信承诺书标题实例。
% Word 模板中的行距是固定值 \qty{36}{bp}，这里需要除以 1.625 的 \tn{linespread}。
%    \begin{macrocode}
\@@_declare_element:nn { u / decl / orig / title }
  {
    content     = \c_@@_name_origdecl_tl,
    format      = \sffamily \@@_fontsize:nn { 24 bp } { 22.15 bp } \bfseries,
    bottom-skip = 50 pt
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{u/decl/orig/text}
% 本科生诚信承诺书文本实例。
%    \begin{macrocode}
\@@_declare_element:nn { u / decl / orig / text }
  {
    content     = \c_@@_text_origdecl_tl,
    format      = \@@_zihao:nn { 1.9 } { -3 },
    align       = n,
    bottom-skip = 2.7 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{u/decl/orig/sign}
% 本科生诚信承诺书签名区实例。
%    \begin{macrocode}
\@@_declare_element:nn { u / decl / orig / sign }
  {
    content = \@@_decl_sign:,
    format  = \zihao { -3 } \sffamily,
    align   = r
  }
%</def-u>
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_decl_sign:}
% 通用的承诺书签名区。
%    \begin{macrocode}
%<*(def-u|def-g)>
\cs_new_protected:Npn \@@_decl_sign:
  {
%<def-u>    \clist_map_inline:nn { origsign, id, date }
%<def-g>    \clist_map_inline:nn { origsign,     date }
      { \tex_par:D \@@_name:n { ##1 } ： \hbox_to_wd:nn { 6 em } { } }
  }
%</(def-u|def-g)>
%    \end{macrocode}
% \end{macro}
%
% \paragraph{研究生}
% \changes{v1.0}{2022/06/30}{调整研究生封面布局。}
% \changes{v1.2}{2023/05/01}{更新2023年新版研究生学位论文封面布局。}
%
% \subparagraph{正面} 包括校名、校徽、标题、信息栏。
%
% \begin{macro}{g/cover-front/top}
% 研究生封面顶部信息实例。
% 因为我们设置了全局的 |linespread=1.625|，此处单倍行距对应的倍数为 $1.3/1.2$。
%    \begin{macrocode}
%<*def-g>
\@@_declare_element:nn { g / cover-front / top }
  {
    content     =
      \skip_vertical:n { -9 bp } \skip_horizontal:n { -.5 cm }
      \vbox:n { \@@_g_cover_top: },
    format      = \normalfont \@@_zihao:nn { 1.083 } { -5 },
    bottom-skip = 20 pt,
    align       = l
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/cover-front/emblem-img}
% 研究生封面校徽图片实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-front / emblem-img }
  {
    content     = \@@_emblem:N \c_@@_emblemwd_dim,
    bottom-skip = .47 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/cover-front/name-img}
% 研究生封面校名图片实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-front / name-img }
  {
    content     = \@@_name:N \c_@@_namewd_dim,
    bottom-skip = 2.25 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/cover-front/type}
% 研究生封面标题实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-front / type }
  {
    content     = \@@_info:n { type } \@@_name:n { type },
    format      =
      \@@_fontsize:nn { 28 bp } { 28 bp } \@@_stzhongs: \bfseries
      \@@_set_ccglue:n { .5 em },
    bottom-skip = 20 pt plus 1 fill
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/cover-front/info}
% 研究封面信息栏实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-front / info }
  {
    content     = \@@_g_cover_info:,
    bottom-skip = 20 pt plus 1 fill
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/cover-front/date}
% 研究封面日期实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-front / date }
  {
    content     = \g_@@_info_submitdate_tl,
    bottom-skip = 2.2 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_g_cover_top:}
% \changes{v1.2}{2023/05/03}{根据学号长度确定研究生封面顶部的下划线长度。}
% 研究生封面顶部信息栏。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_g_cover_top:
  {
    \dim_set:Nn \l_@@_tmpa_dim { 4 em }
    \@@_get_width:NV \l_@@_tmpb_dim \g_@@_info_id_tl
    \clist_map_inline:nn { code, clc, secretlv, udc, id }
      {
        \@@_cover_entry:NNNNn \c_@@_name_colon_tl \l_@@_tmpa_dim
          \l_@@_tmpb_dim \tex_relax:D { ##1 }
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_g_cover_info:NNNNN}
% 研究生封面中部信息栏。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_g_cover_info:NNNNN #1#2#3#4#5
  {
    \bool_if:NTF \g_@@_opt_academic_bool
      { \clist_set:Nn #1 { author, major,  field, supvfull } }
      { \clist_set:Nn #1 { author, majorc, field, supvfull } }
    \@@_cover_entry_title:NNNN #2 #3 #4 #5
    \clist_map_inline:Nn #1
      { \@@_cover_entry:NNNNn #2 #3 #4 #5 { ##1 } }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_g_cover_info:}
%    \begin{macrocode}
\cs_new:Npn \@@_g_cover_info:
  {
    \tl_set:Nn \l_@@_tmpa_tl { \skip_horizontal:n { .7 cm } }
    \@@_g_cover_info:NNNNN \l_@@_tmp_clist \l_@@_tmpa_tl
      \c_@@_clabelwd_dim \c_@@_crulewd_dim \c_@@_fmt_coverlabel_tl
  }
%    \end{macrocode}
% \end{macro}
%
% \subparagraph{背面}
%
% \begin{macro}{g/cover-back/info}
% 研究生封面背面信息实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-back / info }
  {
    content     = \@@_g_cover_back:,
    bottom-skip = 8.1 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/cover-back/sign}
% 研究生封面背面信息实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-back / sign }
  {
    content = \@@_g_cover_sign:,
    align   = l
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cover_back_g:NNN,\@@_cover_back_g:}
% 研究生封面背面信息。
% \begin{arguments}
%   \item 名称盒子宽度，|dim| 型变量
%   \item 内容盒子宽度，|dim| 型变量
%   \item 标签格式
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_g_cover_back:NNN #1#2#3
  {
    \@@_cover_entry:NNNNn \c_empty_tl #1 #2 #3 { chairman }
    \tex_par:D
    \@@_box_spread_name:NNn #1 #3 { reviewer }
    \parbox [ t ] {#2}
      {
        \@@_box_multiline:NNn \g_@@_info_reviewer_clist #2 { 5 }
        \dim_gset_eq:NN \l_@@_tmpa_dim \tex_prevdepth:D
      }
    \tex_par:D
    \dim_set_eq:NN \tex_prevdepth:D \l_@@_tmpa_dim
    \@@_box_spread_name:NNn #1 #3 { defend date }
    \@@_box_center:Nn #2 { \@@_info:n { defend date } }
  }
\cs_new:Npn \@@_g_cover_back:
  {
    \@@_g_cover_back:NNN \c_@@_clabelwdi_dim
      \c_@@_crulewdi_dim \c_@@_fmt_coverlabel_tl
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cover_sign_g:NNN,\@@_cover_sign_g:}
% 研究生封面背面信息。
% \begin{arguments}
%   \item 名称盒子宽度，|dim| 型变量
%   \item 标签格式
%   \item 分隔符
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_g_cover_sign:NNN #1#2#3
  {
    \@@_box_spread_name:NNn #1 #2 { sign a } #3 \tex_par:D
    \@@_box_spread_name:NNn #1 #2 { sign b } #3
  }
\cs_new:Npn \@@_g_cover_sign:
  {
    \@@_g_cover_sign:NNN \c_@@_clabelwdii_dim
      \c_@@_fmt_coverlabel_tl \c_@@_name_colon_tl
  }
%    \end{macrocode}
% \end{macro}
%
% \subparagraph{英文封面} 包括标题、顶部、中部、校徽、底部。
% \changes{v1.3}{2023/08/21}{修复英文标题超长引发的页面元素混乱。}
%
% \begin{macro}{g/cover-en/title}
% 研究生英文封面标题实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-en / title }
  {
    content     = \g_@@_info_title_en_tl,
    format      = \bf \sffamily \zihao { 2 },
    bottom-skip = 1 cm plus 1 fil minus .5 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/cover-en/top}
% 研究生英文封面顶部信息实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-en / top }
  {
    content      =
      { by }
      \skip_vertical:N \c_zero_skip
      \textbf { \sffamily \g_@@_info_author_en_tl }
      \skip_vertical:n { .5 cm minus .5 cm }
      { Supervised~ by }
      \skip_vertical:N \c_zero_skip
      \textsf { \g_@@_info_supv_en_tl
        \tex_par:D \g_@@_info_supvii_en_tl },
    format      = \zihao { 4 },
    bottom-skip = 1 cm plus 1 fil minus .5 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/cover-en/middle}
% 研究生英文封面中部信息实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-en / middle }
  {
    content     =
      \c_@@_text_cover_en_tl \@@_vskip:
      \group_begin: \scshape \g_@@_info_degree_en_tl \group_end:
      \@@_vskip: { in } \@@_vskip: \g_@@_info_major_en_tl,
    bottom-skip = .5 cm plus 1 fil
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/cover-en/emblem-img}
% 研究生英文封面校徽图片实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-en / emblem-img }
  {
    content     = \@@_emblem:N \c_@@_emblemwdii_dim,
    bottom-skip = 1 cm minus .5 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/cover-en/bottom}
% 研究生英文封面底部信息实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / cover-en / bottom }
  {
    content =
      \g_@@_info_dept_en_tl \skip_vertical:N \c_zero_skip
      \c_@@_name_nju_en_tl  \skip_vertical:n { 1 cm }
      \g_@@_info_submitdate_en_tl
  }
%    \end{macrocode}
% \end{macro}
%
% \subparagraph{国家图书馆封面} 包括顶部、题名、标题、中部、底部、日期。
%
% \begin{macro}{cover-nl/top}
% 国家图书馆封面顶部信息实例。
%    \begin{macrocode}
\@@_declare_element:nn { cover-nl / top }
  {
    content     = \@@_cover_top_nl:,
    bottom-skip = 2 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{cover-nl/name}
% 国家图书馆封面标题名称实例。
%    \begin{macrocode}
\@@_declare_element:nn { cover-nl / name }
  {
    content     =
      \dim_set:Nn \l_@@_tmpa_dim { 6 em }
      \@@_box_spread_name:Nn \l_@@_tmpa_dim { titleb },
    format      = \zihao { -0 },
    bottom-skip = 0 pt plus 1 fil
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{cover-nl/title}
% 国家图书馆封面标题实例。
%    \begin{macrocode}
\@@_declare_element:nn { cover-nl / title }
  {
    content     = \@@_cover_title_nl:,
    format      = \zihao { 1 },
    bottom-skip = 0 pt plus 1 fil
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{cover-nl/middle}
% 国家图书馆封面中部信息实例。
%    \begin{macrocode}
\@@_declare_element:nn { cover-nl / middle }
  {
    content     = \@@_cover_info_nl:,
    format      = \zihao { 4 },
    bottom-skip = 0 pt plus 1.2 fil
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{cover-nl/bottom}
% 国家图书馆封面底部信息实例。
%    \begin{macrocode}
\@@_declare_element:nn { cover-nl / bottom }
  {
    content     = \@@_cover_bottom_nl:,
    bottom-skip = 1 cm,
    align       = r
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{cover-nl/date}
% 国家图书馆封面底部日期实例。
%    \begin{macrocode}
\@@_declare_element:nn { cover-nl / date }
  {
    content = \g_@@_info_bottomdate_tl,
    format  = \kaishu \zihao { 3 }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cover_top_nl:}
% 国家图书馆封面顶部信息。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_cover_top_nl:
  {
    \dim_set:Nn               \l_@@_tmpa_dim { 38.6 pt  }
    \dim_set:Nn               \l_@@_tmpb_dim { 109  pt  }
    \@@_box_spread_name:Nn \l_@@_tmpa_dim { clc      } \@@_hskip:
    \@@_box_ulined_info:Nn \l_@@_tmpb_dim { clc      } \tex_hfill:D
    \@@_box_spread_name:Nn \l_@@_tmpa_dim { secretlv } \@@_hskip:
    \@@_box_ulined_info:Nn \l_@@_tmpb_dim { secretlv } \tex_par:D
    \@@_box_spread_name:Nn \l_@@_tmpa_dim { udc      } \@@_hskip:
    \@@_box_ulined_info:Nn \l_@@_tmpb_dim { udc      } \tex_hfill:D
    \@@_null:
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cover_title_nl:}
% 国家图书馆封面标题。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_cover_title_nl:
  {
    \parbox [ b ] { 15 em } { \@@_uline_title: } \tex_par:D
    \skip_vertical:n { - 0.5 cm }
    { \zihao { 4 } \c_@@_name_subtitle_tl }
    \skip_vertical:N \c_zero_skip
    \dim_set:Nn \l_@@_tmpa_dim { 4.5 em }
    \@@_box_ulined_info:Nn \l_@@_tmpa_dim { author }
    \skip_vertical:n { - 0.5 cm }
    { \zihao { 4 } { ( } \c_@@_name_author_tl { ) } }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cover_info_nl:}
% \changes{v0.17}{2022/04/09}{优化国家图书馆封面导师联系方式的输出格式。}
% \changes{v0.19}{2022/05/23}{补充国家图书馆封面的学位授予单位和日期。}
% 国家图书馆封面信息栏。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_cover_info_nl:
  {
    \tl_set:Ne \l_@@_tmpa_tl
      {
        \clist_use:Nn \g_@@_info_supv_clist   { ~ }
        \clist_use:Nn \g_@@_info_supvii_clist { ~ }
        \@@_hskip: \g_@@_info_supvcont_tl
      }
    \skip_set:Nn \l_@@_tmp_skip { .5 em plus 1 fill }
    \@@_uline_list:NNn \l_@@_tmpa_tl \l_@@_tmp_skip
      { \c_@@_name_supvinfo_tl }
%    \end{macrocode}
% 临时替换显示的名称字样。
%    \begin{macrocode}
    \group_begin:
      \tl_set_eq:NN \c_@@_name_major_tl \c_@@_name_majorb_tl
      \@@_uline_bientry:Nn \l_@@_tmpa_dim { degree   }
      \@@_uline_bientry:Nn \l_@@_tmpa_dim { major    }
      \tex_par:D
    \group_end:
    \@@_uline_bientry:Nn \l_@@_tmpa_dim { submitdate }
    \@@_uline_bientry:Nn \l_@@_tmpa_dim { defenddate }
    \tex_par:D
    \@@_uline_entry:Nn   \l_@@_tmpa_dim { confer     }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_cover_bottom_nl:}
% \changes{v0.19}{2022/05/20}{将国家图书馆封面的评审委员会人数分离为单独参数。}
% \changes{v0.20}{2022/05/27}{自动识别评审委员会人数。}
% 国家图书馆封面底部信息。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_cover_bottom_nl:
  {
    \dim_set:Nn \l_@@_tmpa_dim { 9 em }
    \@@_name:n { chairman } \@@_name:n { colon } \@@_hskip:
    \@@_box_ulined_info:Nn \l_@@_tmpa_dim { chairman } \tex_par:D
    \@@_name:n { reviewer } \@@_name:n { colon } \@@_hskip:
    \@@_box_multiline:NNn \g_@@_info_reviewer_clist \l_@@_tmpa_dim { 4 }
  }
%    \end{macrocode}
% \end{macro}
%
% \subparagraph{原创性声明}
%
% \begin{macro}{g/decl/orig/title}
% 研究生原创性声明标题实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / decl / orig / title }
  {
    content     = \c_@@_name_origdecl_tl,
    format      = \c_@@_fmt_chapter_tl,
    bottom-skip = \c_@@_chapterafter_dim
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/decl/orig/text}
% 研究生原创性声明文本实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / decl / orig / text }
  {
    content     = \c_@@_text_origdecl_tl,
    align       = n,
    bottom-skip = 0 pt plus 1 fil
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/decl/orig/sign}
% 研究生原创性声明签名区实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / decl / orig / sign }
  {
    content  = \@@_decl_sign:,
    align    = r
  }
%    \end{macrocode}
% \end{macro}
%
% \subparagraph{出版授权书}
%
% \begin{macro}{g/decl/auth/title}
% 研究生出版授权书标题实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / decl / auth / title }
  {
    content     = \c_@@_name_authdecl_tl,
    format      = \c_@@_fmt_chapter_tl,
    bottom-skip = \c_@@_chapterafter_dim
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/decl/auth/text}
% 研究生出版授权书文本实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / decl / auth / text }
  {
    content     = \c_@@_text_authdecl_tl,
    align       = n,
    bottom-skip = 2 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/decl/auth/sign}
% 研究生出版授权书签名区实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / decl / auth / sign }
  {
    content     = \@@_g_decl_auth_sign:,
    align       = r,
    bottom-skip = 0 pt plus 1 fill
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/decl/auth/info}
% 研究生出版授权书信息表格实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / decl / auth / info }
  {
    content     = \@@_g_decl_auth_info:,
    format      = \zihao { 5 } ,
    align       = l,
    bottom-skip = 2 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{g/decl/auth/date}
% 研究生出版授权书保密信息实例。
%    \begin{macrocode}
\@@_declare_element:nn { g / decl / auth / date }
  {
    content     = \@@_g_decl_auth_secretlv:,
    format      = \zihao { 5 } ,
    align       = l
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_degree_checkbox:nn}
% \changes{v1.3}{2023/06/04}{修复研究生出版授权书的打勾机制。}
% 信息栏的学位复选框。打勾符号对应 |U+2713|。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_degree_checkbox:nn #1#2
  {
    \bool_lazy_and:nnTF
      { #1 \g_@@_opt_academic_bool }
      { \int_compare_p:n { \g_@@_info_type_int = #2 } }
      {
        \makebox [ 0   pt ] [l] { \ensuremath { \mdwhtsquare } }
        \hspace  { 0.1 em }       \ensuremath { \checkmark   }
      }
      { \ensuremath { \mdwhtsquare } }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_g_decl_auth_info:}
% 信息栏内容。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_g_decl_auth_info:
  {
    \begin{tblr}
      {
        hlines, vlines, hspan=minimal,
        cells      = { font = \normalsize },
        colspec    = { c X[c] c X[c] c X[c] },
        cell{1}{2} = {c=5}{m}, cell{3}{2} = {c=5}{m},
        cell{4}{2} = {c=5}{m}, cell{5}{2} = {c=5}{m}
      }
      \c_@@_name_titlec_tl  & \g_@@_info_title_tl \\
      \c_@@_name_ida_tl     & \g_@@_info_id_tl    &
      \c_@@_name_depta_tl   & \g_@@_info_dept_tl  &
      \c_@@_name_year_tl    &
        \tl_range:Nnn \g_@@_info_submitdate_tl {1} {4} \\
      \c_@@_name_degreea_tl &
        {
          \@@_degree_checkbox:nn {   } { 2 } 学术学位硕士 \qquad
          \@@_degree_checkbox:nn { ! } { 2 } 专业学位硕士 \\
          \@@_degree_checkbox:nn {   } { 3 } 学术学位博士 \qquad
          \@@_degree_checkbox:nn { ! } { 3 } 专业学位博士
        } \\
      \c_@@_name_email_tl   & \g_@@_info_email_tl \\
      \c_@@_name_supvb_tl   &
        \clist_item:Nn \g_@@_info_supv_clist { 1 }
        \bool_if:NT \g_@@_opt_supvii_bool
          { \@@_quad: \clist_item:Nn \g_@@_info_supvii_clist { 1 } } \\
    \end{tblr}
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_g_decl_auth_sign:}
% 签名区内容。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_g_decl_auth_sign:
  {
    \c_@@_name_authsign_tl \tex_par:D
    \c_@@_name_blankdatea_tl
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_g_decl_auth_secretlv:}
% 保密信息内容。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_g_decl_auth_secretlv:
  {
    \c_@@_name_secretstatus_tl \tex_par:D
    \ensuremath { \mdwhtsquare } \c_@@_name_secretfree_tl \tex_par:D
    \ensuremath { \mdwhtsquare } \c_@@_name_secretdate_tl
  }
%</def-g>
%    \end{macrocode}
% \end{macro}
%
% \paragraph{博士后}
%
% \begin{macro}{p/cover/name-img}
% 博士后封面校名图片实例。
%    \begin{macrocode}
%<*def-p>
\@@_declare_element:nn { p / cover / name-img }
  {
    content     = \@@_name:N \c_@@_namewd_dim,
    bottom-skip = 40 pt
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{p/cover/report}
% 博士后封面报告字样实例。
%    \begin{macrocode}
\@@_declare_element:nn { p / cover / report }
  {
    content     = \c_@@_name_report_tl,
    format      = \zihao { 0 } \sffamily,
    bottom-skip = 40 pt plus 1.5 fil
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{p/cover/title}
% 博士后封面报告标题实例。
%    \begin{macrocode}
\@@_declare_element:nn { p / cover / title }
  {
    content     =
      \c_@@_name_title_tl
      \c_@@_name_colon_tl
      \g_@@_info_title_tl,
    format      = \zihao { 4 },
    bottom-skip = 80 pt
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{p/cover/info}
% 博士后封面信息栏实例。
%    \begin{macrocode}
\@@_declare_element:nn { p / cover / info }
  {
    content     =
      \@@_p_cover_info:NN
        \c_@@_clabelwd_dim
        \c_@@_fmt_coverlabel_tl,
    format      = \zihao { -4 },
    bottom-skip = 0 pt
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_p_cover_info:NN}
% 博士后封面信息栏。
% \begin{arguments}
%   \item 名称盒子宽度，|dim| 型变量
%   \item 标签格式
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_p_cover_info:NN #1#2
  {
    \clist_set:Nn \l_@@_tmp_clist
      { author, supvfull, dept, id, major, submitdate }
%    \end{macrocode}
% 设置信息栏右侧宽度。读取各字段，并将最宽者的宽度赋给
% \cs{l_@@_tmpb_dim}。
%    \begin{macrocode}
    \@@_get_max_width:NN \l_@@_tmpb_dim \l_@@_tmp_clist
%    \end{macrocode}
% 用循环输出各字段。
%    \begin{macrocode}
    \clist_map_inline:Nn \l_@@_tmp_clist
      {
        \@@_box_spread_name:NNn #1 #2 { ##1 }
        \c_@@_name_colon_tl
        \@@_box_center:Nn \l_@@_tmpb_dim { \@@_info:n { ##1 } }
        \tex_par:D
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \subparagraph{原创性声明和出版授权书}
%
% \begin{macro}{p/decl/orig/title}
% 原创性声明标题实例。^^A 这个实例与研究生的完全一样
%    \begin{macrocode}
\@@_declare_element:nn { p / decl / orig / title }
  {
    content     = \c_@@_name_origdecl_tl,
    format      = \c_@@_fmt_chapter_tl,
    bottom-skip = \c_@@_chapterafter_dim
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{p/decl/orig/text}
% 原创性声明文本实例。
%    \begin{macrocode}
\@@_declare_element:nn { p / decl / orig / text }
  {
    content     = \c_@@_text_origdecl_tl,
    align       = n,
    bottom-skip = 2 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{p/decl/orig/sign}
% 原创性声明签名区实例。
%    \begin{macrocode}
\@@_declare_element:nn { p / decl / orig / sign }
  {
    content     = \@@_p_decl_sign:nn { origsign } { date },
    bottom-skip = 0 pt plus 1 fill
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{p/decl/auth/title}
% 出版授权书标题实例。^^A 这个实例与研究生的完全一样
%    \begin{macrocode}
\@@_declare_element:nn { p / decl / auth / title }
  {
    content     = \c_@@_name_authdecl_tl,
    format      = \c_@@_fmt_chapter_tl,
    bottom-skip = \c_@@_chapterafter_dim
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{p/decl/auth/text}
% 出版授权书文本实例。
%    \begin{macrocode}
\@@_declare_element:nn { p / decl / auth / text }
  {
    content     = \c_@@_text_authdecl_tl,
    align       = n,
    bottom-skip = 2 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{p/decl/auth/sign}
% 出版授权书签名区实例。
%    \begin{macrocode}
\@@_declare_element:nn { p / decl / auth / sign }
  {
    content     =
      \@@_p_decl_sign:nn { authsign   } { date }
      \@@_p_decl_sign:nn { authsigna } { date },
    bottom-skip = 0 pt plus 1 fill
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_p_decl_sign:nn}
% 原创性声明签名区内容。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_p_decl_sign:nn #1#2
  {
    \@@_name:n {#1} \c_@@_name_colon_tl \tex_hfill:D
    \@@_name:n {#2} \c_@@_name_colon_tl
    \skip_horizontal:n { 160 pt } \@@_null: \@@_vskip:
  }
%</def-p>
%    \end{macrocode}
% \end{macro}
%
%
% \subsubsection{绘制封面}
% \changes{v0.13}{2021/12/10}{使用 \LaTeX3 语法重构本科生封面。}
% \changes{v0.13}{2021/12/11}{使用 \LaTeX3 语法重构研究生封面。}
% \changes{v0.13}{2021/12/12}{使用 \LaTeX3 语法重构国家图书馆封面。}
% \changes{v0.15}{2022/01/25}{将封面页面封装为对象。}
%
% 定义封面页面的具体配置参数。
%
% \begin{macro}{cover-u}
% 默认本科生封面实例。
%    \begin{macrocode}
%<*def-u>
\@@_declare_page:nn { cover-u }
  {
    element     = { emblem-img, name-img, title, info },
    prefix      = u / cover /,
    top-skip    = -.3 cm,
    bottom-skip = 0 pt plus 1 fill
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{origdecl-u}
% 默认诚信承诺书实例。
%    \begin{macrocode}
\@@_declare_page:nn { origdecl-u }
  {
    element     = { emblem, title, text, sign },
    prefix      = u / decl / orig /,
    bottom-skip = 0 pt plus 1 fil
  }
%</def-u>
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{cover-g-front}
% 默认研究生普通封面正面实例。
%    \begin{macrocode}
%<*def-g>
\@@_declare_page:nn { cover-g-front }
  {
    element  = { top, emblem-img, name-img, type, info, date },
    prefix   = g / cover-front /,
    format   = \zihao { 3 } \kaishu,
    top-skip = 0 pt
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{cover-g-back}
% 默认研究生普通封面背面实例。
%    \begin{macrocode}
\@@_declare_page:nn { cover-g-back }
  {
    element  = { info, sign },
    prefix   = g / cover-back /,
    format   = \zihao { 3 } \kaishu,
    top-skip = 5.3 cm
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{cover-g-en}
% 默认研究生英文封面实例。
%    \begin{macrocode}
\@@_declare_page:nn { cover-g-en }
  {
    element  = { title, top, middle, emblem-img, bottom },
    prefix   = g / cover-en /,
    format   = \linespread { 1.3 },
    top-skip = 0 pt plus 1.2 fil
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{cover-nl}
% 默认国家图书馆封面实例。
%    \begin{macrocode}
\@@_declare_page:nn { cover-nl }
  {
    element = { top, name, title, middle, bottom, date },
    prefix  = cover-nl /,
    format  = \kaishu
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{origdecl-g}
% 默认原创性声明实例。
%    \begin{macrocode}
\@@_declare_page:nn { origdecl-g }
  {
    element     = { title, text, sign },
    prefix      = g / decl / orig /,
    top-skip    = \c_@@_chapterbefore_dim,
    bottom-skip = 0 pt plus 1 fil,
    bm-text     = \c_@@_name_origdecl_tl,
    bm-name     = origdecl
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{authdecl-g}
% 默认出版授权书实例。
%    \begin{macrocode}
\@@_declare_page:nn { authdecl-g }
  {
    element     = { title, text, sign, info, date },
    prefix      = g / decl / auth /,
    top-skip    = \c_@@_chapterbefore_dim,
    bottom-skip = 0.5 cm plus 1.5 fill,
    bm-text     = \c_@@_name_authdecl_tl,
    bm-name     = authdecl,
    bookmark    = toc
  }
%</def-g>
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{cover-p}
% 默认博士后封面实例。
%    \begin{macrocode}
%<*def-p>
\@@_declare_page:nn { cover-p }
  {
    element     = { name-img, report, title, info },
    prefix      = p / cover /,
    format      = \bfseries,
    top-skip    = 100 pt
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{authdecl-p}
% 默认出版授权书实例。
%    \begin{macrocode}
\@@_declare_page:nn { authdecl-p }
  {
    element     =
      {
        orig/title, orig/text, orig/sign,
        auth/title, auth/text, auth/sign
      },
    prefix      = p / decl /,
    bm-text     = 声明页,
    bm-name     = decl,
    top-skip    = \c_@@_chapterbefore_dim,
    bottom-skip = 0 pt
  }
%</def-p>
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_make_cover:}
% \changes{v1.3}{2023/05/24}{修复非研究生类型时调用 \opt{nl-cover} 选项的错误。}
% 调用实例生成封面。
%    \begin{macrocode}
%<*(def-u|def-g|def-p)>
\cs_new_protected:Npn \@@_make_cover:
  {
%<def-u>    \UseInstance { nju } { cover-u }
%<def-p>    \UseInstance { nju } { cover-p }
%    \end{macrocode}
% 如果在研究生模板中选择了 \opt{nlcover}，就生成用于申请学位的国家图书馆封面，
% 反之生成普通封面。
%    \begin{macrocode}
%<*def-g>
\bool_if:NTF \g_@@_opt_nlcover_bool
  { \UseInstance { nju } { cover-nl } }
  {
    \UseInstance { nju } { cover-g-front }
    \UseInstance { nju } { cover-g-back  }
    \UseInstance { nju } { cover-g-en    }
  }
%</def-g>
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_make_decl_i:}
% \changes{v0.13}{2021/12/15}{加入本科生的诚信承诺书。}
% \changes{v0.19}{2022/05/22}{跟进新版本科生诚信承诺书样式。}
% 位于封面后的承诺书页面。
% 生成本科生的诚信承诺书或研究生的学位论文原创性声明。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_make_decl_i:
  {
    \cleardoublepage
%<def-u>    \UseInstance { nju } { origdecl-u }
%<def-g>    \UseInstance { nju } { origdecl-g }
%<def-p>    \UseInstance { nju } { authdecl-p }
    \cleardoublepage
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_make_decl_ii:}
% \changes{v0.17}{2022/04/04}{加入研究生的学位论文出版授权书。}
% 位于封底的承诺书页面。生成研究生的学位论文出版授权书。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_make_decl_ii:
  {
%<*def-g>
    \AtEndEnvironment { document }
      {
        \cleardoublepage
        \UseInstance { nju } { authdecl-g }
        \cleardoublepage
      }
%</def-g>
  }
%</(def-u|def-g|def-p)>
%    \end{macrocode}
% \end{macro}
%
%
% \subsubsection{用户接口}
%
% \begin{macro}{\@@_new_img_cmd:nn}
% 用于定义插入图片命令的辅助函数。
%    \begin{macrocode}
%<*class>
\cs_new_protected:Npn \@@_new_img_cmd:nn #1#2
  {
    \exp_args:Nc \NewDocumentCommand { nju #1 } { o m m }
      { \includegraphics [ width = ##2, height = ##3 ] {#2} }
  }
%    \end{macrocode}
% \end{macro}
%
% \changes{v1.0}{2022/08/01}{外置图片接口更名为 \opt{image} 类。}
%    \begin{macrocode}
\keys_define:nn { nju / image }
  {
%    \end{macrocode}
% \begin{macro}{image/nju-emblem,\njuemblem}
% \changes{v0.14}{2021/12/23}{提供选择外置校徽图片的接口。}
% 校徽图片路径。
%    \begin{macrocode}
    nju-emblem .code:n = { \@@_new_img_cmd:nn { emblem } {#1} },
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{image/nju-name,\njuname}
% \changes{v0.14}{2021/12/23}{提供选择外置校名图片的接口。}
% 校名图片路径。
%    \begin{macrocode}
    nju-name   .code:n = { \@@_new_img_cmd:nn { name   } {#1} }
  }
%    \end{macrocode}
% \end{macro}
%
% \changes{v0.16}{2022/02/22}{不再默认载入 \pkg{njuvisual}。}
% 检查 \tn{njuemblem} 和 \tn{njuname} 命令是否有定义。
%    \begin{macrocode}
\ctex_at_end_preamble:n
  {
%    \end{macrocode}
% 如果校名、校徽图片其中之一的路径未被定义，
% 则全盘使用 \pkg{njuvisual} 提供的绘制命令。
%    \begin{macrocode}
    \bool_lazy_and:nnF
      { \cs_if_exist_p:N \njuemblem }
      { \cs_if_exist_p:N \njuname   }
      {
        \cs_undefine:N \njuemblem
        \cs_undefine:N \njuname
        \msg_warning:nn { njuthesis } { missing-image }
        \RequirePackage { njuvisual }
      }
    \bool_if:NT \g_@@_opt_anon_bool
      {
        \RenewDocumentCommand \njuemblem { o m m } { }
        \RenewDocumentCommand \njuname   { o m m } { }
      }
  }
%    \end{macrocode}
%
% \begin{macro}{\maketitle}
% \changes{v0.12}{2021/12/01}{仅会生成国家图书馆封面或者普通封面之一。}
% \changes{v0.13}{2021/12/12}{重新绘制封面。}
% \changes{v0.13}{2021/12/15}{草稿模式下不绘制封面。}
% 重定义 \tn{maketitle} 以生成封面。
% 在草稿模式下，封面绘制将被禁用，有助于提升编译速度。
%    \begin{macrocode}
\RenewDocumentCommand \maketitle { }
  {
    \bool_if:NF \g_@@_opt_draft_bool
      {
        \pagenumbering { gobble }
        \@@_make_cover:
      }
%    \end{macrocode}
% 如果在选择了 \opt{decl-page}，就生成本科生的诚信承诺书，
% 或研究生的原创性声明和出版授权书。
%    \begin{macrocode}
    \bool_if:NF \g_@@_opt_draft_bool
      {
        \bool_if:NT \g_@@_opt_decl_bool
          {
            \@@_make_decl_i:
            \@@_make_decl_ii:
          }
      }
%    \end{macrocode}
% 在标题页后使用大写罗马字母页码，恢复正常字体设置。
%    \begin{macrocode}
    \cleardoublepage
    \exp_args:NV \pagestyle \c_@@_fmt_pagestyle_tl
    \pagenumbering { Roman }
  }
%</class>
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{摘要页}
%
% \subsubsection{绘制部件}
% \changes{v0.16}{2022/03/02}{将摘要部件分离到 \file{.def} 文件。}
% \changes{v0.16}{2022/03/02}{使用 \pkg{xtemplate} 重构摘要。}
%
% \begin{macro}{abstract/title}
% 中文摘要标题实例。
%    \begin{macrocode}
%<*(def-u|def-g|def-p)>
\@@_declare_element:nn { abstract / title }
  {
%<def-u|def-g>    content     = \@@_abs_title:N \c_@@_name_abstracttitle_tl,
%<def-p>    content     = \g_@@_info_title_tl,
%<def-u|def-g>    format      = \bfseries \kaishu \zihao { -2 },
%<def-p>    format      = \bfseries,
    bottom-skip = 20 pt
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{abstract/en/title}
% 英文摘要标题实例。
%    \begin{macrocode}
\@@_declare_element:nn { abstract / en / title }
  {
%<def-u|def-g>    content     = \@@_abs_title:N \c_@@_name_abstracttitle_en_tl,
%<def-p>    content     = \g_@@_info_title_en_tl,
%<def-u|def-g>    format      = \bfseries \kaishu \zihao { -2 },
%<def-p>    format      = \bfseries,
    bottom-skip = 20 pt
  }
%</(def-u|def-g|def-p)>
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{abstract/info}
% 中文摘要信息栏实例。
%    \begin{macrocode}
%<*(def-u|def-g)>
\@@_declare_element:nn { abstract / info }
  {
%<def-u>    content     = \@@_abs_info_u:,
%<def-g>    content     = \@@_abs_info_g:,
%<def-u>    format      = \zihao { -4 } \kaishu,
%<def-g>    format      = \zihao {  4 } \kaishu,
%<def-u>    bottom-skip = 15 pt,
%<def-g>    bottom-skip = 30 pt,
    align       = l
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{abstract/en/info}
% 英文摘要信息栏实例。
%    \begin{macrocode}
\@@_declare_element:nn { abstract / en / info }
  {
%<def-u>    content     = \@@_abs_info_en_u:,
%<def-g>    content     = \@@_abs_info_en_g:,
%<def-u>    format      = \zihao { -4 },
%<def-g>    format      = \zihao {  4 },
%<def-u>    bottom-skip = 15 pt,
%<def-g>    bottom-skip = 30 pt,
    align       = l
  }
%</(def-u|def-g)>
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{abstract/mark}
% 英文摘要标签实例。
%    \begin{macrocode}
%<*(def-g|def-p)>
\@@_declare_element:nn { abstract / mark }
  {
    content     = \c_@@_name_abstractb_tl,
    format      = \sffamily \zihao { -3 },
    bottom-skip = 15 pt
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{abstract/en/mark}
% 英文摘要标签实例。
%    \begin{macrocode}
\@@_declare_element:nn { abstract / en / mark }
  {
    content     = \c_@@_name_abstractb_en_tl,
    format      = \sffamily \zihao { -3 },
    bottom-skip = 15 pt
  }
%</(def-g|def-p)>
%    \end{macrocode}
% \end{macro}
%
% \paragraph{本科生}
% \changes{v0.13}{2021/12/12}{使用 \LaTeX3 语法重构本科生摘要。}
% \changes{v1.0}{2022/06/16}{统一本科生摘要页的标签格式。}
%
% \begin{macro}{\@@_abs_info_u:,\@@_abs_info_en_u:}
% 封装好的本科生摘要信息栏。
%    \begin{macrocode}
%<*def-u>
\cs_new_protected:Npn \@@_abs_info_u:
  { \@@_abs_info_u:nn {     } { \c_@@_name_colon_tl    } }
\cs_new_protected:Npn \@@_abs_info_en_u:
  { \@@_abs_info_u:nn { _en } { \c_@@_name_colon_en_tl } }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_abs_info_u:nn}
% 绘制本科生摘要信息栏。
% \begin{arguments}
%   \item 语言，空置为中文，|_en| 为英文
%   \item 分隔符
% \end{arguments}
% 本科生摘要页面不含下划线，因而不用确定文本宽度，绘制命令较为简单。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_abs_info_u:nn #1#2
  {
%    \end{macrocode}
% 由于作者姓名使用的字样发生了变动，这里进行替换以便嵌入循环。
%    \begin{macrocode}
    \tl_set_eq:NN \c_@@_name_author_tl \c_@@_name_authora_tl
%    \end{macrocode}
% 使用循环输出院系、专业、作者、导师信息。
%    \begin{macrocode}
    \clist_map_inline:nn { title, dept, major, author, supvfull }
      {
        \@@_name:nn { abslabel #1 } { ##1 #1 } #2
        \@@_info:n { ##1 #1 } \\
      }
    \@@_name:nn { abslabel #1 } { abstract #1 } #2
  }
%</def-u>
%    \end{macrocode}
% \end{macro}
%
% \paragraph{研究生}
% \changes{v0.13}{2021/12/12}{使用 \LaTeX3 语法重构研究生摘要。}
%
% \begin{macro}{\@@_abs_info_g:,\@@_abs_info_en_g:}
% 封装好的研究生摘要信息栏。
%    \begin{macrocode}
%<*def-g>
\cs_new_protected:Npn \@@_abs_info_g:
  { \@@_abs_info_g:N    \c_@@_name_colon_tl    }
\cs_new_protected:Npn \@@_abs_info_en_g:
  { \@@_abs_info_en_g:N \c_@@_name_colon_en_tl }
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@@_abs_info_g:N}
% 绘制研究生中文摘要信息栏。
% \begin{arguments}
%   \item 分隔符
% \end{arguments}
% 研究生中文摘要页包括下划线以及若干特殊的对齐方式，实现方式较为繁琐。
% 使用 \cs{@@_full_uline:NV} 确定内容宽度后，调用 \cs{@@_uline:n} 或
% \cs{@@_ulined_center_box:nn} 命令以绘制横穿页面的下划线。前两行为标题。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_abs_info_g:N #1
  {
    \@@_uline_list:NNe \g_@@_info_title_tl \g_@@_abs_title_left_skip
      { \c_@@_name_titlea_tl #1 }
%    \end{macrocode}
% 专业、年级、姓名。
%    \begin{macrocode}
    \@@_get_width_print:Ne \l_@@_tmp_skip
      {
        \dim_set:Nn \l_@@_tmpa_dim { 11 em }
        \dim_set:Nn \l_@@_tmpb_dim { 4  em }
        \@@_box_ulined_info:Nn \l_@@_tmpa_dim { major }
        \c_@@_name_majora_tl
        \@@_box_ulined_info:Nn \l_@@_tmpb_dim { grade }
        \c_@@_name_grade_tl \c_@@_name_authora_tl #1
      }
    \@@_box_ulined_info:Nn \l_@@_tmp_skip { author } \tex_par:D
%    \end{macrocode}
% 导师姓名、职称。
%    \begin{macrocode}
    \@@_get_width_print:Ne \l_@@_tmpa_dim { \c_@@_name_supva_tl #1 }
    \@@_box_ulined_info:Nn \l_@@_tmpa_dim { supvfull }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_abs_info_en_g:N}
% \changes{v1.0}{2022/07/01}{移除研究生英文摘要的下划线。}
% \changes{v1.1}{2022/12/12}{恢复研究生英文摘要的下划线。}
% 绘制研究生英文摘要信息栏。因为到底要不要下划线这回事说不清楚，
% 所以不做选择了全都整上。
% \begin{arguments}
%   \item 分隔符
% \end{arguments}
%    \begin{macrocode}
\cs_new_protected:Npn \@@_abs_info_en_g:N #1
  {
    \bool_if:NTF \g_@@_abs_underline_bool
      {
        \@@_uline_list:NNe \g_@@_info_title_en_tl
          \g_@@_abs_title_left_skip { \c_@@_name_title_en_tl #1 }
        \clist_map_inline:nn { major, author, supvfull }
          {
            \tex_par:D
            \@@_get_width_print:Ne \l_@@_tmpa_dim
              { \@@_name:n { ##1 _en } #1 }
            \@@_box_ulined_info:Nn \l_@@_tmpa_dim { ##1 _en }
          }
      }
      {
        \clist_map_inline:nn { title, major, author, supvfull }
          { \@@_name:n { ##1 _en } #1 \@@_info:n { ##1 _en } \\ }
      }
  }
%</def-g>
%    \end{macrocode}
% \end{macro}
%
% \paragraph{关键词列表}
%
% \begin{macro}{\@@_print_keywords:nn}
% \changes{v0.15}{2022/01/26}{为关键词列表添加悬挂缩进。}
% \changes{v0.20}{2022/05/26}{修复英文关键词列表不整齐的缩进间距。}
% 生成中英文关键词列表。
% \begin{arguments}
%   \item 语言，空置为中文，|_en| 为英文
%   \item 关键词分隔符
% \end{arguments}
%    \begin{macrocode}
%<*class>
\cs_new_protected:Npn \@@_print_keywords:nn #1#2
  {
    \tl_set:Nv \l_@@_tmpa_tl { c_@@_name_keywords #1 _tl }
    \exp_args:NNv \tl_put_left:Nn
      \l_@@_tmpa_tl { c_@@_fmt_abslabel #1 _tl }
    \exp_args:NNv \tl_put_right:Nn
      \l_@@_tmpa_tl { c_@@_name_colon #1 _tl }
    \@@_get_width:NV \l_@@_tmpa_dim \l_@@_tmpa_tl
%    \end{macrocode}
% 关键词列表的悬挂缩进样式由 \tn{list} 环境产生。
%    \begin{macrocode}
    \list { \l_@@_tmpa_tl }
      {
        \labelwidth  \l_@@_tmpa_dim
        \labelsep    \c_zero_dim
        \leftmargin  \c_zero_dim
        \rightmargin \c_zero_dim
        \advance \leftmargin \l_@@_tmpa_dim
%    \end{macrocode}
% 使用粗体作为标签样式。
%    \begin{macrocode}
        \__nju_cs_clear:N \makelabel
      }
    \item \clist_use:cn { g_@@_info_keywords #1 _clist } {#2}
    \endlist
  }
%</class>
%    \end{macrocode}
% \end{macro}
%
%
% \subsubsection{绘制摘要}
% \changes{v0.16}{2022/03/26}{补上研究生摘要页面的小标题。}
%
% \begin{macro}{\@@_make_abstract:,\@@_make_abstract_en:}
% 绘制摘要页面。
%    \begin{macrocode}
%<*(def-u|def-g|def-p)>
\cs_new_protected:Npn \@@_make_abstract:
  {
    \UseInstance { nju } { abstract / title }
%<def-u|def-g>    \UseInstance { nju } { abstract / info  }
%<def-g|def-p>    \UseInstance { nju } { abstract / mark  }
  }
\cs_new_protected:Npn \@@_make_abstract_en:
  {
    \UseInstance { nju } { abstract / en / title }
%<def-u|def-g>    \UseInstance { nju } { abstract / en / info  }
%<def-g|def-p>    \UseInstance { nju } { abstract / en / mark  }
  }
%</(def-u|def-g|def-p)>
%    \end{macrocode}
% \end{macro}
%
%
% \subsubsection{用户接口}
%
% \begin{macro}{\g_@@_abs_title_left_skip}
% 研究生摘要标题左边距。
%    \begin{macrocode}
%<*class>
\skip_new:N \g_@@_abs_title_left_skip
%    \end{macrocode}
% \end{macro}
%
% \changes{v1.0}{2022/08/01}{整合摘要设置项。}
%    \begin{macrocode}
\keys_define:nn { nju / abstract }
  {
%    \end{macrocode}
% \begin{macro}{abstract/toc-entry}
% \changes{v0.15}{2022/02/04}{可选择摘要是否出现在目录中。}
% 是否将摘要添加到目录。
%    \begin{macrocode}
    toc-entry         .bool_gset:N = \g_@@_abs_showentry_bool,
    toc-entry           .initial:n = true,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{abstract/underline}
% \changes{v1.2}{2023/04/23}{新增研究生英文摘要页下划线选项。}
% 是否为研究生英文摘要条目内容添加下划线。
%    \begin{macrocode}
    underline         .bool_gset:N = \g_@@_abs_underline_bool,
    underline           .initial:n = true,
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{abstract/title-style}
% \changes{v0.16}{2022/03/26}{可选择研究生摘要标题样式。}
% 选择摘要样式，默认为 \opt{strict}。
%    \begin{macrocode}
    title-style          .choice:,
    title-style / strict   .code:n =
      {
        \bool_gset_true:N  \g_@@_abs_title_strict_bool
        \skip_gset:Nn \g_@@_abs_title_left_skip { .5 em }
      },
    title-style / centered .code:n =
      {
        \bool_gset_true:N \g_@@_abs_title_strict_bool
        \skip_gset:Nn \g_@@_abs_title_left_skip { .5 em plus 1 fill }
      },
    title-style / natural  .code:n =
      {
        \bool_gset_false:N \g_@@_abs_title_strict_bool
        \skip_gset:Nn \g_@@_abs_title_left_skip { .5 em plus 1 fill }
      },
    title-style         .initial:n = strict
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{environment}{abstract}
% \changes{v0.13}{2021/12/12}{重新绘制摘要。}
% 中文摘要环境。
%    \begin{macrocode}
\NewDocumentEnvironment { abstract } { +b }
  {
    \cleardoublepage
    \thispagestyle { plain }
    \@@_abs_bookmark:Vn \c_@@_name_abstracta_tl { abstract }
    \tl_gremove_all:Nn \g_@@_info_title_tl { \\ }
    \@@_make_abstract:
    \group_begin: \kaishu \zihao { -4 } #1
  }
  { \@@_print_keywords:nn { } { ； } \group_end: }
%    \end{macrocode}
% \end{environment}
%
% \begin{environment}{abstract*}
% 英文摘要环境。\pkg{xparse} 目前不支持合并带有星号的环境，因此需要单独定义。
%    \begin{macrocode}
\NewDocumentEnvironment { abstract* } { +b }
  {
    \cleardoublepage
    \thispagestyle { plain }
    \@@_abs_bookmark:Vn \c_@@_name_abstracta_en_tl { abstract-en }
%    \end{macrocode}
% \changes{v1.3}{2023/08/21}{修复英文标题手动换行与摘要页的冲突。}
% 生成封面后清除标题中的换行控制符，便于在摘要中输出。
%    \begin{macrocode}
    \tl_gremove_all:Nn \g_@@_info_title_en_tl { \\ }
    \@@_make_abstract_en:
    \group_begin: \zihao { -4 } #1
  }
  { \@@_print_keywords:nn { _en } { ;~ } \group_end: }
%    \end{macrocode}
% \end{environment}
%
%
% \subsection{前言致谢}
%
% \begin{environment}{preface}
% \begin{environment}{acknowledgement}
% 单独制作的前言致谢页。
%    \begin{macrocode}
\NewDocumentEnvironment { preface         } { +b }
  { \@@_chapter:V \c_@@_name_preface_tl #1 }
  { \cleardoublepage }
\NewDocumentEnvironment { acknowledgement } { +b }
  {
    \bool_if:NTF \g_@@_opt_anon_bool
      { \@@_bookmark_toc:V \c_@@_name_acknowledgementa_tl   }
      { \@@_chapter:V      \c_@@_name_acknowledgement_tl #1 }
  }
  { \cleardoublepage }
%    \end{macrocode}
% \end{environment}
% \end{environment}
%
%
% \subsection{成果列表}
%
% \begin{macro}{\njupaperlist}
% \changes{v0.10}{2021/09/29}{新增了成果列表页面。}
% \changes{v0.14}{2021/12/20}{成果列表中可突出指定作者姓名及年份。}
% \changes{v1.2}{2023/04/07}{修复成果列表与章末参考文献表的冲突。}
% 成果列表。
%    \begin{macrocode}
\NewDocumentCommand \njupaperlist
  { O { \c_@@_name_paperlist_tl } m }
  {
    \group_begin:
%    \end{macrocode}
% 修改姓名的显示方式，使被注解的姓名可被加粗下划线表示。
%    \begin{macrocode}
      \RenewDocumentCommand \mkbibnamegiven  { m }
        { \ifitemannotation { thesisauthor }
            { \njuline { \bf ##1 } } { ##1 } }
      \RenewDocumentCommand \mkbibnamefamily { m }
        { \ifitemannotation { thesisauthor }
            { \njuline { \bf ##1 } } { ##1 } }
%    \end{macrocode}
% 修改年份的显示方式，默认进行加粗。
%    \begin{macrocode}
      \RenewDocumentCommand \mkbibdateshort { m m m }
        { \textbf { \thefield { ##1 } } }
%    \end{macrocode}
% \changes{v1.1}{2023/04/07}{修复章末参考文献表与成果列表的冲突问题。}
% 相较于直接使用 \env{refsection} 环境，\tn{newrefsection} 命令可以
% 自动结束上一个 \env{refsection}，与章末参考文献表格式兼容更好。
%    \begin{macrocode}
      \newrefsection
      \nocite {#2}
      \printbibliography [ heading = subbibliography, title = #1 ]
      \endrefsection
    \group_end:
  }
%    \end{macrocode}
% \end{macro}
%
%
% \subsection{符号表}
%
% \begin{macro}{\@@_notation_label:n}
% 左对齐的标签格式，用于符号表。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_notation_label:n #1 { #1 \tex_hfil:D }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_make_notation:nn}
% 生成符号表。由于符号表只有符号和说明两列，相比于 \env{longtable} 环境，
% \env{description} 环境的语法更为简洁直观，且说明文字可以换行，因而此处使用
% \LaTeXe 的列表环境进行封装，定义和语法参见 \file{source2e.pdf} 中的
% File I \quad ltlists.dtx 一章。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_make_notation:nn #1#2
  {
    \dim_set:Nn \l_@@_tmpa_dim { \textwidth - #1 - #2 }
    \list { }
      {
%    \end{macrocode}
% \tn{list} 环境使用宽度固定的盒子制作标签，通过指定这个盒子的宽度
% \tn{labelwidth} 即可确定左侧标签区域的宽度。
%    \begin{macrocode}
        \labelwidth #2
        \labelsep   \c_zero_dim
        \itemsep    \c_zero_dim
        \parsep     \c_zero_dim
%    \end{macrocode}
% 右侧说明文字区域的宽度无法直接指定，而是靠计算左右边距 \tn{leftmargin} 和
% \tn{rightmargin} 得到的。
%    \begin{macrocode}
        \leftmargin .5\l_@@_tmpa_dim
        \rightmargin \leftmargin
        \advance \leftmargin #2
        \cs_set_eq:NN \makelabel \@@_notation_label:n
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{environment}{notation}
% \changes{v0.15}{2022/01/17}{提供符号表环境。}
% 符号表环境。
% \begin{arguments}
%   \item 说明区域宽度，初始值为 10 em。说明宽度的调整更为常见，所以放在前面。
%   \item 符号区域宽度，初始值为 5 em
% \end{arguments}
%    \begin{macrocode}
\NewDocumentEnvironment { notation } { O { 10 em } O { 5 em } }
  {
    \@@_chapter:V \c_@@_name_notation_tl
    \@@_make_notation:nn {#1} {#2}
  }
  { \endlist \cleardoublepage }
%    \end{macrocode}
% \end{environment}
%
% \begin{environment}{notation*}
% 带有星号的符号表不会插入目录。
%    \begin{macrocode}
\NewDocumentEnvironment { notation* } { O { 10 em } O { 5 em } }
  {
    \chapter * { \c_@@_name_notation_tl }
    \@@_make_notation:nn {#1} {#2}
  }
  { \endlist \cleardoublepage }
%</class>
%    \end{macrocode}
% \end{environment}
%
%
% \subsection{配置常量}
% \label{subsec:constant-config}
% \changes{v0.16}{2022/02/23}{将名称常量分离到 \file{.def} 文件。}
% \changes{v0.18}{2022/04/20}{使用 |const| 类型统一定义常量。}
%
% 本节内容用于生成常量的默认定义，分为本科生和研究生模板两种。
%
% \subsubsection{名称}
% \label{subsubsec:constant-name}
%
% \changes{v0.19}{2022/05/22}{更正研究生普通封面专业字样。}
% \changes{v0.19}{2022/05/22}{更正国家图书馆封面学位论文字样。}
% \changes{v1.0}{2022/06/19}{合并名称常量的定义位置。}
% \changes{v1.0}{2022/06/19}{更名：supv_ii -> supvii，supv_ttl -> supvtitle。}
%
% 由于同一名称在不同位置具有不同变体，本模板使用字母后缀名进行了区分，
% 并在易混淆处添加了注释。
%
% 通用默认名称。注意空格是忽略掉的。
%    \begin{macrocode}
%<*(def-u|def-g|def-p)>
\clist_map_inline:nn
  {
    { acknowledgement   } { 致 \qquad{} 谢                     },
    { acknowledgement a } { 致谢（盲审阶段，暂时隐去）         },
%<def-g>    { auth decl         } { 学位论文出版授权书                 },
%<def-p>    { auth decl         } { 研究报告使用授权书                 },
%<def-p>    { author            } { 作者                               },
%    \end{macrocode}
% 用于摘要的作者名称字样
%    \begin{macrocode}
%<def-u>    { author          a } { 本科生姓名                         },
%<def-g>    { author          a } { \g_@@_info_type_tl 生姓名        },
%<def-g>    { auth sign         } { 作者签名：\njuline{\hspace{6em}}   },
%<def-p>    { auth sign         } { 本人签名                           },
%<def-p>    { auth sign       a } { 导师签名                           },
%<def-g>    { chairman          } { 答辩委员会主席                     },
%<def-g>    { clc               } { 分类号                             },
%<def-g>    { code              } { 学校代码                           },
%<def-g>    { confer            } { 学位授予单位和日期                 },
    { date              } { 日期                               },
%<def-g>    { defend date       } { 论文答辩日期                       },
%<def-g>    { degree            } { 申请学位级别                       },
%    \end{macrocode}
% 用于出版授权书的学位名称字样
%    \begin{macrocode}
%<def-g>    { degree          a } { 论文级别                           },
%<def-p>    { dept              } { 系别                               },
%    \end{macrocode}
% 用于出版授权书的院系名称字样
%    \begin{macrocode}
%<def-g>    { dept            a } { 所在院系                           },
%<def-g>    { email             } { 作者 Email                         },
%<def-g>    { field             } { 研究方向                           },
%<def-u>    { grade             } { 年级                               },
%<def-g>    { grade             } { 级                                 },
%<def-u|def-g>    { id                } { 学号                               },
%<def-p>    { id                } { 工号                               },
%    \end{macrocode}
% 用于出版授权书的学号名称字样
%    \begin{macrocode}
%<def-g>    { id              a } { 研究生学号                         },
    { listoffigures     } { 插图目录                           },
    { listoftables      } { 表格目录                           },
%<def-p>    { major             } { 学科专业                           },
%    \end{macrocode}
% 用于摘要的专业名称字样
%    \begin{macrocode}
%<def-g>    { major           a } { 专业                               },
%    \end{macrocode}
% 用于国家图书馆封面的专业名称字样
%    \begin{macrocode}
%<def-g>    { major           b } { 专业名称                           },
%    \end{macrocode}
% 用于专业学位封面的专业名称字样
%    \begin{macrocode}
%<def-g>    { major           c } { 专业学位类别(领域)                 },
    { notation          } { 符号表                             },
%<def-u>    { orig decl         }
%<def-u>      { 南京大学本科毕业论文（设计） \\ 诚信承诺书             },
%<def-g>    { orig decl         } { 南京大学学位论文原创性声明         },
%<def-p>    { orig decl         } { 研究报告原创性声明                 },
%<def-u>    { orig sign         } { 作者签名                           },
%<def-g>    { orig sign         } { 研究生签名                         },
%<def-p>    { orig sign         } { 研究报告作者签名                   },
    { paper list        } { 发表文章目录                       },
    { pdf creator       } { LaTeX~ with~ njuthesis~ class      },
    { preface           } { 前 \qquad{} 言                     },
%<def-p>    { report            } { 博士后研究工作报告                 },
%<def-g>    { reviewer          } { 评阅人                             },
%<def-g>    { secret lv         } { 密级                               },
%<def-g>    { secret status     } { 论文涉密情况：                     },
%<def-g>    { secret free       } { 不保密                             },
%<def-g>    { secret date       }
%<def-g>      { 保密，保密期（ \c_@@_name_blankdatea_tl 至
%<def-g>                       \c_@@_name_blankdatea_tl ）           },
%<def-g>    { sign              } { （签字）                           },
%<def-g>    { sign            a } { 研究生签名                         },
%<def-g>    { sign            b } { 导师签名                           },
%<def-g>    { stzhongs file     } { STZHONGS.TTF                       },
%<def-u>    { submit date       } { 提交日期                           },
%<def-g>    { submit date       } { 论文提交日期                       },
%<def-p>    { submit date       } { 完成日期                           },
%<def-g>    { subtitle          } { （题名和副题名）                   },
%<def-u>    { supv              } { 指导教师                           },
%<def-g>    { supv              } { 导师                               },
%<def-p>    { supv full         } { 合作导师                           },
%    \end{macrocode}
% 用于摘要的导师名称字样
%    \begin{macrocode}
%<def-g>    { supv            a } { 指导教师（姓名、职称）             },
%    \end{macrocode}
% 用于出版授权书的导师名称字样
%    \begin{macrocode}
%<def-g>    { supv            b } { 导师姓名                           },
%<def-g>    { supv info         }
%<def-g>      { 指导教师姓名、职务、职称、学位、单位名称及地址         },
    { supv ii           } { 第二导师                           },
    { supv title        } { 职称                               },
    { tableofcontents   } { 目 \qquad{} 录                     },
%<def-p>    { title             } { 报告题目                           },
%    \end{macrocode}
% 用于摘要的标题名称字样
%    \begin{macrocode}
%<def-g>    { title           a } { 毕业论文题目                       },
%    \end{macrocode}
% 用于国家图书馆封面的标题名称字样
%    \begin{macrocode}
%<def-g>    { title           b } { 学位论文                           },
%    \end{macrocode}
% 用于出版授权书的标题名称字样
%    \begin{macrocode}
%<def-g>    { title           c } { 论文题名                           },
%<def-g>    { udc               } { U D C                              },
%<def-g>    { year              } { 学位年度                           }
  }
  { \@@_define_name:nn #1 }
%    \end{macrocode}
%
% 定义同时使用到中英文名称的常量。
%    \begin{macrocode}
\clist_map_inline:nn
  {
    { abstract      } { 摘要            } { ABSTRACT              },
%    \end{macrocode}
% 用于书签的摘要名称字样
%    \begin{macrocode}
    { abstract    a } { 中文摘要        } { ABSTRACT              },
%    \end{macrocode}
% 用于小标题的摘要名称字样
%    \begin{macrocode}
    { abstract    b } { 摘\qquad{}要    } { ABSTRACT              },
%<def-u|def-g>    { abstracttitle }
%<def-u>      { \c_@@_name_nju_tl 本科生毕业论文（设计、作品）中文摘要  }
%<def-u>      { \c_@@_name_nju_tl 本科生毕业论文（设计、作品）英文摘要  },
%<def-g>      { \c_@@_name_nju_tl 研究生毕业论文中文摘要首页用纸        }
%<def-g>      { \c_@@_name_nju_tl 研究生毕业论文英文摘要首页用纸        },
    { appendix      } { 附录            } { appendix              },
%<def-u>    { author        } { 学生姓名        } { UNDERGRADUATE         },
%<def-g>    { author        } { 作者姓名        } { POSTGRADUATE          },
    { blankdate     } { \qquad{}年 \quad{}月 \quad{}日   } {      },
    { blankdate   a } { \njuline{\qquad\qquad} 年
            \njuline{\qquad} 月 \njuline{\qquad} 日      } {      },
    { colon         } { ：              } { : \c_space_tl         },
%<def-u|def-g>    { dept          } { 院系            } { DEPARTMENT            },
    { figure        } { 图              } { figure                },
    { keywords      } { 关键词          } { KEYWORDS              },
    { lang          } { 中文            } { 英文                  },
%<def-u>    { major         } { 专业            } { SPECIALIZATION        },
%<def-g>    { major         } { 专业名称        } { SPECIALIZATION        },
    { nju           } { 南京大学        } { Nanjing~ University   },
    { suffix        } {                 } { _en                   },
%<def-u>    { supv full     } { 指导教师（姓名、职称）   } { MENTOR       },
%<def-g>    { supv full     } { 导师姓名        } { MENTOR                },
    { table         } { 表              } { table                 },
%<def-u>    { title         } { 题目            } { THESIS                },
%<def-g>    { title         } { 论文题目        } { THESIS                },
%<def-u>    { type          } { 本科毕业论文                        } { u }
%<def-g>    { type          } {     学位论文                        } { g }
  }
  { \@@_define_name:nnn #1 }
%    \end{macrocode}
%
% \subsubsection{文本}
% \label{subsubsec:constant-text}
%
% \begin{variable}{\c_@@_text_origdecl_tl}
% 本科生的学位论文诚信承诺书，或研究生的学位论文原创性声明。
%    \begin{macrocode}
\tl_const:Nn \c_@@_text_origdecl_tl
  {
%<*def-u>
    本人郑重承诺：所呈交的毕业论文（设计）（题目： \g_@@_info_title_tl ）
    是在指导教师的指导下严格按照学校和院系有关规定由本人独立完成的。
    本毕业论文（设计）中引用他人观点及参考资源的内容均已标注引用，
    如出现侵犯他人知识产权的行为，由本人承担相应法律责任。
    本人承诺不存在抄袭、伪造、篡改、代写、买卖毕业论文（设计）等违纪行为。
%</def-u>
%<*def-g>
    本人郑重声明，所提交的学位论文是本人在导师指导下独立进行科学研究工作所
    取得的成果。除本论文中已经注明引用的内容外，本论文不包含其他个人或集体
    已经发表或撰写过的研究成果，也不包含为获得南京大学或其他教育机构的学位
    证书而使用过的材料。对本文的研究做出重要贡献的个人和集体，均已在论文的
    致谢部分明确标明。本人郑重申明愿承担本声明的法律责任。
%</def-g>
%<*def-p>
    本人郑重声明：所呈交的研究报告，是本人独立进行研究工作所取得的成果。除
    文中已经注明引用的内容外，本报告不含任何其他个人或集体已经发表或撰写过
    的作品成果。对本报告的研究做出重要贡献的个人和集体，均已在报告中以明确
    方式标明。本人完全意识到本声明的法律结果由本人承担。
%</def-p>
  }
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\c_@@_text_authdecl_tl}
% 研究生的学位论文出版授权书。
%    \begin{macrocode}
%<*(def-g|def-p)>
\tl_const:Nn \c_@@_text_authdecl_tl
  {
%<*def-g>
    本人完全同意《中国优秀博硕士学位论文全文数据库出版章程》（以下简称“章
    程”），愿意将本人的学位论文提交“中国学术期刊（光盘版）电子杂志社”在《
    中国博士学位论文全文数据库》、《中国优秀硕士学位论文全文数据库》中全文
    发表。《中国博士学位论文全文数据库》、《中国优秀硕士学位论文全文数据库
    》可以以电子、网络及其他数字媒体形式公开出版，并同意编入《中国知识资源
    总库》，在《中国博硕士学位论文评价数据库》中使用和在互联网上传播，同意
    按“章程”规定享受相关权益。
%</def-g>
%<*def-p>
    本研究报告作者完全了解南京大学有关保留和使用该报告的规定，即：博士后在
    职期间的知识产权单位属南京大学。学校有权保留并向国家有关部门或机构送交
    研究报告的复印件和电子版，允许研究报告被查阅和借阅；学校可以公布研究报
    告的全部或部分内容，可以允许采用影印、缩印或其它复制手段保存、汇编研究
    报告。保密的研究报告在解密后适用于本授权书。
%</def-p>
  }
%</(def-g|def-p)>
%    \end{macrocode}
% \end{variable}
%
% \begin{variable}{\c_@@_text_cover_en_tl}
% 研究生的英文封面字样。
%    \begin{macrocode}
%<*def-g>
\tl_const:Nn \c_@@_text_cover_en_tl
  {
    A~ dissertation~ submitted~ to \\
    the~ graduate~ school~ of~ \c_@@_name_nju_en_tl \\
    in~ partial~ fulfilment~ of~ the~ requirements~ for~ the~ degree~ of
  }
%</def-g>
%    \end{macrocode}
% \end{variable}
%
% \subsubsection{长度}
% \label{subsubsec:constant-length}
%
% \changes{v0.17}{2022/04/09}{将长度值分离到 \file{.def} 文件。}
% \changes{v1.0}{2022/06/11}{可以单独指定下划线的宽度和偏移。}
% 默认固定长度值。此处名称的空格仅用来提升可读性，在生成变量名时会被删去。
%    \begin{macrocode}
\clist_map_inline:nn
  {
%    \end{macrocode}
% 封面信息栏标签的宽度。
%    \begin{macrocode}
%<def-u>    { c label wd     } { 68   pt },
%<def-g>    { c label wd     } { 2.97 cm },
%<def-g>    { c label wd i   } { 3.90 cm },
%<def-g>    { c label wd ii  } { 2.62 cm },
%<def-p>    { c label wd     } { 50   pt },
%    \end{macrocode}
% 封面信息栏横线的宽度。
%    \begin{macrocode}
%<def-u>    { c rule  wd     } { 8    cm },
%<def-g>    { c rule  wd     } { 6.7  cm },
%<def-g>    { c rule  wd i   } { 6.2  cm },
%<def-g>    { c type  wd     } { 239  pt },
%    \end{macrocode}
% 校徽图片的宽度。
%    \begin{macrocode}
%<def-u>    { emblem  wd     } { 68   pt },
%<def-g>    { emblem  wd     } { 40   pt },
%<def-u>    { emblem  wd i   } { 68   pt },
%<def-g>    { emblem  wd ii  } { 61   pt },
%    \end{macrocode}
% 校名图片的宽度。
%    \begin{macrocode}
%<def-u>    { name    wd     } { 300  pt },
%<def-g>    { name    wd     } { 111  pt },
%<def-p>    { name    wd     } { 220  pt },
%    \end{macrocode}
% 下划线高度（厚度）。下划线绘制命令是通用的，因此没有作文件区分。
%    \begin{macrocode}
    { rule    ht i   } { .4   pt },
    { rule    ht ii  } { .8   pt },
%    \end{macrocode}
% 下划线深度（偏移量）。
%    \begin{macrocode}
    { rule    dp i   } { -.7  ex },
    { rule    dp ii  } { -.9  ex },
    { rule    dp iii } { -1.2 ex },
%    \end{macrocode}
% 小幅空格。
%    \begin{macrocode}
%<def-u>    { h sep          } { 0    pt },
%<def-g|def-p>    { h sep          } { 5    pt },
    { v sep          } { 1    ex },
%    \end{macrocode}
% 章节标题前后间距。
%    \begin{macrocode}
    { chapter before } { 10   pt },
    { chapter  after } { 60   pt },
%    \end{macrocode}
% 脚注编号宽度。
%    \begin{macrocode}
    { fn hang        } { 13.5 pt }
  }
  { \@@_define_dim:nn #1 }
%    \end{macrocode}
%
% \subsubsection{样式}
% \label{subsubsec:constant-format}
%
% \changes{v0.17}{2022/04/09}{将样式定义分离到 \file{.def} 文件。}
% \changes{v0.20}{2022/05/28}{修复前一版本中错误的目录条目样式。}
% 默认样式。
%    \begin{macrocode}
\clist_map_inline:nn
  {
%<def-u>    { pagestyle     } { plain                             },
%<def-g|def-p>    { pagestyle     } { headings                          },
    { abslabel      } { \bfseries                         },
    { abslabel_en   } {                                   },
%<def-u>    { cover title   } { \bfseries                         },
%<def-g>    { cover title   } {                                   },
%<def-u>    { cover label   } { \kaishu                           },
%<def-g>    { cover label   } { \bfseries                         },
%<def-p>    { cover label   } {                                   },
%    \end{macrocode}
% 调用 \pkg{njuvisual} 时的校徽颜色。
%    \begin{macrocode}
    { emblem color  } { black                             },
    { name   color  } { black                             },
%    \end{macrocode}
% 各级标题样式。
%    \begin{macrocode}
    { section       } { \bigger \normalfont \sffamily     },
    { chapter       } { \c_@@_fmt_section_tl \centering },
    { subsection    } { \c_@@_fmt_section_tl            },
    { subsubsection } { \c_@@_fmt_section_tl            },
    { paragraph     } { \c_@@_fmt_section_tl            },
    { subparagraph  } { \c_@@_fmt_section_tl            },
%    \end{macrocode}
% 目录中的章标题样式。
%    \begin{macrocode}
    { chapterintoc  } { \c_@@_fmt_section_tl            },
%    \end{macrocode}
% “目录”二字的样式。
%    \begin{macrocode}
%    \end{macrocode}
% \changes{v1.3}{2023/07/08}{整合表格环境字体设置。}
% \env{tabular} 环境内的字体样式。
%    \begin{macrocode}
    { tabular       } { \zihao { 5 }                      },
    { toc title     } { \centering \zihao { 3 } \bfseries },
    { header        } { \small \kaishu                    },
    { footer        } { \small \rmfamily                  }
  }
  { \@@_define_fmt:nn #1 }
%</(def-u|def-g|def-p)>
%    \end{macrocode}
%
%
% \subsection{手册文档类 \cls{njuthesis-doc}}
% \changes{v1.3}{2023/05/12}{将手册样式设置拆分为单独的 \cls{njuthesis-doc} 文档类。}
%
%    \begin{macrocode}
%<*doc-cls>
%<@@=njudoc>
%    \end{macrocode}
%
%
%    \begin{macrocode}
\RequirePackage { l3keys2e }
%    \end{macrocode}
%
% \subsubsection{选项}
%
%    \begin{macrocode}
\keys_define:nn { njudoc }
  {
    codehigh .bool_gset:N = \g_@@_codehigh_bool,
    codehigh   .initial:n = false
  }
\ProcessKeysOptions { njudoc }
%    \end{macrocode}
%
% \subsubsection{载入宏包}
%
%    \begin{macrocode}
\PassOptionsToPackage { fontset = fandol } { ctex       }
\PassOptionsToPackage { firstpage = true } { background }
%    \end{macrocode}
%
% 载入基础文档类。
%    \begin{macrocode}
\LoadClass { ctxdoc }
%    \end{macrocode}
%
% 载入宏包。
%    \begin{macrocode}
\RequirePackage
  {
    background,
    codehigh,
    listings,
    njuvisual,
    tabularray,
    unicode-math,
    zhlineskip
  }
\sys_if_engine_xetex:TF
  {
    \RequirePackage { xeCJKfntef }
    \renewcommand\emph[1]{\CJKunderdot[textformat=\itshape]{#1}}
  }
  {
    \RequirePackage { lua-ul }
    \NewDocumentCommand \CJKunderline { o m } { \underLine {#1} }
    \NewDocumentCommand \CJKunderdot  { o m } { \underLine {#1} }
    \NewDocumentCommand \CJKsout      { o m }
      { \textcolor { black!50 } {#1} }
  }
%    \end{macrocode}
%
% 处理丢失的展开类型实现向后兼容。在2023年11月，\cls{l3doc} 进行了一系列展开类型修改。
% 详见 \href{https://github.com/CTeX-org/ctex-kit/pull/678}{\texttt{CTeX-org/ctex-kit\#678}}
% 以及 \href{https://github.com/CTeX-org/ctex-kit/pull/700}{\texttt{CTeX-org/ctex-kit\#700}}.
%    \begin{macrocode}
\cs_generate_variant:Nn \__codedoc_get_hyper_target:nN { x }
\cs_generate_variant:Nn \tl_replace_all:Nnn  { No }
%    \end{macrocode}
%
% \subsubsection{杂项}
%
% 封面背景图案。
%    \begin{macrocode}
\backgroundsetup{
  contents={\njuemblem[white!85!gray]{22cm}{!}},
  scale=1, angle=0, hshift=-4cm
}
%    \end{macrocode}
%
% 文档命令。
%    \begin{macrocode}
\definecolor{tpblue}{HTML}{495A80}
\newcommand\tpbutton[1]{\textcolor{tpblue}{\bfseries #1}}
\newcommand\tikzlogo{Ti\emph{k}Z}
\newcommand\OPT[1]{\textcolor{njuyellow}{\bfseries#1}}
%    \end{macrocode}
%
% \pkg{hyperref} 设置。
%    \begin{macrocode}
\hypersetup{
  pdftitle  = {
    The~ njuthesis~ class~ -~
    LaTeX~ thesis~ template~ for~ Nanjing~ University},
  citecolor = njublue,
  linkcolor = njuviolet,
  urlcolor  = njumagenta}
%    \end{macrocode}
%
% \pkg{tabularray} 设置。
%    \begin{macrocode}
\UseTblrLibrary{booktabs,siunitx}
\DefTblrTemplate{caption-tag}{default}{表\hspace{0.25em}\thetable}
\SetTblrStyle{caption-tag}{font=\bfseries}
\SetTblrInner{row{1}={font=\bfseries}}
\SetTblrInner[talltblr]{row{1}={font=\bfseries}}
\DefTblrTemplate{caption-sep}{default}{\quad}
%    \end{macrocode}
%
% \pkg{tabularray} 表格标签简写。
%    \begin{macrocode}
\def\TA{\TblrNote{a}}
\def\TB{\TblrNote{b}}
\def\TC{\TblrNote{c}}
\def\TD{\TblrNote{d}}
\def\TE{\TblrNote{e}}
%    \end{macrocode}
%
%
% \TeX{} 相关的名称简写。
%    \begin{macrocode}
\def\TL{\TeX~Live}
\def\MacTeX{Mac\TeX}
\def\biber{\hologo{biber}}
\def\LaTeXe{\hologo{LaTeX2e}}
%    \end{macrocode}
%
% \pkg{zhlineskip} 设置。
%    \begin{macrocode}
\SetTextEnvironmentSinglespace{1.112}
\SetMathEnvironmentSinglespace{1.112}
%    \end{macrocode}
%
% \subsubsection{字体设置}
%
%    \begin{macrocode}
\setmainfont { texgyretermes }
  [
    Extension      = .otf,
    UprightFont    = *-regular,
    BoldFont       = *-bold,
    ItalicFont     = *-italic,
    BoldItalicFont = *-bolditalic
  ]
%    \end{macrocode}
%
% 需要 \pkg{lexend}。
%    \begin{macrocode}
\setsansfont{LexendDeca}
%    \end{macrocode}
%
% Iosevka。
%    \begin{macrocode}
\fontspec_font_if_exist:nT { Iosevka }
  {
    \setmonofont { Iosevka }
      [
        UprightFont = *~Light,
        ItalicFont  = *~Light~Italic,
        BoldFont    = *~Semibold
      ]
  }
%    \end{macrocode}
%
% 思源宋体。
%    \begin{macrocode}
\fontspec_font_if_exist:nT { Source~ Han~ Serif~ SC }
  {
    \setCJKmainfont{  Source~ Han~ Serif~ SC }
      [
        UprightFont = *~SemiBold,
        ItalicFont  = *~Bold,
        BoldFont    = *~Heavy,
        Language    = Chinese~Simplified
      ]
  }
%    \end{macrocode}
%
%    \begin{macrocode}
\setCJKsansfont { FandolHei-Regular }
  [
    Extension = .otf,
    BoldFont  = FandolHei-Bold
  ]
\setCJKmonofont { FandolFang-Regular }
  [ Extension = .otf ]
%    \end{macrocode}
%
% XITS。
%    \begin{macrocode}
\setmathfont{XITSMath-Regular}[
  BoldFont = XITSMath-Bold,
  Extension = .otf]
%    \end{macrocode}
%
% \pkg{listings} 设置。
%    \begin{macrocode}
\lstdefinestyle{style@base}
  {
    basewidth       = 0.5 em,
    gobble          = 3,
    lineskip        = 3 pt,
    frame           = l,
    framerule       = 1 pt,
    framesep        = 0 pt,
    xleftmargin     = 2 em,
    xrightmargin    = 3 em,
    escapeinside    = {(*}{*)},
    breaklines      = true,
    basicstyle      = \small\ttfamily,
    keywordstyle    = \bfseries\color{njuviolet},
    commentstyle    = \itshape\color{white!50!gray},
    stringstyle     = \color{nju-chem-red},
    backgroundcolor = \color{white!95!gray}
  }
\lstdefinestyle{style@shell}
  {
    style      = style@base,
    rulecolor  = \color{njumagenta},
    language   = bash,
    alsoletter = {-},
    emphstyle  = \color{nju-cs-green}
  }
\lstdefinestyle{style@latex}
  {
    style      = style@base,
    rulecolor  = \color{njublue},
    language   = [LaTeX]TeX,
    alsoletter = {*, -, .},
    texcsstyle = *\color{njuviolet},
    emphstyle  = [1]\color{nju-ai-orange},
    emphstyle  = [2]\color{nju-cs-green},
    emphstyle  = [3]\bfseries\color{njuyellow}
  }
%    \end{macrocode}
%
% 代码框环境。
%    \begin{macrocode}
\lstnewenvironment{shellexample}[1][]{%
  \lstset{style=style@shell, #1}}{}
\lstnewenvironment{latexexample}[1][]{%
  \lstset{style=style@latex, #1}}{}
%    \end{macrocode}
%
%
% \subsubsection{标签颜色设置}
%
% 我们对每个 guard 进行特定的颜色标记，
% 而不是 \cls{ctxdoc} 中使用深浅表明嵌套关系。
%
%    \begin{macrocode}
\colorlet    {    at@guard } { njuviolet }
\definecolor { angle@guard } { gray } { 0.7 }
\definecolor {  star@guard } { rgb  } { 0.8 , 0 , 0 }
\definecolor { u@guard } { HTML } { 5463FF }
\definecolor { g@guard } { HTML } { 2B7A0B }
\definecolor { p@guard } { HTML } { FF1818 }
\definecolor { c@guard } { HTML } { FFC300 }
%    \end{macrocode}
%
% \begin{variable}{\c@@_module_color_prop}
% 存储 guard 名称和对应的颜色。
%    \begin{macrocode}
\prop_const_from_keyval:Nn \c@@_module_color_prop
  {
    def-u = u@guard,
    def-g = g@guard,
    def-p = p@guard
  }
%    \end{macrocode}
% \end{variable}
%
% \begin{macro}{\@@_set_module_color:n}
%
%    \begin{macrocode}
\cs_new:Npn \@@_set_module_color:Nn #1#2
  {
    \prop_get:NnNF \c@@_module_color_prop {#2} #1
      { \tl_set:Nn #1 { c@guard } }
    \exp_args:NV \color #1 #2
  }
\cs_new:Npn \@@_set_module_color:n
  { \@@_set_module_color:Nn \l_tmpa_tl }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_module_angle:Nn}
% 生成完整的带颜色的 guard 标签。
%    \begin{macrocode}
\cs_new_protected:Npn \@@_module_angle:Nn #1#2
  {
    \group_begin: \color { angle@guard }    \ttfamily \textlangle \group_end:
    \group_begin: \sffamily #2 \group_end:
    \group_begin: \color { angle@guard } #1 \ttfamily \textrangle \group_end:
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\__ctxdoc_module_angle:n}
% 补丁。
%    \begin{macrocode}
\cs_set:Npn \__ctxdoc_module_angle:n
  { \@@_module_angle:Nn \c_empty_tl }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_colored_module_angle:NN}
%
%    \begin{macrocode}
\cs_new_protected:Npn \@@_colored_module_angle:NN #1#2
  {
    \seq_clear:N #2
    \seq_map_inline:Nn #1
      {
        \seq_gput_right:Nn #2
          { \@@_set_module_color:n {##1} }
      }
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_print_module:n}
%
%    \begin{macrocode}
\cs_new_protected:Npn \@@_print_module:n #1
  {
    \@@_colored_module_angle:NN \l_tmpa_seq \l_tmpb_seq
    \bool_lazy_or:nnTF
      { \str_if_empty_p:n {#1} }
      { \int_compare_p:n { \seq_count:N \l_tmpb_seq = 1 } }
      {
        \str_clear:N \l_tmpa_str
        \str_clear:N \l_tmpb_str
      }
      {
        \str_set:Nn  \l_tmpa_str { ( }
        \str_set:Nn  \l_tmpb_str { ) }
      }
    \@@_module_angle:Nn \l_tmpb_str
      {
        \color { star@guard  } #1
        \color { angle@guard } \l_tmpa_str
        \seq_use:Nn \l_tmpb_seq
          { \color { angle@guard } \orbar }
      }
  }
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\@@_split_pm:n,\@@_split_pm:V}
% 通过竖线分割 guard 标签。
%    \begin{macrocode}
\cs_new:Npn \@@_split_pm:n
  { \seq_set_split:Nnn \l_tmpa_seq { | } }
\cs_generate_variant:Nn \@@_split_pm:n { V }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\@@_split_m:n}
%
%    \begin{macrocode}
\cs_new_protected_nopar:Npn \@@_split_m:n #1
  {
    \tl_set:Nn \l_tmpa_str {#1}
    \clist_map_inline:nn { *, /, (, ) }
      { \str_remove_all:Nn \l_tmpa_str {##1} }
    \@@_split_pm:V \l_tmpa_str
  }
%    \end{macrocode}
% \end{macro}
%
%
%    \begin{macrocode}
\group_begin:
  \char_set_catcode_active:N \>
%    \end{macrocode}
%
% \begin{macro}{\__ctxdoc_module_star:w}
%    \begin{macrocode}
  \cs_gset_protected:Npn \__ctxdoc_module_star:w #1 > #2 \q_stop
    {
      \__ctxdoc_output_module:nn
        { \@@_split_m:n {#1} }
        { \__ctxdoc_module_push:n { \@@_print_module:n { * } } }
      \__ctxdoc_output_line:n {#2}
      \__ctxdoc_star_format:
    }
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\__ctxdoc_module_slash:w}
%    \begin{macrocode}
  \cs_gset_protected:Npn \__ctxdoc_module_slash:w #1 > #2 \q_stop
    {
      \__ctxdoc_output_module:nn
        { \@@_split_m:n {#1} }
        { \__ctxdoc_module_pop:n { \@@_print_module:n { / } } }
      \__ctxdoc_output_line:n {#2}
      \__ctxdoc_slash_format:
    }
%    \end{macrocode}
% \end{macro}
%
%
% \begin{macro}{\__ctxdoc_module_pm:w}
%    \begin{macrocode}
  \cs_gset_protected:Npn \__ctxdoc_module_pm:w #1 > #2 \q_stop
    {
      \tex_noindent:D
      \hbox_overlap_left:n
        {
          \__ctxdoc_output_module:nn
            { \@@_split_pm:n {#1} }
            { \@@_print_module:n { } }
          \skip_horizontal:n { \leftskip + \smallskipamount }
        }
      \group_begin:
        \__ctxdoc_pm_format:
        \__ctxdoc_output_line:n {#2}
      \group_end:
    }
\group_end:
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\grd,\sgrd,\pgrd}
% 在手册中生成带颜色的 guard 标记。
%    \begin{macrocode}
\NewDocumentCommand \grd { m }
  { \__ctxdoc_module_angle:n { \color { njuviolet } #1 } }
\NewDocumentCommand \sgrd { m }
  { \__ctxdoc_module_angle:n { \color { star@guard } * \color{ c@guard } #1 } }
\NewDocumentCommand \pgrd { m }
  { \__ctxdoc_module_angle:n { \color { #1 @guard } def- #1 } }
%    \end{macrocode}
% \end{macro}
%
% \subsubsection{语法高亮}
%
% \begin{macro}{\@@_output_line:}
% \cls{ctxdoc} 将 \file{.dtx} 文件中读取的代码行存储在
% \cs{l__ctxdoc_verbatim_line_tl}，我们使用 \pkg{codehigh} 提供的内部函数
% 将其转化为带有语法高亮的格式并输出。默认读取的代码行尾带有 |^^M|，
% 直接输入高亮函数会导致代码快尾部有额外空行，需要手动删去。
%    \begin{macrocode}
\cs_generate_variant:Nn \tl_remove_once:Nn { NV }
\cs_set_protected_nopar:Npn \@@_output_line:N #1
  {
    \tex_noindent:D
    \__ctxdoc_replace_at_at:N #1
    \tl_remove_once:NV #1 \c__ctxdoc_active_cr_tl
    \__codehigh_parse_code:nN { latex / latex3 } #1
    \tex_par:D
  }
%    \end{macrocode}
% \end{macro}
%
% \begin{macro}{\__ctxdoc_output_line:}
% 在 \XeTeX{} 引擎下，\pkg{codehigh} 调用的 \pkg{l3regex} 模块有严重的性能问题。
% 我们仅仅在需要时启用高亮。
%    \begin{macrocode}
\bool_if:NT \g_@@_codehigh_bool
  {
    \cs_set:Npn \__ctxdoc_output_line:
      { \@@_output_line:N \l__ctxdoc_verbatim_line_tl }
  }
%    \end{macrocode}
% \end{macro}
%
%
%    \begin{macrocode}
%</doc-cls>
%    \end{macrocode}
%
% \end{implementation}
%
